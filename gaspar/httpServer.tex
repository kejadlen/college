% Remember to use the lgrind style

\Head{}
\File{httpServer.cpp}{2004}{11}{18}{21:16}{19839}
\L{\LB{\C{}/*_Microsoft_Visual_C++_6_doe}}
\L{\LB{not_like_maps_with_strings*/\CE{}}}
\L{\LB{\K{\#ifdef}_\V{\_MSC\_VER}}}
\L{\LB{\K{\#pragma}_\V{warning}(_\V{disable:}_\N{4786}_)}}
\L{\LB{\K{\#endif}}}
\L{\LB{}}
\L{\LB{\K{\#include}_\<\V{stdio}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{winsock}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{process}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{io}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{fcntl}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{stdlib}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{windows}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{winbase}.\V{h}\>}}
\L{\LB{}}
\L{\LB{\K{\#include}_\<\V{iostream}\>}}
\L{\LB{\K{\#include}_\<\V{string}\>}}
\L{\LB{\K{\#include}_\<\V{algorithm}\>}}
\L{\LB{\K{\#include}_\<\V{functional}\>}}
\L{\LB{\K{\#include}_\<\V{map}\>}}
\L{\LB{\K{\#include}_\<\V{vector}\>}}
\L{\LB{\K{\#include}_\<\V{ctime}\>}}
\L{\LB{}}
\L{\LB{\K{\#include}_\S{}\3logic.cpp\3\SE{}}}
\L{\LB{}}
\L{\LB{\K{using}_\K{namespace}_\V{std};}}
\L{\LB{}}
\L{\LB{\K{\#define}}\Tab{8}{\V{QLEN}}\Tab{27}{\N{5}}\Tab{32}{\C{}/*_maximum_connection_queue_length}\Tab{72}{*/\CE{}}}
\L{\LB{\K{\#define}}\Tab{8}{\V{STKSIZE}}\Tab{24}{\N{16536}}}
\L{\LB{\K{\#define}}\Tab{8}{\V{BUFSIZE}}\Tab{24}{\N{4096}}}
\L{\LB{\K{\#define}}\Tab{8}{\V{WSVERS}}\Tab{24}{\V{MAKEWORD}(\N{2},_\N{0})}}
\L{\LB{}}
\L{\LB{\C{}/*_Keeps_track_of_data_for}}
\L{\LB{each_connected_socket._*/\CE{}}}
\L{\LB{\K{struct}_\V{httpStats}_\{}}
\L{\LB{}\Tab{8}{\V{SOCKET}_\V{socket};}}
\L{\LB{}\Tab{8}{\V{string}_\V{ipAddress};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{string}_\V{request};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{string}_\V{basedir};}}
\L{\LB{}\Tab{8}{\V{string}_\V{path};}}
\L{\LB{}\Tab{8}{\V{string}_\V{host};}}
\L{\LB{}\Tab{8}{\K{int}_\V{keepAlive};}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\V{string}_\V{serverResponse};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{LARGE\_INTEGER}_\V{startTime};}}
\L{\LB{}\Tab{8}{\V{LARGE\_INTEGER}_\V{stopTime};}}
\L{\LB{\};}}
\L{\LB{}}
\L{\LB{\C{}/*_Used_for_passing_arguments}}
\L{\LB{to_a_new_httpServer_threads._*/\CE{}}}
\L{\LB{\K{struct}_\V{httpServerArgs}_\{}}
\L{\LB{}\Tab{8}{\V{SOCKET}_\V{socket};}}
\L{\LB{}\Tab{8}{\V{string}_\V{ipAddress};}}
\L{\LB{\};}}
\L{\LB{}}
\L{\LB{\V{SOCKET}}\Tab{8}{\V{msock},_\V{ssock};}\Tab{32}{\C{}/*_master_\&_slave_server_sockets}\Tab{72}{*/\CE{}}}
\L{\LB{\V{map}\<\V{string},_\V{string}\>_\V{contentTypes};}\Tab{40}{\C{}//_map_of_all_content-types_the_server_can_recognize\CE{}}}
\L{\LB{}}
\L{\LB{\V{LARGE\_INTEGER}_\V{freq};}}
\L{\LB{\K{double}_\V{totalTime};}}
\L{\LB{\K{double}_\V{totalRequests};}}
\L{\LB{}}
\L{\LB{\K{int}}\Tab{16}{\V{httpServer}(\K{void}_*);}}
\L{\LB{}}
\L{\LB{\K{int}}\Tab{16}{\V{parseRequest}(\V{httpStats}_*);}}
\L{\LB{\K{int}}\Tab{16}{\V{parseRequestLine}(\V{string},_\V{httpStats}_*);}}
\L{\LB{\K{int}}\Tab{16}{\V{runCGI}(\V{httpStats}_*);}}
\L{\LB{\V{string}}\Tab{8}{\V{getCGIInfo}(\V{httpStats}_*);}}
\L{\LB{\V{string}}\Tab{8}{\V{makeCGIName}(\V{httpStats}_*);}}
\L{\LB{\K{int}}\Tab{16}{\V{fileExistsP}(\V{httpStats}_*);}}
\L{\LB{\K{int}}\Tab{16}{\V{sendStatus}(\V{httpStats}_*);}}
\L{\LB{\K{int}}\Tab{16}{\V{sendResponse}(\V{httpStats}_*);}}
\L{\LB{\V{string}}\Tab{8}{\V{fixPath}(\V{string});}}
\L{\LB{}}
\L{\LB{\K{int}}\Tab{16}{\V{sendDirectory}(\V{httpStats}_*);}}
\L{\LB{\V{string}}\Tab{8}{\V{makeDirectoryListing}(\V{httpStats}_*);}}
\L{\LB{\V{string}}\Tab{8}{\V{addLink}(\V{string});}}
\L{\LB{}}
\L{\LB{\K{int}}\Tab{16}{\V{sendFile}(\K{int},_\V{string},_\V{httpStats}_*);}}
\L{\LB{\V{string}}\Tab{8}{\V{pathExtension}(\V{string});}}
\L{\LB{}}
\L{\LB{\V{SOCKET}}\Tab{8}{\V{initSocket}();}}
\L{\LB{\K{int}}\Tab{16}{\V{sendString}(\V{SOCKET},_\V{string});}}
\L{\LB{\K{int}}\Tab{16}{\V{sendString}(\V{SOCKET},_\K{char}_*,_\K{int});}}
\L{\LB{}}
\L{\LB{\K{void}}\Tab{8}{\V{errexit}(\K{const}_\K{char}_*,_.\,.\,.);}}
\L{\LB{}}
\index{main}\Proc{main}\L{\LB{\K{int}_\V{main}(\K{int}_\V{argc},_\K{char}_*\V{argv}[\,])_\{}}
\L{\LB{}\Tab{8}{\V{SOCKET}_\V{msock};}}
\L{\LB{}\Tab{8}{\K{struct}}\Tab{16}{\V{sockaddr\_in}_\V{fsin};}\Tab{40}{\C{}/*_the_address_of_a_client}\Tab{72}{*/\CE{}}}
\L{\LB{}\Tab{8}{\K{int}}\Tab{16}{\V{alen};}\Tab{40}{\C{}/*_length_of_client{'}s_address}\Tab{72}{*/\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{struct}_\V{httpServerArgs}_*\V{args}=_\K{new}_\V{httpServerArgs};}}
\L{\LB{}\Tab{8}{\K{char}_\V{tempIP}[\N{16}];}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Set_up_content-type_map\CE{}}}
\L{\LB{}\Tab{8}{\V{contentTypes}[\S{}\3html\3\SE{}]}\Tab{32}{=_\S{}\3text/html\3\SE{};}}
\L{\LB{}\Tab{8}{\V{contentTypes}[\S{}\3htm\3\SE{}]}\Tab{40}{=_\S{}\3text/html\3\SE{};}}
\L{\LB{}\Tab{8}{\V{contentTypes}[\S{}\3txt\3\SE{}]}\Tab{40}{=_\S{}\3text/plain\3\SE{};}}
\L{\LB{}\Tab{8}{\V{contentTypes}[\S{}\3jpeg\3\SE{}]}\Tab{32}{=_\S{}\3image/jpeg\3\SE{};}}
\L{\LB{}\Tab{8}{\V{contentTypes}[\S{}\3jpg\3\SE{}]}\Tab{40}{=_\S{}\3image/jpeg\3\SE{};}}
\L{\LB{}\Tab{8}{\V{contentTypes}[\S{}\3gif\3\SE{}]}\Tab{40}{=_\S{}\3image/gif\3\SE{};}}
\L{\LB{}\Tab{8}{\V{contentTypes}[\S{}\3pdf\3\SE{}]}\Tab{40}{=_\S{}\3application/pdf\3\SE{};}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\C{}//_Initialize_networking\CE{}}}
\L{\LB{}\Tab{8}{\V{msock}_=_\V{initSocket}();}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{cout}\<\<\S{}\3HTTP_server_started\3\SE{}\<\<\V{endl};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Set_up_statistics\CE{}}}
\L{\LB{}\Tab{8}{\V{QueryPerformanceFrequency}(\&\V{freq});}}
\L{\LB{}\Tab{8}{\V{totalTime}_=_\N{0};}}
\L{\LB{}\Tab{8}{\V{totalRequests}_=_\N{0};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Loop_infinitely_to_receive_all_requests\CE{}}}
\L{\LB{}\Tab{8}{\K{while}_(\N{1})_\{}}
\L{\LB{}\Tab{16}{\V{alen}_=_\K{sizeof}(\V{fsin});}}
\L{\LB{}\Tab{16}{\V{ssock}_=_\V{accept}(\V{msock},_(\K{struct}_\V{sockaddr}_*)\&\V{fsin},_\&\V{alen});}}
\L{\LB{}\Tab{16}{\C{}//cout\<\<\3(\3\<\<totalTime/++totalRequests\<\<\3)\3\<\<endl;\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{args}_=_\K{new}_\V{httpServerArgs};}}
\L{\LB{}\Tab{16}{\V{args}\-\!\>\V{socket}_=_\V{ssock};}}
\L{\LB{}\Tab{16}{\V{sprintf}(\V{tempIP},\S{}\3\%d.\%d.\%d.\%d\3\SE{},\V{fsin}.\V{sin\_addr}.\V{S\_un}.\V{S\_un\_b}.\V{s\_b1},}}
\L{\LB{}\Tab{24}{\V{fsin}.\V{sin\_addr}.\V{S\_un}.\V{S\_un\_b}.\V{s\_b2},}}
\L{\LB{}\Tab{24}{\V{fsin}.\V{sin\_addr}.\V{S\_un}.\V{S\_un\_b}.\V{s\_b3},}}
\L{\LB{}\Tab{24}{\V{fsin}.\V{sin\_addr}.\V{S\_un}.\V{S\_un\_b}.\V{s\_b4});}}
\L{\LB{}\Tab{16}{\V{args}\-\!\>\V{ipAddress}_=_\V{tempIP};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}_(\V{ssock}_==_\V{INVALID\_SOCKET})}}
\L{\LB{}\Tab{24}{\V{fprintf}(\V{stderr},_\S{}\3accept:_error_number\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}\Tab{16}{\C{}//_Spawn_new_thread_with_child_socket\CE{}}}
\L{\LB{}\Tab{16}{\K{else}_\K{if}_(\V{\_beginthread}((\K{void}_(*)(\K{void}_*))\V{httpServer},_\V{STKSIZE},}}
\L{\LB{}\Tab{20}{(\K{void}_*)\V{args})_\<_\N{0})_\{}}
\L{\LB{}\Tab{24}{\V{fprintf}(\V{stderr},_\S{}\3\_beginthread:_\%s\2n\3\SE{},_\V{strerror}(\V{errno}));}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\N{1};}\Tab{24}{\C{}/*_not_reached_*/\CE{}}}
\L{\LB{\}}}
\L{\LB{}}
\index{httpServer}\Proc{httpServer}\L{\LB{\K{int}_\V{httpServer}(\K{void}_*\V{\_args})_\{}}
\L{\LB{}\Tab{8}{\C{}/*}}
\L{\LB{}\Tab{8}{*/\CE{}}}
\L{\LB{}\Tab{8}{\V{httpServerArgs}_*\V{args}_=_(\V{httpServerArgs}_*)_\V{\_args};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{char}_*\V{buffer}_=_\K{new}_\K{char}[\V{BUFSIZE}],_*\V{bufptr}_=_\V{buffer};}}
\L{\LB{}\Tab{8}{\V{httpStats}_*\V{requestStats}_=_\K{new}_\V{httpStats};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{requestStats}\-\!\>\V{socket}_=_\V{args}\-\!\>\V{socket};}}
\L{\LB{}\Tab{8}{\V{requestStats}\-\!\>\V{ipAddress}_=_\V{args}\-\!\>\V{ipAddress};}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\C{}//_Get_the_initial_request_and_place_it_into_buffer\CE{}}}
\L{\LB{}\Tab{8}{\K{int}_\V{n}_=_\V{recv}(\V{requestStats}\-\!\>\V{socket},_\V{bufptr},_\K{sizeof}_\V{buffer},_\N{0});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}/*_HTTP/1.1_assumes_keep-alive,_so_this_keeps}}
\L{\LB{}\Tab{8}{reading_until_the_client_closes_the_connection}}
\L{\LB{}\Tab{8}{or_there_is_a_SOCKET\_ERROR._*/\CE{}}}
\L{\LB{}\Tab{8}{\K{while}(\V{n}_!=_\V{SOCKET\_ERROR}_\&\&_\V{n}_!=_\N{0})_\{}}
\L{\LB{}\Tab{16}{\V{bufptr}_=_\V{bufptr}_+_\V{n};}}
\L{\LB{}\Tab{16}{*\V{bufptr}_=_\S{}{'}\20{'}\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{requestStats}\-\!\>\V{request}_=_\V{buffer};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}/*_The_end_of_the_request_is_found_by_the_reception}}
\L{\LB{}\Tab{16}{of_two_CRLFs_in_a_row._*/\CE{}}}
\L{\LB{}\Tab{16}{\K{if}(\V{requestStats}\-\!\>\V{request}.\V{find}(\S{}\3\2r\2n\2r\2n\3\SE{})_!=_\V{string::npos})_\{}}
\L{\LB{}\Tab{24}{\V{QueryPerformanceCounter}(\&\V{requestStats}\-\!\>\V{startTime});}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\C{}//_Reset_requestStats\CE{}}}
\L{\LB{}\Tab{24}{\V{requestStats}\-\!\>\V{basedir}_=_\S{}\3c:/webfiles\3\SE{};}}
\L{\LB{}\Tab{24}{\V{requestStats}\-\!\>\V{path}_=_\S{}\3\3\SE{};}}
\L{\LB{}\Tab{24}{\V{requestStats}\-\!\>\V{host}_=_\S{}\3\3\SE{};}}
\L{\LB{}\Tab{24}{\V{requestStats}\-\!\>\V{keepAlive}_=_\N{0};}}
\L{\LB{}\Tab{24}{\V{requestStats}\-\!\>\V{serverResponse}_=_\S{}\3\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\C{}//_Parse_the_request\CE{}}}
\L{\LB{}\Tab{24}{\K{if}(\V{parseRequest}(\V{requestStats})_\&\&_!\V{requestStats}\-\!\>\V{serverResponse}.\V{empty}())}}
\L{\LB{}\Tab{32}{\V{requestStats}\-\!\>\V{serverResponse}_=_\S{}\3400_Bad_Request\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\K{if}(\V{requestStats}\-\!\>\V{path}.\V{find}(\S{}\3/cgi\-bin/\3\SE{})_==_\V{string::size\_type}(\N{0}))_\{}}
\L{\LB{}\Tab{32}{\V{requestStats}\-\!\>\V{serverResponse}_=_\S{}\3\3\SE{};}}
\L{\LB{}\Tab{32}{\V{runCGI}(\V{requestStats});}}
\L{\LB{}\Tab{24}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\C{}/*_TODO:}}
\L{\LB{}\Tab{32}{A_mutex_or_something_should_be_used_here.\,.\,.}}
\L{\LB{}\Tab{24}{*/\CE{}}}
\L{\LB{}\Tab{24}{\C{}/*cout\<\<\3\2\3GET_\3\<\<requestStats-\!\>path\<\<\3\2\3_received_from_\3}}
\L{\LB{}\Tab{32}{\<\<requestStats-\!\>ipAddress\<\<\3_(\3;}}
\L{\LB{}\Tab{24}{if(requestStats-\!\>keepAlive)_}}
\L{\LB{}\Tab{32}{cout\<\<\3keep-alive\3;}}
\L{\LB{}\Tab{24}{else}}
\L{\LB{}\Tab{32}{cout\<\<\3close\3;}}
\L{\LB{}\Tab{24}{cout\<\<\3)\3\<\<endl;*/\CE{}}}
\L{\LB{}\Tab{24}{\C{}//cout\<\<requestStats-\!\>request\<\<endl;\CE{}}}
\L{\LB{}\Tab{24}{}}
\L{\LB{}\Tab{24}{\C{}//_Send_a_response_to_the_request\CE{}}}
\L{\LB{}\Tab{24}{\K{if}(\V{sendResponse}(\V{requestStats})_\|\,\|_!\V{requestStats}\-\!\>\V{keepAlive})}}
\L{\LB{}\Tab{32}{\K{return}_\V{closesocket}(\V{requestStats}\-\!\>\V{socket});}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\C{}//_Reset_bufptr_for_new_request\CE{}}}
\L{\LB{}\Tab{24}{\V{bufptr}_=_\V{buffer};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{16}{}}
\L{\LB{}\Tab{16}{\C{}//_Keep_polling_for_more_data_from_the_client\CE{}}}
\L{\LB{}\Tab{16}{\V{n}_=_\V{recv}(\V{requestStats}\-\!\>\V{socket},_\V{bufptr},_\K{sizeof}_\V{buffer},_\N{0});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{n}==\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{16}{\V{fprintf}(\V{stderr},_\S{}\3receiving_error:_\%d\2n\3\SE{},_\V{GetLastError}());}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\C{}/*_The_socket_is_closed_because_this_will}}
\L{\LB{}\Tab{8}{only_be_reached_if_a_shutdown_is_initiated}}
\L{\LB{}\Tab{8}{by_the_client_or_if_there_is_a_SOCKET\_ERROR._*/\CE{}}}
\L{\LB{}\Tab{8}{\K{return}_\V{closesocket}(\V{requestStats}\-\!\>\V{socket});}}
\L{\LB{\}}}
\L{\LB{}}
\index{parseRequest}\Proc{parseRequest}\L{\LB{\K{int}_\V{parseRequest}(\V{httpStats}_*\V{requestStats})_\{}}
\L{\LB{}\Tab{8}{\C{}/*}}
\L{\LB{}\Tab{8}{Parses_the_request_}}
\L{\LB{}\Tab{8}{*/\CE{}}}
\L{\LB{}\Tab{8}{\V{string}_\V{request}_=_\V{requestStats}\-\!\>\V{request};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Find_the_end_of_the_request\CE{}}}
\L{\LB{}\Tab{8}{\K{int}_\V{end}_=_\V{request}.\V{find}(\S{}\3\2r\2n\2r\2n\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Find_the_end_of_the_request-line\CE{}}}
\L{\LB{}\Tab{8}{\K{int}_\V{i}_=_\V{request}.\V{find}(\S{}\3\2r\2n\3\SE{});}}
\L{\LB{}\Tab{8}{\K{if}(\V{i}_==_\V{string::npos})}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Parse_the_request-line\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(\V{parseRequestLine}(\V{request}.\V{substr}(\N{0},_\V{i}),_\V{requestStats}))}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{i}_==_\V{end})}}
\L{\LB{}\Tab{16}{\K{return}_\N{0};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{string}_\V{temp};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Iterate_through_remaining_lines_in_the_request\CE{}}}
\L{\LB{}\Tab{8}{\K{for}(\K{int}_\V{j}_=_\V{request}.\V{find}(\S{}\3\2r\2n\3\SE{},_\V{i}+\N{1});_\V{i}_!=_\V{end};_\V{j}_=_\V{request}.\V{find}(\S{}\3\2r\2n\3\SE{},_\V{i}+\N{1}))_\{}}
\L{\LB{}\Tab{16}{\V{temp}_=_\V{request}.\V{substr}(\V{i}+\N{2},\V{j}\-\V{i}\-\N{2});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Get_keep-alive;_this_will_override_the\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_keep-alive_set_by_the_protocol_type\CE{}}}
\L{\LB{}\Tab{16}{\K{if}(\V{temp}.\V{find}(\S{}\3Connection:_\3\SE{})_==_\N{0})_\{}}
\L{\LB{}\Tab{24}{\V{temp}_=_\V{temp}.\V{substr}(\N{12});}}
\L{\LB{}\Tab{24}{\V{transform}(\V{temp}.\V{begin}(),_\V{temp}.\V{end}(),_\V{temp}.\V{begin}(),_\V{ptr\_fun}(\V{::tolower}));}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\K{if}(\V{temp}_==_\S{}\3keep\-alive\3\SE{})}}
\L{\LB{}\Tab{32}{\V{requestStats}\-\!\>\V{keepAlive}_=_\N{1};}}
\L{\LB{}\Tab{24}{\K{else}_\K{if}(\V{temp}_==_\S{}\3close\3\SE{})}}
\L{\LB{}\Tab{32}{\V{requestStats}\-\!\>\V{keepAlive}_=_\N{0};}}
\L{\LB{}\Tab{24}{\K{else}}}
\L{\LB{}\Tab{32}{\K{return}_\N{1};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Get_the_host_(required_for_status_301)\CE{}}}
\L{\LB{}\Tab{16}{\K{else}_\K{if}(\V{temp}.\V{find}(\S{}\3Host:_\3\SE{})_==_\N{0})_\{}}
\L{\LB{}\Tab{24}{\V{requestStats}\-\!\>\V{host}_=_\V{temp}.\V{substr}(\N{6});}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{i}_=_\V{j};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{\}}}
\L{\LB{}}
\index{parseRequestLine}\Proc{parseRequestLine}\L{\LB{\K{int}_\V{parseRequestLine}(\V{string}_\V{requestLine},_\V{httpStats}_*\V{requestStats})_\{}}
\L{\LB{}\Tab{8}{\C{}/*}}
\L{\LB{}\Tab{8}{Parses_the_request_line_to_get_the_method,_path,_and_protocol.}}
\L{\LB{}\Tab{8}{*/\CE{}}\Tab{16}{}}
\L{\LB{}\Tab{8}{\C{}//_Make_sure_the_method_is_GET\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(\V{requestLine}.\V{length}()_\<_\N{4}_\|\,\|_(\S{}\3GET_\3\SE{}_!=_\V{requestLine}.\V{substr}(\N{0},_\N{4})))_\{}}
\L{\LB{}\Tab{16}{\V{requestStats}\-\!\>\V{serverResponse}_=_\S{}\3501_Not_Implemented\3\SE{};}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Get_the_path\CE{}}}
\L{\LB{}\Tab{8}{\V{requestLine}_=_\V{requestLine}.\V{substr}(\N{4},_\V{requestLine}.\V{length}()\-\N{4});}}
\L{\LB{}\Tab{8}{\K{int}_\V{i}_=_\V{requestLine}.\V{find}(\S{}\3_\3\SE{});}}
\L{\LB{}\Tab{8}{\K{if}(\V{i}_==_\V{string::npos})}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{requestStats}\-\!\>\V{path}_=_\V{fixPath}(\V{requestLine}.\V{substr}(\N{0},_\V{i}));}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Get_keep-alive\CE{}}}
\L{\LB{}\Tab{8}{\V{requestLine}_=_\V{requestLine}.\V{substr}(\V{i}+\N{1});}}
\L{\LB{}\Tab{8}{\K{if}(\V{requestLine}_!=_\S{}\3HTTP/1.0\3\SE{}_\&\&_\V{requestLine}_!=_\S{}\3HTTP/1.1\3\SE{})}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{requestStats}\-\!\>\V{keepAlive}_=_(\V{requestLine}_==_\S{}\3HTTP/1.1\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{\}}}
\L{\LB{}}
\index{runCGI}\Proc{runCGI}\L{\LB{\K{int}_\V{runCGI}(\V{httpStats}_*\V{data})_\{}}
\L{\LB{}\Tab{8}{\C{}/*}}
\L{\LB{}\Tab{8}{Runs_a_CGI_program._The_requested_path_should_be_in_this_format:}}
\L{\LB{}\Tab{8}{/cgi-bin/PROGRAM?arg1=X\&arg2=Y\&arg3=Z.\,.\,.}}
\L{\LB{}\Tab{8}{*/\CE{}}}
\L{\LB{}\Tab{8}{\V{string}_\V{command}_=_\V{getCGIInfo}(\V{data});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(!\V{command}.\V{length}())}}
\L{\LB{}\Tab{16}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\V{command}_+=_\S{}\3_\3\SE{}_+_\V{makeCGIName}(\V{data});}}
\L{\LB{}\Tab{8}{\V{command}_+=_\S{}\3_\3\SE{}_+_\V{data}\-\!\>\V{ipAddress};}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\K{char}_*\V{commandString}_=_\K{new}_\K{char}[\V{command}.\V{length}()+\N{1}];}}
\L{\LB{}\Tab{8}{\V{strcpy}(\V{commandString},_\V{command}.\V{c\_str}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{BOOL}_\V{rc};}}
\L{\LB{}\Tab{8}{\V{DWORD}_\V{reason};}}
\L{\LB{}\Tab{8}{\V{STARTUPINFO}_\V{startup};}}
\L{\LB{}\Tab{8}{\V{PROCESS\_INFORMATION}_\V{process};}}
\L{\LB{}\Tab{8}{\V{LPDWORD}_\V{exitcode}_=_\K{new}_\V{DWORD};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{startup}.\V{cb}}\Tab{48}{=_\K{sizeof}(\V{startup});}\Tab{72}{\C{}//_size_of_the_structure\CE{}}}
\L{\LB{}\Tab{8}{\V{startup}.\V{lpReserved}}\Tab{40}{=_\V{NULL};}\Tab{72}{\C{}//_must_be_NULL\CE{}}}
\L{\LB{}\Tab{8}{\V{startup}.\V{lpDesktop}}\Tab{40}{=_\V{NULL};}\Tab{72}{\C{}//_inherit_desktop_from_caller\CE{}}}
\L{\LB{}\Tab{8}{\V{startup}.\V{lpTitle}}\Tab{40}{=_\V{NULL};}\Tab{72}{\C{}//_use_executable_name_as_title\CE{}}}
\L{\LB{}\Tab{8}{\V{startup}.\V{dwFlags}}\Tab{40}{=_\N{0};}\Tab{72}{\C{}//_specify_no_flags\CE{}}}
\L{\LB{}\Tab{8}{\V{startup}.\V{cbReserved2}}\Tab{40}{=_\N{0};}\Tab{72}{\C{}//_must_be_0\CE{}}}
\L{\LB{}\Tab{8}{\V{startup}.\V{lpReserved2}}\Tab{40}{=_\V{NULL};}\Tab{72}{\C{}//_must_be_NULL\CE{}}}
\L{\LB{}}
\L{\LB{\C{}//}\Tab{8}{cout\<\<\3.\3\<\<commandString\<\<\3.\3\<\<endl;\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{rc}_=_\V{CreateProcess}(\V{NULL},_\V{commandString},_\V{NULL},_\V{NULL},_\V{FALSE},}}
\L{\LB{}\Tab{24}{\V{CREATE\_NEW\_CONSOLE},_\V{NULL},_\V{NULL},_\&\V{startup},_\&\V{process});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(_!\V{rc}_)_\{}}
\L{\LB{}\Tab{16}{\V{printf}(\S{}\3CreateProcess()_failed:}\Tab{49}{\%d\2n\3\SE{},_\V{GetLastError}());}}
\L{\LB{}\Tab{16}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{reason}_=_\V{WaitForSingleObject}(\V{process}.\V{hProcess},_\V{INFINITE});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{switch}(_\V{reason}_)_\{}}
\L{\LB{}\Tab{16}{\K{case}_\V{WAIT\_FAILED:}}}
\L{\LB{}\Tab{24}{\V{printf}(\S{}\3WaitForSingleObject()_failed:}\Tab{63}{\%d\2n\3\SE{},_\V{GetLastError}());}}
\L{\LB{}\Tab{24}{\K{break};}}
\L{\LB{}\Tab{16}{\K{case}_\V{WAIT\_ABANDONED:}}}
\L{\LB{}\Tab{24}{\V{printf}(\S{}\3WaitForSingleObject()_abandoned_wait\2n\3\SE{});}}
\L{\LB{}\Tab{24}{\K{break};}}
\L{\LB{}\Tab{16}{\K{case}_\V{WAIT\_OBJECT\_0:}}}
\L{\LB{}\Tab{24}{\V{GetExitCodeProcess}(\V{process}.\V{hProcess},_\V{exitcode});}}
\L{\LB{}\Tab{24}{\K{if}(*\V{exitcode}_==_\N{401})}}
\L{\LB{}\Tab{32}{\V{data}\-\!\>\V{serverResponse}_=_\S{}\3401_Unauthorized_Access\3\SE{};}}
\L{\LB{}\Tab{24}{\K{else}_\K{if}(*\V{exitcode}_==_\N{403})}}
\L{\LB{}\Tab{32}{\V{data}\-\!\>\V{serverResponse}_=_\S{}\3403_Access_Denied\3\SE{};}}
\L{\LB{}\Tab{24}{\K{break};}}
\L{\LB{}\Tab{16}{\V{default:}}}
\L{\LB{}\Tab{24}{\V{printf}(\S{}\3WaitForSingleObject()_returned_unexpected_code:}\Tab{81}{\%d\2n\3\SE{},_\V{reason});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{\}}}
\L{\LB{}}
\index{getCGIInfo}\Proc{getCGIInfo}\L{\LB{\V{string}_\V{getCGIInfo}(\V{httpStats}_*\V{data})_\{}}
\L{\LB{}\Tab{8}{\C{}/*}}
\L{\LB{}\Tab{8}{Parse_the_CGI_request_to_create_the_command_and_modify}}
\L{\LB{}\Tab{8}{the_httpStats_structure.}}
\L{\LB{}\Tab{8}{*/\CE{}}}
\L{\LB{}\Tab{8}{\V{string}_\V{path}_=_\V{data}\-\!\>\V{path};}}
\L{\LB{}\Tab{8}{\V{string::size\_type}_\V{stringPos},_\V{argPos};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{string}_\V{command};}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\C{}//_Get_rid_of_the_/cgi-bin/\CE{}}}
\L{\LB{}\Tab{8}{\V{path}_=_\V{path}.\V{substr}(\N{9});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Get_the_program_name\CE{}}}
\L{\LB{}\Tab{8}{\V{stringPos}_=_\V{path}.\V{find}(\S{}\3?\3\SE{});}}
\L{\LB{}\Tab{8}{\V{command}_=_\S{}\3perl_c:/webfiles/cgi\-bin/\3\SE{}_+_\V{path}.\V{substr}(\N{0},_\V{stringPos});}}
\L{\LB{}\Tab{8}{\V{path}_=_\V{path}.\V{substr}(\V{stringPos}+\N{1});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Get_arguments\CE{}}}
\L{\LB{}\Tab{8}{\K{while}((\V{stringPos}_=_\V{path}.\V{find}(\S{}\3\&\3\SE{}))_!=_\V{string::npos})_\{}}
\L{\LB{}\Tab{16}{\V{argPos}_=_\V{path}.\V{find}(\S{}\3=\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{command}_+=_\S{}\3_\2\3\3\SE{}_+_\V{path}.\V{substr}(\V{argPos}+\N{1},\V{stringPos}\-\V{argPos}\-\N{1})_+_\S{}\3\2\3\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{path}_=_\V{path}.\V{substr}(\V{stringPos}+\N{1});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\V{argPos}_=_\V{path}.\V{find}(\S{}\3=\3\SE{});}}
\L{\LB{}\Tab{8}{\V{command}_+=_\S{}\3_\2\3\3\SE{}_+_\V{path}.\V{substr}(\V{argPos}+\N{1})_+_\S{}\3\2\3\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\V{command};}}
\L{\LB{\}}}
\L{\LB{}}
\index{makeCGIName}\Proc{makeCGIName}\L{\LB{\V{string}_\V{makeCGIName}(\V{httpStats}_*\V{data})_\{}}
\L{\LB{}\Tab{8}{\C{}/*}}
\L{\LB{}\Tab{8}{Returns_a_temporary_filename_to_write_to/read_from.}}
\L{\LB{}\Tab{8}{*/\CE{}}}
\L{\LB{}\Tab{8}{\V{string}_\V{pathPart}_=_\S{}\3c:/webfiles/tmp\3\SE{};}}
\L{\LB{}\Tab{8}{\V{string}_\V{randPart};}}
\L{\LB{}\Tab{8}{\V{string}_\V{filename};}}
\L{\LB{}\Tab{8}{\K{char}_\V{buffer}[\N{10}],_*\V{bufptr}_=_\V{buffer};}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\V{srand}(\K{static\_cast}\<\K{unsigned}\>(\V{time}(\N{0})));}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{do}_\{}}
\L{\LB{}\Tab{16}{\V{randPart}_=_\S{}\3\3\SE{};}}
\L{\LB{}\Tab{16}{\K{for}(\K{int}_\V{i}=\N{0};_\V{i}\<\N{3};_\V{i}++)_\{}}
\L{\LB{}\Tab{24}{\V{bufptr}_=_\V{itoa}(\V{rand}(),_\V{bufptr},_\N{10});}}
\L{\LB{}\Tab{24}{\V{randPart}_+=_\V{bufptr};}\Tab{64}{}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{16}{\V{filename}_=_\V{pathPart}_+_\V{randPart}_+_\S{}\3.txt\3\SE{};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{while}_(!\V{\_access}(\V{filename}.\V{c\_str}(),_\N{0}));}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{data}\-\!\>\V{path}_=_\S{}\3/tmp\3\SE{}_+_\V{randPart}_+_\S{}\3.txt\3\SE{};}}
\L{\LB{}\Tab{8}{\C{}//data-\!\>basedir_=_\3c:/webfiles\3;\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\V{filename};}\Tab{40}{}}
\L{\LB{\}}}
\L{\LB{}}
\index{fileExistsP}\Proc{fileExistsP}\L{\LB{\K{int}_\V{fileExistsP}(\V{httpStats}_*\V{requestStats})_\{}}
\L{\LB{}\Tab{8}{\C{}/*}}
\L{\LB{}\Tab{8}{Returns_0_if_the_file_exists_and_is_readable._If_not,}}
\L{\LB{}\Tab{8}{the_serverResponse_is_set_to_the_appropriate_response.}}
\L{\LB{}\Tab{8}{*/\CE{}}}
\L{\LB{}\Tab{8}{\V{string}_\V{path}_=_\V{requestStats}\-\!\>\V{basedir}_+_\V{requestStats}\-\!\>\V{path};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Check_for_existence\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(\V{\_access}(\V{path}.\V{c\_str}(),_\N{0}))_\{}}
\L{\LB{}\Tab{16}{\V{requestStats}\-\!\>\V{serverResponse}_=_\S{}\3404_Not_Found\3\SE{};}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Check_for_readability\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(\V{\_access}(\V{path}.\V{c\_str}(),_\N{4}))_\{}}
\L{\LB{}\Tab{16}{\V{requestStats}\-\!\>\V{serverResponse}_=_\S{}\3500_Internal_Server_Error\3\SE{};}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{\}}}
\L{\LB{}}
\index{sendStatus}\Proc{sendStatus}\L{\LB{\K{int}_\V{sendStatus}(\V{httpStats}_*\V{requestStats})_\{}}
\L{\LB{}\Tab{8}{\C{}/*}}
\L{\LB{}\Tab{8}{Sends_the_status-line._If_it_is_not_a_200_OK,}}
\L{\LB{}\Tab{8}{this_is_the_entire_response._Otherwise,_the_OK}}
\L{\LB{}\Tab{8}{status_is_sent_and_other_functions_will_take}}
\L{\LB{}\Tab{8}{care_of_the_rest_of_the_response.}}
\L{\LB{}\Tab{8}{*/\CE{}}}
\L{\LB{}\Tab{8}{\V{string}_\V{temp},_\V{html};}}
\L{\LB{}\Tab{8}{\K{char}_\V{intBuffer}[\K{sizeof}(\K{int})*\N{8}+\N{1}];}\Tab{48}{\C{}//_For_itoa_conversion\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_If_the_serverResponse_has_already_been_set,\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_send_that_response_with_an_error_page\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(!\V{requestStats}\-\!\>\V{serverResponse}.\V{empty}())_\{}}
\L{\LB{}\Tab{16}{\V{temp}_=_\V{requestStats}\-\!\>\V{serverResponse};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Generate_a_small_error_page\CE{}}}
\L{\LB{}\Tab{16}{\V{html}_=_\S{}\3\<html\>\<head\>\<title\>\3\SE{}_+_\V{temp};}}
\L{\LB{}\Tab{16}{\V{html}_+=_\S{}\3\</title\</head\>\<body\>\3\SE{}_+_\V{temp};}}
\L{\LB{}\Tab{16}{\V{html}_+=_\S{}\3\<br_/\>\<pre\>\3\SE{}_+_\V{requestStats}\-\!\>\V{request};}}
\L{\LB{}\Tab{16}{\V{html}_+=_\S{}\3\</pre\>\</body\>\</html\>\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Generate_the_actual_response;_note_that\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_the_html_goes_after_the_double_CRLF\CE{}}}
\L{\LB{}\Tab{16}{\V{temp}_=_\S{}\3HTTP/1.1_\3\SE{}_+_\V{temp}_+_\S{}\3\2r\2n\3\SE{};}}
\L{\LB{}\Tab{16}{\V{temp}_+=_\S{}\3Content\-Length:_\3\SE{};}}
\L{\LB{}\Tab{16}{\V{temp}_+=_\V{itoa}(\V{html}.\V{length}(),_\V{intBuffer},_\N{10});}}
\L{\LB{}\Tab{16}{\V{temp}_+=_\S{}\3\2r\2nContent\-Type:_text/html\2r\2n\2r\2n\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{temp}_+=_\V{html};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{return}_\V{sendString}(\V{requestStats}\-\!\>\V{socket},_\V{temp});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_serverResponse_has_not_been_set\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(\V{sendString}(\V{requestStats}\-\!\>\V{socket},_\S{}\3HTTP/1.1_200_OK\2r\2n\3\SE{}))}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{\}}}
\L{\LB{}}
\index{sendResponse}\Proc{sendResponse}\L{\LB{\K{int}_\V{sendResponse}(\V{httpStats}_*\V{requestStats})_\{}}
\L{\LB{}\Tab{8}{\C{}/*}}
\L{\LB{}\Tab{8}{Sends_the_response_back_to_the_client.}}
\L{\LB{}\Tab{8}{*/\CE{}}}
\L{\LB{}\Tab{8}{\K{int}_\V{fd};}}
\L{\LB{}\Tab{8}{\V{string}_\V{path},_\V{contentType};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Handle_any_non_200_status_messages\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(!\V{requestStats}\-\!\>\V{serverResponse}.\V{empty}()_\|\,\|_\V{fileExistsP}(\V{requestStats}))_\{}}
\L{\LB{}\Tab{16}{\K{if}(\V{sendStatus}(\V{requestStats}))}}
\L{\LB{}\Tab{24}{\K{return}_\N{1};}}
\L{\LB{}\Tab{16}{\K{return}_\N{0};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{contentType}_=_\V{pathExtension}(\V{requestStats}\-\!\>\V{path});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{path}_=_\V{requestStats}\-\!\>\V{basedir}_+_\V{requestStats}\-\!\>\V{path};}}
\L{\LB{}\Tab{8}{\V{fd}_=_\V{\_open}(\V{path}.\V{c\_str}(),_\V{\_O\_RDONLY}_\|_\V{\_O\_BINARY});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{\_filelength}(\V{fd})_!=_\-\N{1})_\{_\C{}//_fd_is_a_file\CE{}}}
\L{\LB{}\Tab{16}{\K{if}(\V{sendStatus}(\V{requestStats}))_}}
\L{\LB{}\Tab{24}{\K{return}_\N{1};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{return}_\V{sendFile}(\V{fd},_\V{contentType},_\V{requestStats});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_A_directory_has_been_requested,_so\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_the_filehandle_is_no_longer_needed\CE{}}}
\L{\LB{}\Tab{8}{\V{\_close}(\V{fd});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\V{sendDirectory}(\V{requestStats});}}
\L{\LB{\}}}
\L{\LB{}}
\index{fixPath}\Proc{fixPath}\L{\LB{\V{string}_\V{fixPath}(\V{string}_\V{path})_\{}}
\L{\LB{}\Tab{8}{\C{}/*}}
\L{\LB{}\Tab{8}{Changes_all_instances_of_\%20_in_the_path}}
\L{\LB{}\Tab{8}{to_spaces.}}
\L{\LB{}\Tab{8}{*/\CE{}}}
\L{\LB{}\Tab{8}{\K{int}_\V{i};_\V{string}_\V{temp};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{while}((\V{i}_=_\V{path}.\V{find}(\S{}\3\%20\3\SE{}))_!=_\V{string::npos})_\{}}
\L{\LB{}\Tab{16}{\V{temp}_=_\V{path}.\V{substr}(\N{0},_\V{i})_+_\S{}\3_\3\SE{};}}
\L{\LB{}\Tab{16}{\V{path}_=_\V{temp}_+_\V{path}.\V{substr}(\V{i}+\N{3},\V{path}.\V{length}()\-\N{3}\-\V{i});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\V{path};}}
\L{\LB{\}}}
\L{\LB{}}
\index{sendDirectory}\Proc{sendDirectory}\L{\LB{\K{int}_\V{sendDirectory}(\V{httpStats}_*\V{requestStats})_\{}}
\L{\LB{}\Tab{8}{\C{}/*}}
\L{\LB{}\Tab{8}{Handles_the_case_where_the_requested_path}}
\L{\LB{}\Tab{8}{is_to_a_directory._If_the_path_does_not_end}}
\L{\LB{}\Tab{8}{in_{'}/{'},_a_301_is_sent_back_to_the_client.}}
\L{\LB{}\Tab{8}{Else,_the_client_will_receive_index.html_or_index.htm}}
\L{\LB{}\Tab{8}{if_one_exists._Otherwise,_the_client_will}}
\L{\LB{}\Tab{8}{receive_a_hyperlinked_listing_of_the_directory.}}
\L{\LB{}\Tab{8}{*/\CE{}}}
\L{\LB{}\Tab{8}{\V{string}_\V{temp},_\V{path},_\V{response};}}
\L{\LB{}\Tab{8}{\K{char}_\V{longBuffer}[\K{sizeof}(\K{long})*\N{8}+\N{1}];_\C{}//_for_ltoa\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_If_the_path_doesn{'}t_end_in_/,_send_a_301\CE{}}}
\L{\LB{}\Tab{8}{\V{path}_=_\V{requestStats}\-\!\>\V{path};}}
\L{\LB{}\Tab{8}{\K{if}(\V{path}[\V{path}.\V{length}()\-\N{1}]_!=_\S{}{'}/{'}\SE{})_\{}}
\L{\LB{}\Tab{16}{\V{temp}_=_\S{}\3301_Moved_Permanently\2r\2n\3\SE{};}}
\L{\LB{}\Tab{16}{\V{temp}_+=_\S{}\3Location:_http://\3\SE{}_+_\V{requestStats}\-\!\>\V{host}_+_\V{path}_+_\S{}\3/\3\SE{};}}
\L{\LB{}\Tab{16}{\V{requestStats}\-\!\>\V{serverResponse}_=_(\V{requestStats}\-\!\>\V{host}.\V{empty}())_}}
\L{\LB{}\Tab{24}{?_\S{}\3400_Bad_Request\3\SE{}}}
\L{\LB{}\Tab{24}{\V{:}_\V{temp}_;}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}(\V{sendStatus}(\V{requestStats}))}}
\L{\LB{}\Tab{24}{\K{return}_\N{1};}}
\L{\LB{}\Tab{16}{}}
\L{\LB{}\Tab{16}{\K{return}_\N{0};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{requestStats}\-\!\>\V{serverResponse}_=_\S{}\3\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Check_for_index.html_and_index.htm\CE{}}}
\L{\LB{}\Tab{8}{\V{requestStats}\-\!\>\V{path}_=_\V{path}_+_\S{}\3index.html\3\SE{};}}
\L{\LB{}\Tab{8}{\K{if}(!\V{fileExistsP}(\V{requestStats}))_\{}}
\L{\LB{}\Tab{16}{\K{if}(\V{sendResponse}(\V{requestStats}))}}
\L{\LB{}\Tab{24}{\K{return}_\N{1};}}
\L{\LB{}\Tab{16}{\K{return}_\N{0};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{requestStats}\-\!\>\V{path}_=_\V{path}_+_\S{}\3index.htm\3\SE{};}}
\L{\LB{}\Tab{8}{\K{if}(!\V{fileExistsP}(\V{requestStats}))_\{}}
\L{\LB{}\Tab{16}{\K{if}(\V{sendResponse}(\V{requestStats}))}}
\L{\LB{}\Tab{24}{\K{return}_\N{1};}}
\L{\LB{}\Tab{16}{\K{return}_\N{0};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_index.htm[l]_doesn{'}t_exist,_so_send\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_a_directory_listing\CE{}}}
\L{\LB{}\Tab{8}{\V{requestStats}\-\!\>\V{path}_=_\V{path};}}
\L{\LB{}\Tab{8}{\V{temp}_=_\V{makeDirectoryListing}(\V{requestStats});}}
\L{\LB{}\Tab{8}{\K{if}(\V{temp}.\V{empty}())}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Generate_the_response\CE{}}}
\L{\LB{}\Tab{8}{\V{response}_=_\S{}\3HTTP/1.1_200_OK\2r\2nContent\-Length:_\3\SE{};}}
\L{\LB{}\Tab{8}{\V{response}_+=_\V{ltoa}(\V{temp}.\V{length}(),_\V{longBuffer},_\N{10});}}
\L{\LB{}\Tab{8}{\V{response}_+=_\S{}\3\2r\2nContent\-Type:_text/html\2r\2n\2r\2n\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{sendString}(\V{requestStats}\-\!\>\V{socket},_\V{response}))}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}\Tab{8}{\K{if}(\V{sendString}(\V{requestStats}\-\!\>\V{socket},_\V{temp}))}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{\}}}
\L{\LB{}}
\index{sendFile}\Proc{sendFile}\L{\LB{\K{int}_\V{sendFile}(\K{int}_\V{fd},_\V{string}_\V{contentType},_\V{httpStats}_*\V{requestStats})_\{}}
\L{\LB{}\Tab{8}{\C{}/*}}
\L{\LB{}\Tab{8}{Sends_the_response_from_a_GET_request._The_status-line}}
\L{\LB{}\Tab{8}{has_already_been_sent,_but_the_response-headers_and_file}}
\L{\LB{}\Tab{8}{has_not_been_sent.}}
\L{\LB{}\Tab{8}{*/\CE{}}}
\L{\LB{}\Tab{8}{\V{string}_\V{responseHeader};}}
\L{\LB{}\Tab{8}{\K{long}_\V{i}=\N{0},_\V{filePos}_=_\N{0},_\V{socket}_=_\V{requestStats}\-\!\>\V{socket};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_For_ltoa_and_overloaded_sendString\CE{}}}
\L{\LB{}\Tab{8}{\K{char}_\V{longBuffer}[\K{sizeof}(\K{long})*\N{8}+\N{1}],_\V{sendBuffer}[\N{4097}];}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\C{}//_Generate_response-headers\CE{}}}
\L{\LB{}\Tab{8}{\V{responseHeader}_=_\S{}\3Content\-Length:_\3\SE{};}}
\L{\LB{}\Tab{8}{\V{responseHeader}_+=_\V{ltoa}(\V{\_filelength}(\V{fd}),_\V{longBuffer},_\N{10});}}
\L{\LB{}\Tab{8}{\V{responseHeader}_+=_\S{}\3\2r\2nContent\-Type:_\3\SE{}_+_\V{contentType}_+_\S{}\3\2r\2n\2r\2n\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{sendString}(\V{socket},_\V{responseHeader}.\V{c\_str}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Send_the_file\CE{}}}
\L{\LB{}\Tab{8}{\V{\_lseek}(\V{fd},_\V{filePos},_\N{0});}}
\L{\LB{}\Tab{8}{\K{while}((\V{i}_=_\V{\_read}(\V{fd},_\V{sendBuffer},_\V{BUFSIZE}))_\>_\N{0})_\{}}
\L{\LB{}\Tab{16}{\C{}//_Use_the_char*_based_sendString,_because\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_files_may_have_null_characters_in_them.\CE{}}}
\L{\LB{}\Tab{16}{\K{if}(\V{sendString}(\V{socket},_\V{sendBuffer},_\V{i}))}}
\L{\LB{}\Tab{24}{\K{return}_\N{1};}}
\L{\LB{}\Tab{16}{\V{filePos}_+=_\V{i};}}
\L{\LB{}\Tab{16}{\V{\_lseek}(\V{fd},_\V{filePos},_\N{0});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{if}(\V{i})_\{}}
\L{\LB{}\Tab{16}{\V{\_close}(\V{fd});}}
\L{\LB{}\Tab{16}{\V{cout}\<\<\S{}\3Problem_reading_file_\3\SE{}\<\<\V{requestStats}\-\!\>\V{basedir}_+_\V{requestStats}\-\!\>\V{path}\<\<\V{endl};}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{QueryPerformanceCounter}(\&\V{requestStats}\-\!\>\V{stopTime});}}
\L{\LB{}\Tab{8}{\V{totalTime}_+=_\N{1000}*(\V{requestStats}\-\!\>\V{stopTime}.\V{QuadPart}_\-_\V{requestStats}\-\!\>\V{startTime}.\V{QuadPart})/(\K{double})\V{freq}.\V{QuadPart};}}
\L{\LB{}\Tab{8}{\C{}//cout\<\<\3(\3\<\<totalTime/++totalRequests\<\<\3)\3\<\<endl;\CE{}}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\V{\_close}(\V{fd});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{\}}}
\L{\LB{}}
\index{makeDirectoryListing}\Proc{makeDirectoryListing}\L{\LB{\V{string}_\V{makeDirectoryListing}(\V{httpStats}_*\V{requestStats})_\{}}
\L{\LB{}\Tab{8}{\C{}/*}}
\L{\LB{}\Tab{8}{Returns_an_HTML_directory_listing_of_the_requested_basedir+path.}}
\L{\LB{}\Tab{8}{*/\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{string}_\V{html}_=_\S{}\3\<html\>\<head\>\<title\>Index_of_\3\SE{};}}
\L{\LB{}\Tab{8}{\V{html}_+=_\V{requestStats}\-\!\>\V{path}.\V{substr}(\N{0},_\V{requestStats}\-\!\>\V{path}.\V{length}()\-\N{1});}}
\L{\LB{}\Tab{8}{\V{html}_+=_\S{}\3\</title\>\</head\>\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Go_through_all_files_in_the_directory\CE{}}}
\L{\LB{}\Tab{8}{\V{WIN32\_FIND\_DATA}_\V{FindFileData};}}
\L{\LB{}\Tab{8}{\V{HANDLE}_\V{hFind}_=_\V{INVALID\_HANDLE\_VALUE};}}
\L{\LB{}\Tab{8}{\K{char}_\V{DirSpec}[\V{BUFSIZE}];}}
\L{\LB{}\Tab{8}{\V{DWORD}_\V{dwError};}}
\L{\LB{}\Tab{8}{\V{string}_\V{path}_=_\V{requestStats}\-\!\>\V{basedir}_+_\V{requestStats}\-\!\>\V{path};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{strncpy}(\V{DirSpec},_\V{path}.\V{c\_str}(),_\V{path}.\V{length}()+\N{1});}}
\L{\LB{}\Tab{8}{\V{strncat}(\V{DirSpec},_\S{}\3\2\2*\3\SE{},_\N{3});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{hFind}_=_\V{FindFirstFile}(\V{DirSpec},_\&\V{FindFileData});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{hFind}_==_\V{INVALID\_HANDLE\_VALUE})_\{}}
\L{\LB{}\Tab{16}{\V{cout}\<\<\S{}\3Could_not_read_directory_\3\SE{}\<\<\V{html}\<\<\V{endl};}}
\L{\LB{}\Tab{16}{\K{return}_\S{}\3\3\SE{};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{else}_\{}}
\L{\LB{}\Tab{16}{\C{}//_Add_the_link\CE{}}}
\L{\LB{}\Tab{16}{\V{html}_+=_\V{addLink}(\V{FindFileData}.\V{cFileName});}}
\L{\LB{}\Tab{16}{\K{while}(\V{FindNextFile}(\V{hFind},_\&\V{FindFileData})_!=_\N{0})}}
\L{\LB{}\Tab{24}{\C{}//_Add_the_link\CE{}}}
\L{\LB{}\Tab{24}{\V{html}_+=_\V{addLink}(\V{FindFileData}.\V{cFileName});}}
\L{\LB{}\Tab{16}{\V{dwError}_=_\V{GetLastError}();}}
\L{\LB{}\Tab{16}{\K{if}(\V{dwError}_==_\V{ERROR\_NO\_MORE\_FILES})}}
\L{\LB{}\Tab{24}{\V{FindClose}(\V{hFind});}}
\L{\LB{}\Tab{16}{\K{else}_\{}}
\L{\LB{}\Tab{24}{\V{cout}\<\<\S{}\3FindNextFile_error:_\3\SE{}\<\<\V{dwError}\<\<\V{endl};}}
\L{\LB{}\Tab{24}{\K{return}_\S{}\3\3\SE{};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{html}_+=_\S{}\3\</html\>\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\V{html};}}
\L{\LB{\}}}
\L{\LB{}}
\index{addLink}\Proc{addLink}\L{\LB{\V{string}_\V{addLink}(\V{string}_\V{fileName})_\{}}
\L{\LB{}\Tab{8}{\C{}/*}}
\L{\LB{}\Tab{8}{Helper_function_for_makeDirectoryListing._This}}
\L{\LB{}\Tab{8}{takes_a_filename_and_returns_an_HTML_link_to}}
\L{\LB{}\Tab{8}{the_file.}}
\L{\LB{}\Tab{8}{*/\CE{}}}
\L{\LB{}\Tab{8}{\V{string}_\V{temp}_=_\S{}\3\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Don{'}t_include_self_or_parent_directories\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(\V{fileName}_!=_\S{}\3.\3\SE{}_\&\&_\V{fileName}_!=_\S{}\3.\,.\3\SE{})_\{}}
\L{\LB{}\Tab{16}{\V{temp}_+=_\S{}\3\<a_href_=_\2\3\3\SE{}_+_\V{fileName};}}
\L{\LB{}\Tab{16}{\V{temp}_+=_\S{}\3\2\3\>\3\SE{}_+_\V{fileName};}}
\L{\LB{}\Tab{16}{\V{temp}_+=_\S{}\3\</a\>\<br_/\>\3\SE{};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\V{temp};}}
\L{\LB{\}}}
\L{\LB{}}
\index{pathExtension}\Proc{pathExtension}\L{\LB{\V{string}_\V{pathExtension}(\V{string}_\V{path})_\{}}
\L{\LB{}\Tab{8}{\C{}/*}}
\L{\LB{}\Tab{8}{Returns_the_content-type_of_a_file_from}}
\L{\LB{}\Tab{8}{the_filename{'}s_extension.}}
\L{\LB{}\Tab{8}{*/\CE{}}}
\L{\LB{}\Tab{8}{\K{int}_\V{i}_=_\V{path}.\V{find\_last\_of}(\S{}\3.\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{i}_!=_\V{string::npos})_\{}}
\L{\LB{}\Tab{16}{\V{string}_\V{temp}_=_\V{path}.\V{substr}(\V{i}+\N{1},_\V{path}.\V{length}()\-\V{i}\-\N{1});}}
\L{\LB{}\Tab{16}{\V{transform}(\V{temp}.\V{begin}(),_\V{temp}.\V{end}(),_\V{temp}.\V{begin}(),_\V{ptr\_fun}(\V{::tolower}));}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Look_up_the_extension_in_the_map\CE{}}}
\L{\LB{}\Tab{16}{\K{if}(\V{contentTypes}.\V{find}(\V{temp})_!=_\V{contentTypes}.\V{end}())}}
\L{\LB{}\Tab{24}{\K{return}_\V{contentTypes}[\V{temp}];}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Default_content-type\CE{}}}
\L{\LB{}\Tab{8}{\K{return}_\S{}\3application/octet\-stream\3\SE{};}}
\L{\LB{\}}}
\L{\LB{}}
\index{initSocket}\Proc{initSocket}\L{\LB{\V{SOCKET}_\V{initSocket}()_\{}}
\L{\LB{}\Tab{8}{\C{}/*}}
\L{\LB{}\Tab{8}{Initialize_networking._The_port_is_automatically_set_to_80,_since}}
\L{\LB{}\Tab{8}{this_is_an_HTTP_server._Upon_receiving_an_error,_the_program_will}}
\L{\LB{}\Tab{8}{exit_with_an_error_message,_as_nothing_can_be_done_without_network}}
\L{\LB{}\Tab{8}{connectivity.}}
\L{\LB{}\Tab{8}{*/\CE{}}}
\L{\LB{}\Tab{8}{\V{SOCKET}_\V{msock};}}
\L{\LB{}\Tab{8}{\V{WSADATA}}\Tab{16}{\V{wsadata};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Initialize_socket_software\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{WSAStartup}(\V{WSVERS},_\&\V{wsadata})_!=_\N{0})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3WSAStartup_failed\2n\3\SE{});}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\K{struct}_\V{sockaddr\_in}_\V{sin};}\Tab{40}{\C{}//_an_Internet_endpoint_address\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Populate_the_endpoint_address_structure\CE{}}}
\L{\LB{}\Tab{8}{\V{memset}(\&\V{sin},_\N{0},_\K{sizeof}(\V{sin}));}}
\L{\LB{}\Tab{8}{\V{sin}.\V{sin\_family}_=_\V{AF\_INET};}}
\L{\LB{}\Tab{8}{\V{sin}.\V{sin\_addr}.\V{s\_addr}_=_\V{INADDR\_ANY};}}
\L{\LB{}\Tab{8}{\V{sin}.\V{sin\_port}_=_\V{htons}(\N{80});}}
\L{\LB{}}
\L{\LB{}\Tab{4}{\C{}/*_Allocate_a_socket_*/\CE{}}}
\L{\LB{}\Tab{8}{\V{msock}_=_\V{socket}(\V{PF\_INET},_\V{SOCK\_STREAM},_\N{0});}}
\L{\LB{}\Tab{8}{\K{if}_(\V{msock}_==_\V{INVALID\_SOCKET})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3can{'}t_create_socket:_\%d\2n\3\SE{},_\V{GetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{4}{\C{}/*_Bind_the_socket_*/\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{bind}(\V{msock},_(\K{struct}_\V{sockaddr}_*)\&\V{sin},_\K{sizeof}(\V{sin}))_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3can{'}t_bind_to_port_\%d:_\%d\2n\3\SE{},_\V{sin}.\V{sin\_port},_\V{GetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}/*_Start_listening_*/\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{listen}(\V{msock},_\N{10})_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3can{'}t_listen_on_\%d_port:_\%d\2n\3\SE{},_\V{sin}.\V{sin\_port},_\V{GetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\V{msock};}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{\C{}/*}}
\L{\LB{sendString}}
\L{\LB{}}
\L{\LB{}\Tab{2}{Sends_the_string_temp_through_the_socket}}
\L{\LB{}\Tab{2}{specified_in_the_arguments._The_first_version}}
\L{\LB{}\Tab{2}{is_used_predominantly_throughout_the_program,}}
\L{\LB{}\Tab{2}{as_it_takes_an_STL_string._The_second_version}}
\L{\LB{}\Tab{2}{is_solely_used_to_transfer_chunks_of_files,}}
\L{\LB{}\Tab{2}{since_null_characters_in_a_file_will_cause}}
\L{\LB{}\Tab{2}{an_STL_string_to_be_cut_off.}}
\L{\LB{*/\CE{}}}
\index{sendString}\Proc{sendString}\L{\LB{\K{int}_\V{sendString}(\V{SOCKET}_\V{fd},_\V{string}_\V{temp})_\{}}
\L{\LB{}\Tab{8}{\K{int}_\V{i}_=_\V{temp}.\V{length}();}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{int}_\V{j}_=_\V{send}(\V{fd},_\V{temp}.\V{substr}().\V{c\_str}(),_\V{i},_\N{0});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{while}(\V{i}_!=_\V{j}_\&\&_\V{j}_!=_\V{SOCKET\_ERROR})_\{}}
\L{\LB{}\Tab{16}{\V{i}_\-=_\V{j};}}
\L{\LB{}\Tab{16}{\V{j}_=_\V{send}(\V{fd},_\V{temp}.\V{substr}().\V{c\_str}(),_\V{i},_\N{0});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{j}_==_\V{SOCKET\_ERROR})_\{}}
\L{\LB{}\Tab{16}{\V{fprintf}(\V{stderr},_\S{}\3send_error:_\%d\2n\3\SE{},_\V{GetLastError}());}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{\}}}
\L{\LB{}}
\index{sendString}\Proc{sendString}\L{\LB{\K{int}_\V{sendString}(\V{SOCKET}_\V{fd},_\K{char}_*\V{temp},_\K{int}_\V{length})_\{}}
\L{\LB{}\Tab{8}{\K{int}_\V{i}_=_\V{length};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{int}_\V{j}_=_\V{send}(\V{fd},_\V{temp},_\V{i},_\N{0});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{while}(\V{i}_!=_\V{j}_\&\&_\V{j}_!=_\V{SOCKET\_ERROR})_\{}}
\L{\LB{}\Tab{16}{\V{i}_\-=_\V{j};}}
\L{\LB{}\Tab{16}{\V{j}_=_\V{send}(\V{fd},_\V{temp},_\V{i},_\N{0});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{j}_==_\V{SOCKET\_ERROR})_\{}}
\L{\LB{}\Tab{16}{\V{fprintf}(\V{stderr},_\S{}\3send_error:_\%d\2n\3\SE{},_\V{GetLastError}());}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{\}}}
