% Remember to use the lgrind style

\Head{}
\File{mtGetv2.cpp}{2004}{11}{18}{21:15}{9806}
\L{\LB{\C{}/*************************************************************************}}
\L{\LB{FileName:_mtGetv2.cpp_(Multi-threaded_Get)}}
\L{\LB{}}
\L{\LB{Multi-threaded_client,_which_spawns_num\_threads_threads_and_makes_GET}}
\L{\LB{requests_for_a_file.}}
\L{\LB{}}
\L{\LB{A_\3less_aggressive\3_version_of_mtGet_(called_mtGetv2.cpp)_}}
\L{\LB{that_does_not_exhibit_the_connection-refused_problem_that_occurs_when_}}
\L{\LB{the_original_mtGet_runs_on_the_same_host_as_the_server.}}
\L{\LB{The_problem_is_that_the_original_mtGet_bangs_out_so_many_connection_}}
\L{\LB{requests_when_it_first_starts_up_that_the_system_runs_out_of_resources_}}
\L{\LB{and_new_connections_are_refused_(until_mtGet_slows_down_as_the_slave_}}
\L{\LB{threads_take_up_more_cycles)._This_modified_version_of_the_original_mtGet_}}
\L{\LB{connects_each_socket_sequentially,_but_sends_the_requests_and_retrieves_the_}}
\L{\LB{files_concurrently._}}
\L{\LB{}}
\L{\LB{Library_required:_WS2\_32.lib}}
\L{\LB{Project_-\!\>_Settings_-\!\>_C/C++_-\!\>_Code_generation_to_be_changed_to}}
\L{\LB{Debug-Multithreaded.}}
\L{\LB{}}
\L{\LB{References_and_Acknowledgements:}}
\L{\LB{WinSock_2.0_by_Lewis_Napper}}
\L{\LB{(Published_by_IDG_Books)}}
\L{\LB{}}
\L{\LB{--------------------------------------------------------------------------}}
\L{\LB{Usage:}}
\L{\LB{File_to_be_retrieved_from_the_http_server_has_to_be_specified_on_the}}
\L{\LB{command_line}}
\L{\LB{}}
\L{\LB{Example:}}
\L{\LB{If_the_executable_mtGet.exe_exists_in_C:\2ClientTest:}}
\L{\LB{}}
\L{\LB{C:\2ClientTest\>_mtGet_www.freebsd.org_/index.html_\>_indexDump.html}}
\L{\LB{}}
\L{\LB{The_above_command_will_spawn_num\_threads_number_of_threads_and_make_}}
\L{\LB{connections_to_www.freebsd.org._Each_thread_will_retrieve_the_index.html}}
\L{\LB{file_and_append_the_retrieved_file_to_indexDump.html}}
\L{\LB{}}
\L{\LB{For_instance,_if_num\_threads_=_10,_at_the_end_of_execution,_you_will}}
\L{\LB{have_10_index.html_files,_one_below_the_other_and_wholly_contained_in}}
\L{\LB{indexDump.html}}
\L{\LB{}}
\L{\LB{In_the_server-name_field,_you_can_alternatively_choose_localhost_if}}
\L{\LB{you_want_to_connect_to_your_server.}}
\L{\LB{*************************************************************************/\CE{}}}
\L{\LB{}}
\L{\LB{\K{\#include}_\<\V{stdio}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{fcntl}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{io}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{winsock}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{time}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{process}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{stdlib}.\V{h}\>}}
\L{\LB{}}
\L{\LB{\K{\#include}_\<\V{string}\>}}
\L{\LB{}}
\L{\LB{\K{using}_\K{namespace}_\V{std};}}
\L{\LB{}}
\L{\LB{\K{\#define}_\V{LF}_\S{}{'}\2x0A{'}\SE{}}}
\L{\LB{\K{\#define}_\V{CR}_\S{}{'}\2x0D{'}\SE{}}}
\L{\LB{}}
\L{\LB{\C{}//If_defined,_the_client_will_append_the_standard_HTTP_header_to_the_GET_request\CE{}}}
\L{\LB{\C{}//You_may_choose_to_\3undef\3_this_constant_if_you_do_not_want_to_send_the_header\CE{}}}
\L{\LB{\K{\#define}_\V{USE\_HTTP\_HEADER}}}
\L{\LB{}}
\L{\LB{\C{}//Prints_the_number_of_bytes_received_in_each_recv_call\CE{}}}
\L{\LB{\C{}//\#define_DISPLAY\_RECV\_STATUS\CE{}}}
\L{\LB{}}
\L{\LB{\C{}//The_number_of_threads_to_be_spawned\CE{}}}
\L{\LB{\C{}//\#define_num\_threads_14\CE{}}}
\L{\LB{}}
\L{\LB{\C{}//_For_building_the_sockets\CE{}}}
\L{\LB{\K{struct}_\V{passData}}}
\L{\LB{\{}}
\L{\LB{}\Tab{8}{\K{char}_\V{serverName}[\N{100}];}}
\L{\LB{}\Tab{8}{\K{char}_\V{fileName}[\N{100}];}}
\L{\LB{\};}}
\L{\LB{}}
\L{\LB{\C{}//_This_actually_passes_data_to_the_thread\CE{}}}
\L{\LB{\K{struct}_\V{httpData}_\{}}
\L{\LB{}\Tab{8}{\V{SOCKET}_\V{socket};}}
\L{\LB{}\Tab{8}{\V{string}_\V{file};}}
\L{\LB{\};}}
\L{\LB{}}
\L{\LB{\K{void}_\V{BuildCommon}(\V{SOCKADDR\_IN}_*);}}
\L{\LB{\K{void}_\V{HTTPGetRequest}(\K{struct}_\V{httpData}_*);}}
\L{\LB{}}
\L{\LB{\C{}//_Helper_macro_for_displaying_errors\CE{}}}
\L{\LB{\K{\#define}_\V{ErrNotify}(\V{s})}\Tab{24}{\2}}
\index{fprintf}\Proc{fprintf}\L{\LB{}\Tab{16}{\V{fprintf}(\V{stderr},\S{}\3\2n\%s:_\%d\2n\3\SE{},_\V{s},_\V{WSAGetLastError}())}}
\L{\LB{}}
\L{\LB{\K{void}}}
\L{\LB{\V{errexit}(\K{const}_\K{char}_*\V{format},_.\,.\,.)}}
\L{\LB{\{}}
\L{\LB{}\Tab{8}{\V{va\_list}}\Tab{16}{\V{args};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{va\_start}(\V{args},_\V{format});}}
\L{\LB{}\Tab{8}{\V{vfprintf}(\V{stderr},_\V{format},_\V{args});}}
\L{\LB{}\Tab{8}{\V{va\_end}(\V{args});}}
\L{\LB{}\Tab{8}{\V{WSACleanup}();}}
\L{\LB{}\Tab{8}{\V{exit}(\N{1});}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}//_Global_memory_for_common_HTTP_request_buffer\CE{}}}
\L{\LB{\C{}//char_szRequestBuffer[1024];\CE{}}}
\L{\LB{\K{long}_\V{totalBytes};}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}////////////////////////////////////////////////////////////\CE{}}}
\L{\LB{}}
\index{main}\Proc{main}\L{\LB{\K{int}_\V{main}(\K{int}_\V{argc},_\K{char}_*\V{argv}[\,])}}
\L{\LB{\{}}
\L{\LB{}\Tab{8}{\V{WORD}_\V{wVersionRequested}_=_\V{MAKEWORD}(\N{1},\N{1});}}
\L{\LB{}\Tab{8}{\V{WSADATA}_\V{wsaData};}}
\L{\LB{}\Tab{8}{\K{int}_\V{nRet};}}
\L{\LB{}\Tab{8}{\V{SOCKET}_\V{Socket};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//struct_passData_*ptrData;\CE{}}}
\L{\LB{}\Tab{8}{\C{}//ptrData_=_(passData_*)malloc(sizeof(struct_passData));\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Check_arguments\CE{}}}
\L{\LB{\C{}//}\Tab{8}{if_(argc_\<_3)\CE{}}}
\L{\LB{\C{}//}\Tab{8}{\{\CE{}}}
\L{\LB{\C{}//}\Tab{16}{fprintf(stderr,\CE{}}}
\L{\LB{\C{}//}\Tab{24}{\3\2nSyntax:_mtGet_ServerName_FullPathName\2n\3);\CE{}}}
\L{\LB{\C{}//}\Tab{16}{return_-1;\CE{}}}
\L{\LB{\C{}//}\Tab{8}{\}\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//strcpy(ptrData-\!\>serverName,_argv[1]);\CE{}}}
\L{\LB{}\Tab{8}{\C{}//strcpy(ptrData-\!\>fileName,_argv[2]);\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Server_is_localhost\CE{}}}
\L{\LB{}\Tab{8}{\C{}//strcpy(ptrData-\!\>serverName,_\3localhost\3);\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//printf(\3\%s\2n\3,_ptrData-\!\>serverName);\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{totalBytes}_=_\N{0};}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\C{}//_Num\_threads_taken_from_command_line\CE{}}}
\L{\LB{}\Tab{8}{\K{int}_\V{num\_threads}_=_\V{atoi}(\V{argv}[\N{1}]);}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Handles_for_threads\CE{}}}
\L{\LB{}\Tab{8}{\V{HANDLE}_\V{hThread}[\N{100}];}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_All_the_filenames\CE{}}}
\L{\LB{}\Tab{8}{\V{string}_\V{fileNames}[\N{21}];}}
\L{\LB{}\Tab{8}{\V{fileNames}[\N{0}]_=_\S{}\3/cgi\-bin/Retrieve\_Doc?ftp\_site=ftp.rfc\-editor.org\&sub\_dir=internet\-drafts\&file=all\_id.txt\3\SE{};}}
\L{\LB{}\Tab{8}{\V{fileNames}[\N{1}]_=_\S{}\3/cgi\-bin/Retrieve\_Doc?ftp\_site=ftp.freebsd.org\&sub\_dir=pub/FreeBSD/updates\&file=README.TXT\3\SE{};}}
\L{\LB{}\Tab{8}{\V{fileNames}[\N{2}]_=_\S{}\3/cgi\-bin/Retrieve\_Doc?ftp\_site=ftp.microsoft.com\&sub\_dir=softlib\&file=readme.txt\3\SE{};}}
\L{\LB{}\Tab{8}{\V{fileNames}[\N{3}]_=_\S{}\3/cgi\-bin/Retrieve\_Doc?ftp\_site=ftp.purdue.edu\&sub\_dir=pub/gtap/book\&file=readme.txt\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{httpData}_*\V{passToFunction}[\N{100}];}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Initialize_WinSock\CE{}}}
\L{\LB{}\Tab{8}{\V{nRet}_=_\V{WSAStartup}(\V{wVersionRequested},_\&\V{wsaData});}}
\L{\LB{}\Tab{8}{\K{if}_(\V{nRet})}}
\L{\LB{}\Tab{8}{\{}}
\L{\LB{}\Tab{16}{\V{fprintf}(\V{stderr},\S{}\3\2nWSAStartup():_\%d\2n\3\SE{},_\V{nRet});}}
\L{\LB{}\Tab{16}{\V{WSACleanup}();}}
\L{\LB{}\Tab{16}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\C{}//\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_Check_WinSock_version\CE{}}}
\L{\LB{}\Tab{8}{\C{}//\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{wsaData}.\V{wVersion}_!=_\V{wVersionRequested})}}
\L{\LB{}\Tab{8}{\{}}
\L{\LB{}\Tab{16}{\V{fprintf}(\V{stderr},\S{}\3\2nWinSock_version_not_supported\2n\3\SE{});}}
\L{\LB{}\Tab{16}{\V{WSACleanup}();}}
\L{\LB{}\Tab{16}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_Set_\3stdout\3_to_binary_mode\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_so_that_redirection_will_work\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_for_.gif_and_.jpg_files\CE{}}}
\L{\LB{}\Tab{8}{\C{}//\CE{}}}
\L{\LB{}\Tab{8}{\V{\_setmode}(\V{\_fileno}(\V{stdout}),_\V{\_O\_BINARY});}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Build_common_information\CE{}}}
\L{\LB{}\Tab{8}{\V{SOCKADDR\_IN}_\V{saServer};}}
\L{\LB{}\Tab{8}{\V{BuildCommon}(\&\V{saServer});}}
\L{\LB{}\Tab{16}{}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Call_HTTPGetRequest()_as_a_separate_thread_to_do_the_send_and_receive\CE{}}}
\L{\LB{}\Tab{8}{\K{for}_(\K{int}_\V{i}=\N{0};_\V{i}\<\V{num\_threads};_\V{i}++)_}}
\L{\LB{}\Tab{8}{\{}}
\L{\LB{}\Tab{16}{\C{}//_Create_a_TCP/IP_stream_socket\CE{}}}
\L{\LB{}\Tab{16}{\V{Socket}_=_\V{socket}(\V{AF\_INET},_\V{SOCK\_STREAM},_\V{IPPROTO\_TCP});}}
\L{\LB{}\Tab{16}{\K{if}_(\V{Socket}_==_\V{INVALID\_SOCKET})}}
\L{\LB{}\Tab{24}{\V{ErrNotify}(\S{}\3socket()\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{else}_\{}}
\L{\LB{}\Tab{24}{\C{}//_Connect_the_socket\CE{}}}
\L{\LB{}\Tab{24}{\V{nRet}_=_\V{connect}(\V{Socket},_(\V{LPSOCKADDR})\&\V{saServer},_\K{sizeof}(\V{SOCKADDR\_IN}));}}
\L{\LB{}\Tab{24}{\K{if}_(\V{nRet}_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{24}{\{}}
\L{\LB{}\Tab{32}{\V{ErrNotify}(\S{}\3connect()\3\SE{});}}
\L{\LB{}\Tab{32}{\V{closesocket}(\V{Socket});}}
\L{\LB{}\Tab{24}{\}}}
\L{\LB{}\Tab{24}{}}
\L{\LB{}\Tab{24}{\K{else}_\{}}
\L{\LB{}\Tab{32}{\C{}//_pass_arguments_to_function\CE{}}}
\L{\LB{}\Tab{32}{\V{passToFunction}[\V{i}]_=_\K{new}_\V{httpData};}}
\L{\LB{}\Tab{32}{\V{passToFunction}[\V{i}]\-\!\>\V{file}_=_\V{fileNames}[\V{i}\%\N{4}];}}
\L{\LB{}\Tab{32}{\V{passToFunction}[\V{i}]\-\!\>\V{socket}_=_\V{Socket};}}
\L{\LB{}}
\L{\LB{}\Tab{32}{\C{}//printf(\3Spawning_thread_\%d\2n\3,_i);\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{32}{\V{hThread}[\V{i}]_=_(\V{HANDLE})_\V{\_beginthread}((\K{void}_(*)(\K{void}_*))\V{HTTPGetRequest},_\N{0},_(\K{void}_*)\V{passToFunction}[\V{i}]);}}
\L{\LB{}\Tab{32}{\K{if}_(\V{hThread}[\V{i}]_\<_\N{0})_\{}}
\L{\LB{}\Tab{40}{\V{ErrNotify}(\S{}\3\_beginthread()\3\SE{});}}
\L{\LB{}\Tab{40}{\V{closesocket}(\V{Socket});}}
\L{\LB{}\Tab{32}{\}}}
\L{\LB{}\Tab{24}{\}}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//Flush_buffers\CE{}}}
\L{\LB{}\Tab{16}{\V{fflush}(\V{stdout});}}
\L{\LB{}\Tab{16}{\V{fflush}(\V{stderr});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//printf(\3Waiting.\,.\,._\%d\2n\3,_num\_threads);\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{DWORD}_\V{dwEvent};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//Wait_for_all_threads_to_terminate\CE{}}}
\L{\LB{}\Tab{8}{\K{while}(\V{num\_threads})_\{}}
\L{\LB{}\Tab{16}{\V{dwEvent}_=_\V{WaitForMultipleObjects}(\V{num\_threads},_\V{hThread},_\V{FALSE},_\V{INFINITE});}}
\L{\LB{}\Tab{16}{\K{for}(\K{int}_\V{i}=\V{dwEvent}+\N{1};_\V{i}\<\V{num\_threads};_\V{i}++)}}
\L{\LB{}\Tab{24}{\V{hThread}[\V{i}\-\N{1}]_=_\V{hThread}[\V{i}];}}
\L{\LB{}\Tab{16}{\V{num\_threads}\-\-;}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{printf}(\S{}\3Closing.\,.\,._total_bytes_received:_\%f\2n\3\SE{},_\V{totalBytes}/\N{1024.0});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{WSACleanup}();}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}////////////////////////////////////////////////////////////\CE{}}}
\L{\LB{}}
\L{\LB{}}
\index{BuildCommon}\Proc{BuildCommon}\L{\LB{\K{void}_\V{BuildCommon}(\V{SOCKADDR\_IN}_*\V{psaServer})}}
\L{\LB{\{}}
\L{\LB{}\Tab{8}{\C{}//\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_Use_inet\_addr()_to_determine_if_we{'}re_dealing_with_a_name\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_or_an_address\CE{}}}
\L{\LB{}\Tab{8}{\C{}//\CE{}}}
\L{\LB{}\Tab{8}{\V{IN\_ADDR}}\Tab{24}{\V{iaHost};}}
\L{\LB{}\Tab{8}{\V{LPHOSTENT}}\Tab{24}{\V{lpHostEntry};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//char_lpServerName[100];\CE{}}}
\L{\LB{}\Tab{8}{\C{}//char_lpFileName[100];\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//strcpy(lpServerName,_p-\!\>serverName);\CE{}}}
\L{\LB{}\Tab{8}{\C{}//strcpy(lpServerName,_\3localhost\3);\CE{}}}
\L{\LB{}\Tab{8}{\C{}//strcpy(lpFileName,_p-\!\>fileName);\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{char}_*\V{lpServerName}_=_\S{}\3localhost\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{iaHost}.\V{s\_addr}_=_\V{inet\_addr}(\V{lpServerName});}}
\L{\LB{}\Tab{8}{\K{if}_(\V{iaHost}.\V{s\_addr}_==_\V{INADDR\_NONE})}}
\L{\LB{}\Tab{8}{\{}}
\L{\LB{}\Tab{16}{\C{}//_Wasn{'}t_an_IP_address_string,_assume_it_is_a_name\CE{}}}
\L{\LB{}\Tab{16}{\V{lpHostEntry}_=_\V{gethostbyname}(\V{lpServerName});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{else}}}
\L{\LB{}\Tab{8}{\{}}
\L{\LB{}\Tab{16}{\C{}//_It_was_a_valid_IP_address_string\CE{}}}
\L{\LB{}\Tab{16}{\V{lpHostEntry}_=_\V{gethostbyaddr}((\K{const}_\K{char}_*)\&\V{iaHost},_}}
\L{\LB{}\Tab{48}{\K{sizeof}(\K{struct}_\V{in\_addr}),_\V{AF\_INET});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{lpHostEntry}_==_\V{NULL})}}
\L{\LB{}\Tab{8}{\{}}
\L{\LB{}\Tab{16}{\V{ErrNotify}(\S{}\3gethostbyname()\3\SE{});}}
\L{\LB{}\Tab{16}{\K{return};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_Find_the_port_number_for_the_HTTP_service_on_TCP\CE{}}}
\L{\LB{}\Tab{8}{\C{}//\CE{}}}
\L{\LB{}\Tab{8}{\V{LPSERVENT}_\V{lpServEnt};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{lpServEnt}_=_\V{getservbyname}(\S{}\3http\3\SE{},_\S{}\3tcp\3\SE{});}}
\L{\LB{}\Tab{8}{\K{if}_(\V{lpServEnt}_==_\V{NULL})}}
\L{\LB{}\Tab{16}{\V{psaServer}\-\!\>\V{sin\_port}_=_\V{htons}(\N{80});}}
\L{\LB{}\Tab{8}{\K{else}}}
\L{\LB{}\Tab{16}{\V{psaServer}\-\!\>\V{sin\_port}_=_\V{lpServEnt}\-\!\>\V{s\_port};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_Fill_in_the_rest_of_the_server_address_structure\CE{}}}
\L{\LB{}\Tab{8}{\C{}//\CE{}}}
\L{\LB{}\Tab{8}{\V{psaServer}\-\!\>\V{sin\_family}_=_\V{AF\_INET};}}
\L{\LB{}\Tab{8}{\V{psaServer}\-\!\>\V{sin\_addr}_=_*((\V{LPIN\_ADDR})*\V{lpHostEntry}\-\!\>\V{h\_addr\_list});}}
\L{\LB{}}
\L{\LB{_}\Tab{8}{\C{}//\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_Format_the_HTTP_request\CE{}}}
\L{\LB{}\Tab{8}{\C{}//\CE{}}}
\L{\LB{}}
\L{\LB{\C{}/*_Standard_HTTP_header_as_produced_by_IE_6.0_can_be_used_optionally*/\CE{}}}
\L{\LB{\C{}/*_Client_appends_this_header_by_default_*/\CE{}}}
\L{\LB{}}
\L{\LB{\C{}//\#ifdef_USE\_HTTP\_HEADER\CE{}}}
\L{\LB{\C{}//char_*http\_header_=_\3HTTP/1.1\2r\2n\2\CE{}}}
\L{\LB{\C{}//Accept:_image/gif,_image/x-xbitmap,_image/jpeg,_image/pjpeg,_application/vnd.ms-powerpoint,_application/vnd.ms-excel,_application/msword,_*/*\2r\2n\2\CE{}}}
\L{\LB{\C{}//Accept-Language:_en-us\2r\2n\2\CE{}}}
\L{\LB{\C{}//Accept-Encoding:_gzip,_deflate\2r\2n\2\CE{}}}
\L{\LB{\C{}//User-Agent:_Mozilla/4.0_(compatible;_MSIE_6.0;_Windows_NT_5.0)\2r\2n\2\CE{}}}
\L{\LB{\C{}//Host:_localhost\2r\2n\2\CE{}}}
\L{\LB{\C{}//Connection:_Close\2r\2n\2r\2n\3;\CE{}}}
\L{\LB{\C{}//\#endif_//USE\_HTTP\_HEADER\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//sprintf(szRequestBuffer,_\3GET_\%s_\%s\3,_lpFileName,_http\_header);\CE{}}}
\L{\LB{}\Tab{8}{\C{}//sprintf(szRequestBuffer,_\3\%s\3,_http\_header);\CE{}}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}////////////////////////////////////////////////////////////\CE{}}}
\L{\LB{}}
\L{\LB{}}
\index{HTTPGetRequest}\Proc{HTTPGetRequest}\L{\LB{\K{void}_\V{HTTPGetRequest}(\K{struct}_\V{httpData}_*\V{data})}}
\L{\LB{\{}}
\L{\LB{}\Tab{8}{\V{SOCKET}_\V{Socket}_=_\V{data}\-\!\>\V{socket};}}
\L{\LB{}\Tab{8}{\K{char}_\V{szRequestBuffer}[\N{1024}];}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//printf(\3Using_socket_\%d,_getting_file_\%s\2n\3,_Socket,_data-\!\>file.c\_str());\CE{}}}
\L{\LB{}}
\L{\LB{\K{\#ifdef}_\V{USE\_HTTP\_HEADER}}}
\L{\LB{\K{char}_*\V{http\_header}_=_\S{}\3HTTP/1.1\2r\2n\2}}
\L{\LB{Accept:_image/gif,_image/x\-xbitmap,_image/jpeg,_image/pjpeg,_application/vnd.ms\-powerpoint,_application/vnd.ms\-excel,_application/msword,_*/*\2r\2n\2}}
\L{\LB{Accept\-Language:_en\-us\2r\2n\2}}
\L{\LB{Accept\-Encoding:_gzip,_deflate\2r\2n\2}}
\L{\LB{User\-Agent:_Mozilla/4.0_(compatible;_MSIE_6.0;_Windows_NT_5.0)\2r\2n\2}}
\L{\LB{Host:_localhost\2r\2n\2}}
\L{\LB{Connection:_Close\2r\2n\2r\2n\3\SE{};}}
\L{\LB{\K{\#endif}_\C{}//USE\_HTTP\_HEADER\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{sprintf}(\V{szRequestBuffer},_\S{}\3GET_\%s_\%s\3\SE{},_\V{data}\-\!\>\V{file}.\V{c\_str}(),_\V{http\_header});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{char}_\V{szBuffer}[\N{1024}];}}
\L{\LB{}\Tab{8}{\K{int}}\Tab{13}{\V{nRet};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{nRet}_=_\V{send}(\V{Socket},_\V{szRequestBuffer},_\V{strlen}(\V{szRequestBuffer}),_\N{0});}}
\L{\LB{}\Tab{8}{\K{if}_(\V{nRet}_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{8}{\{}}
\L{\LB{}\Tab{16}{\V{ErrNotify}(\S{}\3send()\3\SE{});}}
\L{\LB{}\Tab{16}{\V{closesocket}(\V{Socket});}}
\L{\LB{}\Tab{16}{\K{return};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{printf}(\S{}\3GET_\%s_sent\2n\3\SE{},_\V{data}\-\!\>\V{file}.\V{c\_str}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_Receive_the_file_contents_and_print_to_stdout\CE{}}}
\L{\LB{}\Tab{8}{\C{}//\CE{}}}
\L{\LB{}\Tab{8}{\K{while}(\N{1})}}
\L{\LB{}\Tab{8}{\{}}
\L{\LB{}\Tab{16}{\C{}//_Wait_to_receive,_nRet_=_NumberOfBytesReceived\CE{}}}
\L{\LB{}\Tab{16}{\V{nRet}_=_\V{recv}(\V{Socket},_\V{szBuffer},_\K{sizeof}(\V{szBuffer}),_\N{0});}}
\L{\LB{}\Tab{16}{\K{if}_(\V{nRet}_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{16}{\{}}
\L{\LB{}\Tab{24}{\V{printf}(\S{}\3\%s_\%d_\3\SE{},_\V{data}\-\!\>\V{file}.\V{c\_str}(),_\V{Socket});}}
\L{\LB{}\Tab{24}{\V{ErrNotify}(\S{}\3recv()\3\SE{});}}
\L{\LB{}\Tab{24}{\K{break};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{16}{\V{totalBytes}_+=_\V{nRet};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//This_fprintf_statement_may_be_disabled_if_you_wish_not_to\CE{}}}
\L{\LB{}\Tab{16}{\C{}//observe_how_many_bytes_are_being_received\CE{}}}
\L{\LB{}}
\L{\LB{\C{}//\#ifdef_DISPLAY\_RECV\_STATUS\CE{}}}
\L{\LB{}\Tab{16}{\C{}//fprintf(stderr,\3\2nrecv()_returned_\%d_bytes\3,_nRet);\CE{}}}
\L{\LB{\C{}//\#endif_/*DISPLAY\_RECV\_STATUS*/\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Did_the_server_close_the_connection?\CE{}}}
\L{\LB{}\Tab{16}{\K{if}_(\V{nRet}_==_\N{0})}}
\L{\LB{}\Tab{24}{\K{break};}}
\L{\LB{}\Tab{16}{\C{}//_Write_to_stdout\CE{}}}
\L{\LB{}\Tab{8}{\C{}//fwrite(szBuffer,_nRet,_1,_stdout);\CE{}}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\V{printf}(\S{}\3Got_file_\%s\2n\3\SE{},_\V{data}\-\!\>\V{file}.\V{c\_str}());}}
\L{\LB{}\Tab{8}{\V{closesocket}(\V{Socket});}\Tab{32}{}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{\_endthread}();}}
\L{\LB{\}}}
