% Remember to use the lgrind style

\Head{}
\File{httpasync.cpp}{2004}{11}{5}{16:44}{22976}
\L{\LB{\C{}/*}}
\L{\LB{}}
\L{\LB{}\Tab{2}{(almost)_HTTP/1.1_server}}
\L{\LB{}\Tab{2}{Alpha_Chen}}
\L{\LB{}}
\L{\LB{}\Tab{2}{2004-10-25}}
\L{\LB{}\Tab{8}{MasterSocket}}
\L{\LB{}}
\L{\LB{*/\CE{}}}
\L{\LB{}}
\L{\LB{\K{\#ifdef}_\V{\_MSC\_VER}}}
\L{\LB{\K{\#pragma}_\V{warning}(_\V{disable:}_\N{4786}_)}}
\L{\LB{\K{\#endif}}}
\L{\LB{}}
\L{\LB{\K{\#include}_\<\V{stdio}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{winsock2}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{io}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{fcntl}.\V{h}\>}}
\L{\LB{}}
\L{\LB{\K{\#include}_\<\V{iostream}\>}}
\L{\LB{\K{\#include}_\<\V{string}\>}}
\L{\LB{\K{\#include}_\<\V{map}\>}}
\L{\LB{\K{\#include}_\<\V{algorithm}\>}}
\L{\LB{}}
\L{\LB{\K{using}_\K{namespace}_\V{std};}}
\L{\LB{}}
\L{\LB{\C{}//_Constants\CE{}}}
\L{\LB{\K{\#define}_\V{WSVERS}}\Tab{20}{\V{MAKEWORD}(\N{2},\N{2})}}
\L{\LB{\K{\#define}_\V{BUFSIZE}}\Tab{20}{\N{4096}}}
\L{\LB{\K{\#define}_\V{MAXSOCKS}}\Tab{24}{\N{60}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}//_Macro_to_test_if_bit_marked_by_b_is_set_in_v\CE{}}}
\L{\LB{\K{\#define}_\V{BITSET}(\V{v},\V{b})}\Tab{24}{(\V{b}_\&_\V{v})}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}//_Request_information\CE{}}}
\L{\LB{\K{struct}_\V{httpStats}_\{}}
\L{\LB{}\Tab{8}{\V{string}_\V{request};}\Tab{48}{\C{}//_request_from_client\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{string}_\V{path};}\Tab{48}{\C{}//_path_to_file/directory\CE{}}}
\L{\LB{}\Tab{8}{\K{int}_\V{keepAlive};}\Tab{48}{}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{int}_\V{fileFlag};}}
\L{\LB{}\Tab{8}{\K{long}_\V{sendPos};}}
\L{\LB{}\Tab{8}{\V{string}_\V{response};}}
\L{\LB{\};}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}//_Function_prototypes\CE{}}}
\L{\LB{\V{u\_short}}\Tab{8}{\V{MasterSocket}();}}
\L{\LB{\K{int}}\Tab{16}{\V{AcceptConnection}(\K{int},_\K{int});}}
\L{\LB{\K{int}}\Tab{16}{\V{CloseConnection}(\K{int},_\K{int});}}
\L{\LB{}}
\L{\LB{\K{int}}\Tab{16}{\V{RecvData}(\K{int},_\K{int});}}
\L{\LB{\K{int}}\Tab{16}{\V{httpServer}(\K{int});}}
\L{\LB{\K{int}}\Tab{16}{\V{parseRequest}(\V{httpStats}_*);}}
\L{\LB{\K{int}}\Tab{16}{\V{parseRequestLine}(\V{string},_\V{httpStats}_*);}}
\L{\LB{\V{string}}\Tab{8}{\V{fixPath}(\V{string});}}
\L{\LB{\K{void}}\Tab{8}{\V{makeResponse}(\V{httpStats}_*);}}
\L{\LB{\V{string}}\Tab{8}{\V{pathExtension}(\V{string});}}
\L{\LB{\K{int}}\Tab{16}{\V{fileExistsP}(\V{httpStats}_*);}}
\L{\LB{}}
\L{\LB{\K{int}}\Tab{16}{\V{SendData}(\K{int},_\K{int});}}
\L{\LB{\K{int}}\Tab{16}{\V{sendString}(\K{int},_\V{string});}}
\L{\LB{\K{int}}\Tab{16}{\V{sendString}(\K{int},_\K{char}_*,_\K{int});}}
\L{\LB{}}
\L{\LB{\K{void}}\Tab{8}{\V{errexit}(\K{const}_\K{char}_*,_.\,.\,.);}}
\L{\LB{\K{void}}\Tab{8}{\V{DisplayEvents}(\K{long},_\K{int});}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}//_State_definitions_for_client_connections\CE{}}}
\L{\LB{\K{\#define}_\V{ST\_READING}_\N{1}}\Tab{40}{\C{}//_awaiting_a_read\CE{}}}
\L{\LB{\K{\#define}_\V{ST\_WRITING}_\N{2}}\Tab{40}{\C{}//_awaiting_a_write,_client_still_sending\CE{}}}
\L{\LB{\K{\#define}_\V{ST\_CLOSING}_\N{3}}\Tab{40}{\C{}//_awaiting_a_write,_client_closed_connection\CE{}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}//_Per_socket_information\CE{}}}
\L{\LB{\K{struct}_\V{info}_\{}}
\L{\LB{}\Tab{8}{\V{SOCKET}_\V{sock};}\Tab{48}{\C{}//_associated_socket_(master_socket_too)\CE{}}}
\L{\LB{}\Tab{8}{\K{int}}\Tab{16}{\V{state};}\Tab{56}{\C{}//_connection_state\CE{}}}
\L{\LB{}\Tab{8}{\K{char}_\V{buf}[\V{BUFSIZE}];}\Tab{48}{\C{}//_data_buffer\CE{}}}
\L{\LB{}\Tab{8}{\K{char}_*_\V{bufptr};}\Tab{48}{\C{}//_buffer_pointer\CE{}}}
\L{\LB{}\Tab{8}{\K{int}_\V{buflen};}\Tab{56}{\C{}//_bytes_in_buffer\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{int}_\V{closedConnection};}\Tab{40}{\C{}//_flag_to_see_whether_connection_has_been_closed_or_not\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{httpStats}_*\V{requestStats};}\Tab{40}{\C{}//_data_for_each_request\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{LARGE\_INTEGER}_\V{startTime};}\Tab{40}{\C{}//_time_the_server_finishes_getting_the_client_request\CE{}}}
\L{\LB{}\Tab{8}{\V{LARGE\_INTEGER}_\V{stopTime};}\Tab{40}{\C{}//_time_the_server_finishes_servicing_the_client\CE{}}}
\L{\LB{\};}}
\L{\LB{}}
\L{\LB{\V{LARGE\_INTEGER}_\V{freq};}\Tab{48}{\C{}//_frequency_for_benchmarking\CE{}}}
\L{\LB{\K{double}_\V{totalTime};}\Tab{48}{\C{}//\CE{}}}
\L{\LB{\K{double}_\V{totalRequests};}\Tab{40}{\C{}//\CE{}}}
\L{\LB{}}
\L{\LB{\K{struct}_\V{info}_*_\V{Socks}[\V{MAXSOCKS}];}\Tab{32}{\C{}//_array_of_info_structure_pointers\CE{}}}
\L{\LB{\V{WSAEVENT}_\V{Events}[\V{MAXSOCKS}];}\Tab{40}{\C{}//_array_of_event_handles\CE{}}}
\L{\LB{\K{int}_\V{NumSocks};}\Tab{48}{\C{}//_number_of_active_event_handles_and_sockets\CE{}}}
\L{\LB{\V{map}\<\V{string},_\V{string}\>_\V{contentTypes};}\Tab{40}{\C{}//_content_type_map_for_server_response\CE{}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}////////////////////\CE{}}}
\L{\LB{\C{}//_Main_procedure\CE{}}}
\L{\LB{}}
\index{main}\Proc{main}\L{\LB{\K{void}_\V{main}(\K{int}_\V{argc},_\K{char}_*\V{argv}[\,])}}
\L{\LB{\{}}
\L{\LB{}\Tab{8}{\V{u\_short}}\Tab{40}{\V{port};}\Tab{72}{\C{}//_port\CE{}}}
\L{\LB{}\Tab{8}{\K{int}}\Tab{48}{\V{SigEvent};}\Tab{80}{\C{}//_signaled_event_index\CE{}}}
\L{\LB{}\Tab{8}{\K{int}}\Tab{48}{\V{closedConnection};}\Tab{72}{\C{}//\CE{}}}
\L{\LB{}\Tab{8}{\V{WSANETWORKEVENTS}}\Tab{32}{\V{NetEvents};}\Tab{64}{\C{}//_structure_for_network_event_information\CE{}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Create_master_socket_and_set_for_asynchronous_event_notification.\CE{}}}
\L{\LB{}\Tab{8}{\V{port}_=_\V{MasterSocket}();}}
\L{\LB{}\Tab{8}{\V{printf}(\S{}\3Asynchronous_HTTP_server_listening_on_port_\%d\2n\3\SE{},_\V{port});}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\C{}//_Set_up_Content-Type_map\CE{}}}
\L{\LB{}\Tab{8}{\V{contentTypes}[\S{}\3html\3\SE{}]}\Tab{32}{=_\S{}\3text/html\3\SE{};}}
\L{\LB{}\Tab{8}{\V{contentTypes}[\S{}\3htm\3\SE{}]}\Tab{40}{=_\S{}\3text/html\3\SE{};}}
\L{\LB{}\Tab{8}{\V{contentTypes}[\S{}\3txt\3\SE{}]}\Tab{40}{=_\S{}\3text/plain\3\SE{};}}
\L{\LB{}\Tab{8}{\V{contentTypes}[\S{}\3jpeg\3\SE{}]}\Tab{32}{=_\S{}\3image/jpeg\3\SE{};}}
\L{\LB{}\Tab{8}{\V{contentTypes}[\S{}\3jpg\3\SE{}]}\Tab{40}{=_\S{}\3image/jpeg\3\SE{};}}
\L{\LB{}\Tab{8}{\V{contentTypes}[\S{}\3gif\3\SE{}]}\Tab{40}{=_\S{}\3image/gif\3\SE{};}}
\L{\LB{}\Tab{8}{\V{contentTypes}[\S{}\3pdf\3\SE{}]}\Tab{40}{=_\S{}\3application/pdf\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Set_up_statistics\CE{}}}
\L{\LB{}\Tab{8}{\V{QueryPerformanceFrequency}(\&\V{freq});}}
\L{\LB{}\Tab{8}{\V{totalTime}_=_\N{0};}}
\L{\LB{}\Tab{8}{\V{totalRequests}_=_\N{0};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Infinite_server_loop_follows.\CE{}}}
\L{\LB{}\Tab{8}{\K{while}_(\N{1})_\{}}
\L{\LB{}\Tab{16}{\V{closedConnection}_=_\N{0};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Wait_for_any_event_to_be_signalled.\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_For_the_master_socket,_this_can_only_be_triggered_by_ACCEPT.\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_For_a_slave_socket,_this_can_be_triggered_by_READ,_WRITE_or_CLOSE.\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_This_call_will_block_as_long_as_needed_for_signal_to_occur.\CE{}}}
\L{\LB{}\Tab{16}{\K{if}((\V{SigEvent}_=_\V{WSAWaitForMultipleEvents}(\V{NumSocks},_\V{Events},_\V{FALSE},_\V{WSA\_INFINITE},_\V{TRUE}))_==_\V{WSA\_WAIT\_FAILED})}}
\L{\LB{}\Tab{24}{\V{errexit}(\S{}\3Wait_for_event_failed:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_One_socket,_indicated_by_SigEvent,_has_been_signalled_for_one_of\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_the_event_types.}\Tab{37}{The_following_call_determines_the_event_type_or_types.\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_See_WSAEnumNetworkEvents()_document_for_a_description_of_the_NetEvents\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_structure.\CE{}}}
\L{\LB{}\Tab{16}{\K{if}(\V{WSAEnumNetworkEvents}(\V{Socks}[\V{SigEvent}]\-\!\>\V{sock},_\V{Events}[\V{SigEvent}],_\&\V{NetEvents})_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{24}{\V{errexit}(\S{}\3Enumeration_of_network_events_failed:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_The_following_call_is_for_illustrative_purposes_only.}\Tab{74}{It_displays\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_the_event_types_that_are_ready.\CE{}}}
\L{\LB{}\Tab{16}{\C{}//DisplayEvents(NetEvents.lNetworkEvents,_SigEvent);\CE{}}}
\L{\LB{}\Tab{16}{}}
\L{\LB{}\Tab{16}{\C{}//_Check_for_accepted_connection.}\Tab{51}{This_will_only_occur_for_master_socket.\CE{}}}
\L{\LB{}\Tab{16}{\K{if}_(\V{BITSET}(\V{NetEvents}.\V{lNetworkEvents},\V{FD\_ACCEPT}))}}
\L{\LB{}\Tab{24}{\V{closedConnection}_=_\V{AcceptConnection}(\V{SigEvent},_\V{NetEvents}.\V{iErrorCode}[\V{FD\_ACCEPT\_BIT}]);}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Check_for_data_ready_to_be_received.}\Tab{57}{This_will_only_occur_for_a\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_slave_socket.}\Tab{34}{Note_that_this_event_type_will_be_signalled_when_data\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_is_available_to_be_received.}\Tab{49}{It_will_be_retriggered_anytime_new\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_data_arrives_after_a_receive_is_executed_or_if_the_receive_does_not\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_read_all_available_data.\CE{}}}
\L{\LB{}\Tab{16}{\K{if}(!\V{closedConnection}_\&\&_\V{BITSET}(\V{NetEvents}.\V{lNetworkEvents},\V{FD\_READ}))}}
\L{\LB{}\Tab{24}{\V{closedConnection}_=_\V{RecvData}(\V{SigEvent},_\V{NetEvents}.\V{iErrorCode}[\V{FD\_READ\_BIT}]);}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Check_for_data_ready_to_be_sent.}\Tab{53}{This_will_occur_only_for_a_slave\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_socket.}\Tab{28}{Note_that_this_event_type_is_signalled_after_a_connection\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_is_first_accepted_and,_after_that,_only_if_a_send_blocks.}\Tab{78}{So,\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_data_is_sent_in_the_RecvData()_routine_and_the_ST\_WRITING_state_is\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_entered_only_if_a_send_blocks.\CE{}}}
\L{\LB{}\Tab{16}{\K{if}(!\V{closedConnection}_\&\&_\V{BITSET}(\V{NetEvents}.\V{lNetworkEvents},\V{FD\_WRITE}))}}
\L{\LB{}\Tab{24}{\V{closedConnection}_=_\V{SendData}(\V{SigEvent},_\V{NetEvents}.\V{iErrorCode}[\V{FD\_READ\_BIT}]);}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Check_for_client_closing_connection.}\Tab{57}{This_will_only_occur_for_a\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_slave_socket.}\Tab{34}{Note_that_this_event_type_occurs_if_the_client\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_closes_or_shuts_down_their_socket.}\Tab{55}{CloseConnection()_will_close\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_the_connection_from_the_server_side_only_if_not_in_the_ST\_WRITING\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_state_(i.e.,_only_if_there_is_no_more_data_to_write_to_the_client).\CE{}}}
\L{\LB{}\Tab{16}{\K{if}(!\V{closedConnection}_\&\&_\V{BITSET}(\V{NetEvents}.\V{lNetworkEvents},\V{FD\_CLOSE}))}}
\L{\LB{}\Tab{24}{\V{CloseConnection}(\V{SigEvent},_\V{NetEvents}.\V{iErrorCode}[\V{FD\_READ\_BIT}]);}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{\}_\C{}//_main()\CE{}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}////////////////////////////////////////////////////////\CE{}}}
\L{\LB{\C{}//_Create_master_socket_for_event-driven_notification\CE{}}}
\L{\LB{}}
\index{MasterSocket}\Proc{MasterSocket}\L{\LB{\V{u\_short}_\V{MasterSocket}()}}
\L{\LB{\{}}
\L{\LB{}\Tab{8}{\V{WSADATA}}\Tab{16}{\V{wsadata};}\Tab{48}{\C{}//_sockets_startup_data\CE{}}}
\L{\LB{}\Tab{8}{\K{struct}_\V{sockaddr\_in}_\V{sin};}\Tab{40}{\C{}//_an_Internet_endpoint_address\CE{}}}
\L{\LB{}\Tab{8}{\V{SOCKET}_\V{temp\_sock};}\Tab{48}{\C{}//_temporary_socket_value\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Start_WinSock_(standard_call).\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{WSAStartup}(\V{WSVERS},_\&\V{wsadata})_!=_\N{0})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3WSAStartup_failed\2n\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{4}{\C{}//_Allocate_a_socket_(standard_call).\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_((\V{temp\_sock}_=_\V{socket}(\V{PF\_INET},_\V{SOCK\_STREAM},_\N{0}))_==_\V{INVALID\_SOCKET})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3Error_creating_socket:_\%d\2n\3\SE{},_\V{GetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Create_event_object_to_be_set_by_asychronous_events.\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_Note_that_master_socket_is_entry_0_in_Events[\,]_and_Socks[\,]_arrays.\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_((\V{Events}[\N{0}]_=_\V{WSACreateEvent}())_==_\V{WSA\_INVALID\_EVENT})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3Error_creating_event_object:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\C{}//_Make_socket_non-blocking_with_asynchronous_event_notification_for_ACCEPT.\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_This_call_associates_the_event_handle_created_above_with_the_master_socket.\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_Master_socket_will_be_\3signaled\3_when_call_to_accept()_will_not_block.\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{WSAEventSelect}(\V{temp\_sock},_\V{Events}[\N{0}],_\V{FD\_ACCEPT})_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3Error_initiating_asynchronous_event_notification:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Initialize_info_structure_for_master_socket.\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_Again,_note_that_master_socket_is_entry_0_in_Socks[\,]_array.\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_((\V{Socks}[\N{0}]_=_(\K{struct}_\V{info}_*)_\V{malloc}(\K{sizeof}(\K{struct}_\V{info})))_==_\V{NULL})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3Memory_alloation_error\2n\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{Socks}[\N{0}]\-\!\>\V{sock}_=_\V{temp\_sock};}}
\L{\LB{}\Tab{8}{\V{NumSocks}_=_\N{1};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Create_address_for_master_socket_(standard_code).\CE{}}}
\L{\LB{}\Tab{8}{\V{memset}(\&\V{sin},_\N{0},_\K{sizeof}(\V{sin}));}}
\L{\LB{}\Tab{8}{\V{sin}.\V{sin\_family}_=_\V{AF\_INET};}}
\L{\LB{}\Tab{8}{\V{sin}.\V{sin\_addr}.\V{s\_addr}_=_\V{INADDR\_ANY};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}_((\V{sin}.\V{sin\_port}_=_\V{htons}(\N{80}))_==_\N{0})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3Can{'}t_get_service_entry\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Bind_address_to_the_socket_(standard_call).\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{bind}(\V{temp\_sock},_(\K{struct}_\V{sockaddr}_*)\&\V{sin},_\K{sizeof}(\V{sin}))_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3can{'}t_bind_to_port:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\C{}//_Make_socket_passive_(standard_call).\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(\V{listen}(\V{temp\_sock},_\N{5})_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3Error_listening_on_port:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}(\V{ntohs}(\V{sin}.\V{sin\_port}));}}
\L{\LB{}}
\L{\LB{\}_\C{}//_end_MasterSocket()\CE{}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}////////////////////////////////////////////////////////////\CE{}}}
\L{\LB{\C{}//_Accept_a_connection_(only_in_phantom_\3awaiting\3_state)\CE{}}}
\L{\LB{}}
\index{AcceptConnection}\Proc{AcceptConnection}\L{\LB{\K{int}_\V{AcceptConnection}(\K{int}_\V{EventNum},_\K{int}_\V{EventError})}}
\L{\LB{\{}}
\L{\LB{}\Tab{8}{\K{struct}_\V{sockaddr\_in}_\V{new\_sin};}\Tab{40}{\C{}//_client_address_for_accept\CE{}}}
\L{\LB{}\Tab{8}{\K{int}_\V{addrlen};}\Tab{48}{\C{}//_length_of_client_address\CE{}}}
\L{\LB{}\Tab{8}{\V{SOCKET}_\V{temp\_sock};}\Tab{48}{\C{}//_temporary_socket_descriptor\CE{}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Check_for_error_in_event_notification.\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{EventError}_!=_\N{0})_\{}}
\L{\LB{}\Tab{16}{\V{printf}(\S{}\3Accept_error:}\Tab{39}{\%d\2n\3\SE{},_\V{EventError});}}
\L{\LB{}\Tab{16}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Accept_the_connection_(standard_call).\CE{}}}
\L{\LB{}\Tab{8}{\V{addrlen}_=_\K{sizeof}(\V{new\_sin});}}
\L{\LB{}\Tab{8}{\K{if}_((\V{temp\_sock}_=_\V{accept}(\V{Socks}[\V{EventNum}]\-\!\>\V{sock},_(\K{struct}_\V{sockaddr}_*)_\&\V{new\_sin},_\&\V{addrlen}))_==_\V{INVALID\_SOCKET})_\{}}
\L{\LB{}\Tab{16}{\V{printf}(\S{}\3Accept_event_error:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}\Tab{16}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\C{}//_Check_if_new_connection_exceeds_server_capacity.}\Tab{61}{The_limit_is\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_due_to_Events[\,]_and_Socks[\,]_being_fixed-size_arrays.}\Tab{65}{An_excess\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_client_connection_is_simply_closed._\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{NumSocks}_\>=_\V{MAXSOCKS})_\{}}
\L{\LB{}\Tab{16}{\V{printf}(\S{}\3Too_many_connections_\-_aborting_new_connection\2n\3\SE{});}}
\L{\LB{}\Tab{16}{\V{closesocket}(\V{temp\_sock});}}
\L{\LB{}\Tab{16}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_The_client_connection_can_be_serviced.}\Tab{51}{Information_for_this_connection\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_is_saved_in_an_info_structure_pointed_to_by_an_entry_in_the_Socks[\,]\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_array.}\Tab{19}{Note_that_the_connection_starts_in_the_ST\_READING_state_since\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_data_is_first_to_be_read_from_an_ECHO_client.\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_((\V{Socks}[\V{NumSocks}]_=_(\K{struct}_\V{info}_*)_\V{malloc}(\K{sizeof}(\K{struct}_\V{info})))_==_\V{NULL})_\{}}
\L{\LB{}\Tab{16}{\V{printf}(\S{}\3Memory_alloation_error\2n\3\SE{});}}
\L{\LB{}\Tab{16}{\V{closesocket}(\V{temp\_sock});}}
\L{\LB{}\Tab{16}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\V{Socks}[\V{NumSocks}]\-\!\>\V{sock}_=_\V{temp\_sock};}}
\L{\LB{}\Tab{8}{\V{Socks}[\V{NumSocks}]\-\!\>\V{state}_=_\V{ST\_READING};}}
\L{\LB{}\Tab{8}{\V{Socks}[\V{NumSocks}]\-\!\>\V{bufptr}_=_\V{Socks}[\V{NumSocks}]\-\!\>\V{buf};}}
\L{\LB{}\Tab{8}{\V{Socks}[\V{NumSocks}]\-\!\>\V{buflen}_=_\N{0};}}
\L{\LB{}\Tab{8}{\V{Socks}[\V{NumSocks}]\-\!\>\V{requestStats}_=_\K{new}_\V{httpStats};}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Create_event_object_to_be_set_by_asychronous_events_for_new_socket.\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_Note_that_the_event_handle_is_in_the_same_location_in_Events[\,]_as\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_connection_information_is_in_Socks[\,].\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_((\V{Events}[\V{NumSocks}]_=_\V{WSACreateEvent}())_==_\V{WSA\_INVALID\_EVENT})_\{}}
\L{\LB{}\Tab{16}{\V{printf}(\S{}\3Error_creating_event_object:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}\Tab{16}{\V{closesocket}(\V{temp\_sock});}}
\L{\LB{}\Tab{16}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Make_socket_non-blocking_with_asynchronous_event_notification.}\Tab{75}{This\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_call_associates_the_event_handle_just_created_with_the_slave_socket\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_and_tells_WinSock_to_notify_for_READ_and_CLOSE_events.\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{WSAEventSelect}(\V{Socks}[\V{NumSocks}]\-\!\>\V{sock},_\V{Events}[\V{NumSocks}],_\V{FD\_READ}_\|_\V{FD\_CLOSE})_==_\V{SOCKET\_ERROR})_\{}}
\L{\LB{}\Tab{16}{\V{printf}(\S{}\3Error_initiating_asynchronous_event_notification:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}\Tab{16}{\V{closesocket}(\V{temp\_sock});}}
\L{\LB{}\Tab{16}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//printf(\3Status:_new_connection_accepted_(\%d)\2n\3,_NumSocks);\CE{}}}
\L{\LB{}\Tab{8}{++\V{NumSocks};}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{}}
\L{\LB{\}_\C{}//_end_AcceptConnection()\CE{}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}//////////////////////////////////////////////////////////\CE{}}}
\L{\LB{\C{}//_Receive_data_from_a_client_(only_in_\3reading\3_state)\CE{}}}
\L{\LB{}}
\index{RecvData}\Proc{RecvData}\L{\LB{\K{int}_\V{RecvData}(\K{int}_\V{EventNum},_\K{int}_\V{EventError})}}
\L{\LB{\{}}
\L{\LB{}\Tab{8}{\K{int}_\V{nbytes};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Check_for_error_in_event_notification.\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{EventError}_!=_\N{0})_\{}}
\L{\LB{}\Tab{16}{\V{printf}(\S{}\3Read_event_error:}\Tab{43}{\%d\2n\3\SE{},_\V{EventError});}}
\L{\LB{}\Tab{16}{\V{CloseConnection}(\V{EventNum},_\N{0});}}
\L{\LB{}\Tab{16}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Call_recv_as_long_as_there_is_data_left_to_receive_or_until_the\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_recv_would_block_or_encounters_another_error.\CE{}}}
\L{\LB{}\Tab{8}{\K{do}_\{}}
\L{\LB{}\Tab{16}{\V{nbytes}_=_\V{recv}(\V{Socks}[\V{EventNum}]\-\!\>\V{sock},_\V{Socks}[\V{EventNum}]\-\!\>\V{bufptr},_\V{BUFSIZE}\-\V{Socks}[\V{EventNum}]\-\!\>\V{buflen},_\N{0});}}
\L{\LB{}\Tab{16}{\K{if}(\V{nbytes}_\>_\N{0})_\{}}
\L{\LB{}\Tab{24}{\V{Socks}[\V{EventNum}]\-\!\>\V{bufptr}_+=_\V{nbytes};}}
\L{\LB{}\Tab{24}{\V{Socks}[\V{EventNum}]\-\!\>\V{buflen}_+=_\V{nbytes};}\Tab{72}{}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{8}{\}_\K{while}_(\V{nbytes}_!=_\N{0}_\&\&_\V{nbytes}_!=_\V{SOCKET\_ERROR}_\&\&_!\V{strstr}(\V{Socks}[\V{EventNum}]\-\!\>\V{buf},_\S{}\3\2r\2n\2r\2n\3\SE{}));}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{nbytes}_==_\V{SOCKET\_ERROR}_\&\&_\V{WSAGetLastError}()_==_\V{WSAEWOULDBLOCK})}}
\L{\LB{}\Tab{16}{\K{return}_\N{0};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{nbytes}_==_\V{SOCKET\_ERROR})_\{}}
\L{\LB{}\Tab{16}{\V{printf}(\S{}\3Read_error:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}\Tab{16}{\V{Socks}[\V{EventNum}]\-\!\>\V{state}_=_\V{ST\_CLOSING};}}
\L{\LB{}\Tab{16}{\V{CloseConnection}(\V{EventNum},_\N{0});}}
\L{\LB{}\Tab{16}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_\3end\3_the_string\CE{}}}
\L{\LB{}\Tab{8}{*\V{Socks}[\V{EventNum}]\-\!\>\V{bufptr}_=_\S{}{'}\20{'}\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Check_that_the_entire_header_has_been_sent\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(\V{strstr}(\V{Socks}[\V{EventNum}]\-\!\>\V{buf},_\S{}\3\2r\2n\2r\2n\3\SE{}))_\{}}
\L{\LB{}\Tab{16}{\C{}//cout\<\<Socks[EventNum]-\!\>buf\<\<endl;\CE{}}}
\L{\LB{}\Tab{16}{\C{}//Socks[EventNum]-\!\>startTime_=_GetTickCount();\CE{}}}
\L{\LB{}\Tab{16}{\V{QueryPerformanceCounter}(\&\V{Socks}[\V{EventNum}]\-\!\>\V{startTime});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{httpStats}_*\V{data}_=_\V{Socks}[\V{EventNum}]\-\!\>\V{requestStats};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Reset_info_about_request\CE{}}}
\L{\LB{}\Tab{16}{\V{data}\-\!\>\V{request}_=_\V{Socks}[\V{EventNum}]\-\!\>\V{buf};}}
\L{\LB{}\Tab{16}{\V{data}\-\!\>\V{response}_=_\S{}\3\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}(\V{parseRequest}(\V{data})_\&\&_!\V{data}\-\!\>\V{response}.\V{empty}())}}
\L{\LB{}\Tab{24}{\V{data}\-\!\>\V{response}_=_\S{}\3400_Bad_Request\3\SE{};}}
\L{\LB{}\Tab{16}{\C{}//cout\<\<\3\2\3GET_\3\<\<data-\!\>path\<\<\3\2\3_received.\3\<\<endl;\CE{}}}
\L{\LB{}\Tab{16}{\V{data}\-\!\>\V{fileFlag}_=_!\V{fileExistsP}(\V{data});}}
\L{\LB{}\Tab{16}{\V{makeResponse}(\V{data});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Send_response_to_client\CE{}}}
\L{\LB{}\Tab{16}{\V{data}\-\!\>\V{sendPos}_=_\N{0};}}
\L{\LB{}\Tab{16}{\K{if}(\V{SendData}(\V{EventNum},_\N{0}))}}
\L{\LB{}\Tab{24}{\K{return}_\-\N{1};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Reset_connection_info\CE{}}}
\L{\LB{}\Tab{16}{\V{Socks}[\V{EventNum}]\-\!\>\V{buf}[\N{0}]_=_\S{}{'}\20{'}\SE{};}}
\L{\LB{}\Tab{16}{\V{Socks}[\V{EventNum}]\-\!\>\V{bufptr}_=_\V{Socks}[\V{NumSocks}]\-\!\>\V{buf};}}
\L{\LB{}\Tab{16}{\V{Socks}[\V{EventNum}]\-\!\>\V{buflen}_=_\N{0};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{}}
\L{\LB{\}_\C{}//_end_RecvData()\CE{}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}/*}}
\L{\LB{}}
\L{\LB{}\Tab{2}{Parses_the_request_from_the_client_for_the_PATH,}}
\L{\LB{}\Tab{2}{CONNECTION,_and_HOST._If_the_request_is_malformed,}}
\L{\LB{}\Tab{2}{returns_1.}}
\L{\LB{}}
\L{\LB{*/\CE{}}}
\index{parseRequest}\Proc{parseRequest}\L{\LB{\K{int}_\V{parseRequest}(\V{httpStats}_*\V{requestStats})_\{}}
\L{\LB{}\Tab{8}{\V{string}_\V{request}_=_\V{requestStats}\-\!\>\V{request};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Find_the_end_of_the_request\CE{}}}
\L{\LB{}\Tab{8}{\K{int}_\V{end}_=_\V{request}.\V{find}(\S{}\3\2r\2n\2r\2n\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Find_the_end_of_the_request-line\CE{}}}
\L{\LB{}\Tab{8}{\K{int}_\V{i}_=_\V{request}.\V{find}(\S{}\3\2r\2n\3\SE{});}}
\L{\LB{}\Tab{8}{\K{if}(\V{i}_==_\V{string::npos})}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Parse_the_request-line\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(\V{parseRequestLine}(\V{request}.\V{substr}(\N{0},_\V{i}),_\V{requestStats}))}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{i}_==_\V{end})}}
\L{\LB{}\Tab{16}{\K{return}_\N{0};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{string}_\V{temp};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Iterate_through_remaining_lines_in_the_request\CE{}}}
\L{\LB{}\Tab{8}{\K{for}(\K{int}_\V{j}_=_\V{request}.\V{find}(\S{}\3\2r\2n\3\SE{},_\V{i}+\N{1});_\V{i}_!=_\V{end};_\V{j}_=_\V{request}.\V{find}(\S{}\3\2r\2n\3\SE{},_\V{i}+\N{1}))_\{}}
\L{\LB{}\Tab{16}{\V{temp}_=_\V{request}.\V{substr}(\V{i}+\N{2},\V{j}\-\V{i}\-\N{2});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Get_keep-alive;_this_will_override_the\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_keep-alive_set_by_the_protocol_type\CE{}}}
\L{\LB{}\Tab{16}{\K{if}(\V{temp}.\V{find}(\S{}\3Connection:_\3\SE{})_==_\N{0})_\{}}
\L{\LB{}\Tab{24}{\V{temp}_=_\V{temp}.\V{substr}(\N{12});}}
\L{\LB{}\Tab{24}{\V{transform}(\V{temp}.\V{begin}(),_\V{temp}.\V{end}(),_\V{temp}.\V{begin}(),_\V{ptr\_fun}(\V{::tolower}));}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\K{if}(\V{temp}_==_\S{}\3keep\-alive\3\SE{})}}
\L{\LB{}\Tab{32}{\V{requestStats}\-\!\>\V{keepAlive}_=_\N{1};}}
\L{\LB{}\Tab{24}{\K{else}_\K{if}(\V{temp}_==_\S{}\3close\3\SE{})}}
\L{\LB{}\Tab{32}{\V{requestStats}\-\!\>\V{keepAlive}_=_\N{0};}}
\L{\LB{}\Tab{24}{\K{else}}}
\L{\LB{}\Tab{32}{\K{return}_\N{1};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{i}_=_\V{j};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{\C{}/*}}
\L{\LB{}}
\L{\LB{}\Tab{2}{Parses_the_request_line_to_get_the_method,_path,_and_protocol.}}
\L{\LB{}}
\L{\LB{*/\CE{}}\Tab{8}{}}
\index{parseRequestLine}\Proc{parseRequestLine}\L{\LB{\K{int}_\V{parseRequestLine}(\V{string}_\V{requestLine},_\V{httpStats}_*\V{requestStats})_\{}}
\L{\LB{}\Tab{8}{\C{}//_Make_sure_the_method_is_GET\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(\V{requestLine}.\V{length}()_\<_\N{4}_\|\,\|_(\S{}\3GET_\3\SE{}_!=_\V{requestLine}.\V{substr}(\N{0},_\N{4})))_\{}}
\L{\LB{}\Tab{16}{\V{requestStats}\-\!\>\V{response}_=_\S{}\3501_Not_Implemented\3\SE{};}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Get_the_path\CE{}}}
\L{\LB{}\Tab{8}{\V{requestLine}_=_\V{requestLine}.\V{substr}(\N{4},_\V{requestLine}.\V{length}()\-\N{4});}}
\L{\LB{}\Tab{8}{\K{int}_\V{i}_=_\V{requestLine}.\V{find}(\S{}\3_\3\SE{});}}
\L{\LB{}\Tab{8}{\K{if}(\V{i}_==_\V{string::npos})}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{requestStats}\-\!\>\V{path}_=_\V{fixPath}(\V{requestLine}.\V{substr}(\N{0},_\V{i}));}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Get_keep-alive\CE{}}}
\L{\LB{}\Tab{8}{\V{requestLine}_=_\V{requestLine}.\V{substr}(\V{i}+\N{1});}}
\L{\LB{}\Tab{8}{\K{if}(\V{requestLine}_!=_\S{}\3HTTP/1.0\3\SE{}_\&\&_\V{requestLine}_!=_\S{}\3HTTP/1.1\3\SE{})}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{requestStats}\-\!\>\V{keepAlive}_=_(\V{requestLine}_==_\S{}\3HTTP/1.1\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{\C{}/*}}
\L{\LB{}}
\L{\LB{}\Tab{2}{Changes_all_instances_of_\%20_in_the_path_to_spaces.}}
\L{\LB{}}
\L{\LB{*/\CE{}}}
\index{fixPath}\Proc{fixPath}\L{\LB{\V{string}_\V{fixPath}(\V{string}_\V{path})_\{}}
\L{\LB{}\Tab{8}{\K{int}_\V{i};_\V{string}_\V{temp};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{while}((\V{i}_=_\V{path}.\V{find}(\S{}\3\%20\3\SE{}))_!=_\V{string::npos})_\{}}
\L{\LB{}\Tab{16}{\V{temp}_=_\V{path}.\V{substr}(\N{0},_\V{i})_+_\S{}\3_\3\SE{};}}
\L{\LB{}\Tab{16}{\V{path}_=_\V{temp}_+_\V{path}.\V{substr}(\V{i}+\N{3},\V{path}.\V{length}()\-\N{3}\-\V{i});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\V{path};}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{\C{}/*}}
\L{\LB{}}
\L{\LB{}\Tab{2}{Returns_0_if_the_file_exists_and_is_readable._If_not,}}
\L{\LB{}\Tab{2}{the_serverResponse_is_set_to_the_appropriate_response.}}
\L{\LB{}}
\L{\LB{*/\CE{}}}
\index{fileExistsP}\Proc{fileExistsP}\L{\LB{\K{int}_\V{fileExistsP}(\V{httpStats}_*\V{requestStats})_\{}}
\L{\LB{}\Tab{8}{\V{string}_\V{origPath}_=_\V{requestStats}\-\!\>\V{path},_\V{path}_=_\S{}\3c:/webfiles\3\SE{}_+_\V{origPath};}}
\L{\LB{}\Tab{8}{\V{requestStats}\-\!\>\V{path}_=_\V{path};}}
\L{\LB{}\Tab{8}{\K{int}_\V{fd}=_\V{\_open}(\V{path}.\V{c\_str}(),_\V{\_O\_RDONLY}_\|_\V{\_O\_BINARY});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Check_for_existence\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(\V{\_access}(\V{path}.\V{c\_str}(),_\N{0}))_\{}}
\L{\LB{}\Tab{16}{\V{requestStats}\-\!\>\V{response}_=_\S{}\3404_Not_Found\3\SE{};}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Check_for_readability\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(\V{\_access}(\V{path}.\V{c\_str}(),_\N{4}))_\{}}
\L{\LB{}\Tab{16}{\V{requestStats}\-\!\>\V{response}_=_\S{}\3500_Internal_Server_Error\3\SE{};}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Check_for_directory\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(\V{\_filelength}(\V{fd})_==_\-\N{1})_\{}}
\L{\LB{}\Tab{16}{\V{\_close}(\V{fd});}}
\L{\LB{}\Tab{16}{\K{if}(\V{path}[\V{path}.\V{length}()\-\N{1}]_!=_\S{}{'}/{'}\SE{})_\{}}
\L{\LB{}\Tab{24}{\V{requestStats}\-\!\>\V{response}_=_\S{}\3404_File_Not_Found\3\SE{};}}
\L{\LB{}\Tab{24}{\K{return}_\N{1};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_index.html\CE{}}}
\L{\LB{}\Tab{16}{\V{requestStats}\-\!\>\V{path}_=_\V{origPath}_+_\S{}\3index.html\3\SE{};}}
\L{\LB{}\Tab{16}{\K{if}(!\V{fileExistsP}(\V{requestStats}))}}
\L{\LB{}\Tab{24}{\K{return}_\N{0};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_index.htm\CE{}}}
\L{\LB{}\Tab{16}{\V{requestStats}\-\!\>\V{path}_=_\V{origPath}_=_\S{}\3index.htm\3\SE{};}}
\L{\LB{}\Tab{16}{\K{if}(!\V{fileExistsP}(\V{requestStats}))}}
\L{\LB{}\Tab{24}{\K{return}_\N{0};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{requestStats}\-\!\>\V{response}_=_\S{}\3500_Internal_Server_Error\3\SE{};}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{\_close}(\V{fd});}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{\C{}/*}}
\L{\LB{}}
\L{\LB{}\Tab{2}{Generate_the_status-lines_sent_by_the_server}}
\L{\LB{}}
\L{\LB{*/\CE{}}}
\index{makeResponse}\Proc{makeResponse}\L{\LB{\K{void}_\V{makeResponse}(\V{httpStats}_*\V{requestStats})_\{}}
\L{\LB{}\Tab{8}{\V{string}_\V{temp}_=_\S{}\3200_OK\3\SE{},_\V{html}_=_\S{}\3\3\SE{};}}
\L{\LB{}\Tab{8}{\K{char}_\V{intBuffer}[\K{sizeof}(\K{int})*\N{8}_+_\N{1}];}}
\L{\LB{}\Tab{8}{\K{long}_\V{length};}}
\L{\LB{}\Tab{8}{\V{string}_\V{contentType};}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\C{}//_If_the_serverResponse_has_already_been_set,\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_send_that_response_with_an_error_page\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(!\V{requestStats}\-\!\>\V{response}.\V{empty}())_\{}}
\L{\LB{}\Tab{16}{\V{temp}_=_\V{requestStats}\-\!\>\V{response};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Generate_a_small_error_page\CE{}}}
\L{\LB{}\Tab{16}{\V{html}_=_\S{}\3\<html\>\<head\>\<title\>\3\SE{}_+_\V{temp};}}
\L{\LB{}\Tab{16}{\V{html}_+=_\S{}\3\</title\</head\>\<body\>\3\SE{}_+_\V{temp};}}
\L{\LB{}\Tab{16}{\V{html}_+=_\S{}\3\<br_/\>\<pre\>\3\SE{}_+_\V{requestStats}\-\!\>\V{request};}}
\L{\LB{}\Tab{16}{\V{html}_+=_\S{}\3\</pre\>\</body\>\</html\>\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{length}_=_\V{html}.\V{length}();}}
\L{\LB{}\Tab{16}{\V{contentType}_=_\S{}\3text/html\3\SE{};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{else}_\{}}
\L{\LB{}\Tab{16}{\K{int}_\V{fd}_=_\V{\_open}(\V{requestStats}\-\!\>\V{path}.\V{c\_str}(),_\V{\_O\_RDONLY}_\|_\V{\_O\_BINARY});}}
\L{\LB{}\Tab{16}{\V{length}_=_\V{\_filelength}(\V{fd});}}
\L{\LB{}\Tab{16}{\V{\_close}(\V{fd});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{contentType}_=_\V{pathExtension}(\V{requestStats}\-\!\>\V{path});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Generate_the_actual_response;_note_that\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_the_html_goes_after_the_double_CRLF\CE{}}}
\L{\LB{}\Tab{8}{\V{temp}_=_\S{}\3HTTP/1.1_\3\SE{}_+_\V{temp}_+_\S{}\3\2r\2n\3\SE{};}}
\L{\LB{}\Tab{8}{\V{temp}_+=_\S{}\3Content\-Length:_\3\SE{};}}
\L{\LB{}\Tab{8}{\V{temp}_+=_\V{itoa}(\V{length},_\V{intBuffer},_\N{10});}}
\L{\LB{}\Tab{8}{\V{temp}_+=_\S{}\3\2r\2nContent\-Type:_\3\SE{}_+_\V{contentType};}}
\L{\LB{}\Tab{8}{\V{temp}_+=_\S{}\3\2r\2n\2r\2n\3\SE{}_+_\V{html};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{requestStats}\-\!\>\V{response}_=_\V{temp};}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{\C{}/*}}
\L{\LB{}}
\L{\LB{}\Tab{2}{Returns_the_content-type_of_a_file_from}}
\L{\LB{}\Tab{2}{the_filename{'}s_extension.}}
\L{\LB{*/\CE{}}}
\index{pathExtension}\Proc{pathExtension}\L{\LB{\V{string}_\V{pathExtension}(\V{string}_\V{path})_\{}}
\L{\LB{}\Tab{8}{\K{int}_\V{i}_=_\V{path}.\V{find\_last\_of}(\S{}\3.\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{i}_!=_\V{string::npos})_\{}}
\L{\LB{}\Tab{16}{\V{string}_\V{temp}_=_\V{path}.\V{substr}(\V{i}+\N{1},_\V{path}.\V{length}()\-\V{i}\-\N{1});}}
\L{\LB{}\Tab{16}{\V{transform}(\V{temp}.\V{begin}(),_\V{temp}.\V{end}(),_\V{temp}.\V{begin}(),_\V{ptr\_fun}(\V{::tolower}));}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Look_up_the_extension_in_the_map\CE{}}}
\L{\LB{}\Tab{16}{\K{if}(\V{contentTypes}.\V{find}(\V{temp})_!=_\V{contentTypes}.\V{end}())}}
\L{\LB{}\Tab{24}{\K{return}_\V{contentTypes}[\V{temp}];}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Default_content-type\CE{}}}
\L{\LB{}\Tab{8}{\K{return}_\S{}\3application/octet\-stream\3\SE{};}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}///////////////////////////////////////////////////////////////////////////////\CE{}}}
\L{\LB{\C{}//_Send_data_to_a_client_(from_state_(only_in_\3writing\3_or_\3closing\3_states)\CE{}}}
\L{\LB{}}
\index{SendData}\Proc{SendData}\L{\LB{\K{int}_\V{SendData}(\K{int}_\V{EventNum},_\K{int}_\V{EventError})}}
\L{\LB{\{}}
\L{\LB{}\Tab{8}{\K{int}_\V{temp}=\N{0};}\Tab{32}{\C{}//_number_of_bytes_sent\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Check_for_error_in_event_notification\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{EventError}_!=_\N{0})_\{}}
\L{\LB{}\Tab{16}{\V{printf}(\S{}\3Write_event_error:}\Tab{44}{\%d\2n\3\SE{},_\V{EventError});}}
\L{\LB{}\Tab{16}{\V{Socks}[\V{EventNum}]\-\!\>\V{state}_=_\V{ST\_CLOSING};}}
\L{\LB{}\Tab{16}{\V{CloseConnection}(\V{EventNum},_\N{0});}}
\L{\LB{}\Tab{16}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Send_response\CE{}}}
\L{\LB{}\Tab{8}{\V{httpStats}_*\V{data}_=_\V{Socks}[\V{EventNum}]\-\!\>\V{requestStats};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{data}\-\!\>\V{response}.\V{length}())_\{}}
\L{\LB{}\Tab{16}{\V{temp}_=_\V{sendString}(\V{EventNum},_\V{data}\-\!\>\V{response});}}
\L{\LB{}\Tab{16}{\K{if}(\V{temp}_\>_\N{0})}}
\L{\LB{}\Tab{24}{\V{data}\-\!\>\V{response}_=_\V{data}\-\!\>\V{response}.\V{substr}(\V{temp});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{if}(\V{temp}_\<_\N{0})}}
\L{\LB{}\Tab{16}{\K{return}_\V{temp};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{int}_\V{i}=\N{0},_\V{j}=\N{0};}}
\L{\LB{}\Tab{8}{\K{char}_\V{sendBuffer}[\N{4097}];}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Send_file\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(\V{data}\-\!\>\V{fileFlag})_\{}}
\L{\LB{}\Tab{16}{\K{int}_\V{fd}_=_\V{\_open}(\V{data}\-\!\>\V{path}.\V{c\_str}(),_\V{\_O\_RDONLY}_\|_\V{\_O\_BINARY});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{\_lseek}(\V{fd},_\V{data}\-\!\>\V{sendPos},_\N{0});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{while}((\V{i}_==_\V{j})_\&\&_\V{data}\-\!\>\V{sendPos}_!=_\V{\_filelength}(\V{fd})_\&\&_(\V{i}_=_\V{\_read}(\V{fd},_\V{sendBuffer},_\V{BUFSIZE}))_\>_\N{0})_\{}}
\L{\LB{}\Tab{24}{\K{if}((\V{j}_=_\V{sendString}(\V{EventNum},_\V{sendBuffer},_\V{i}))_\<_\N{0})}}
\L{\LB{}\Tab{32}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{24}{\C{}//cout\<\<i\<\<\3,\3\<\<j\<\<endl;\CE{}}}
\L{\LB{}\Tab{24}{\V{data}\-\!\>\V{sendPos}_+=_\V{j};}}
\L{\LB{}\Tab{24}{\V{\_lseek}(\V{fd},_\V{data}\-\!\>\V{sendPos},_\N{0});}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{\_close}(\V{fd});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}(\V{i}_!=_\V{j})}}
\L{\LB{}\Tab{24}{\K{return}_\N{0};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}(\V{i}_\<_\N{0})_\{}}
\L{\LB{}\Tab{24}{\V{cout}\<\<\S{}\3Problem_reading_file_\3\SE{}\<\<\V{data}\-\!\>\V{path}\<\<\V{endl};}}
\L{\LB{}\Tab{24}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//cout\<\<data-\!\>path\<\<\3_sent\3\<\<endl;\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//Socks[EventNum]-\!\>stopTime_=_GetTickCount();\CE{}}}
\L{\LB{}\Tab{8}{\V{QueryPerformanceCounter}(\&\V{Socks}[\V{EventNum}]\-\!\>\V{stopTime});}}
\L{\LB{}\Tab{8}{\V{totalTime}_+=_\N{1000}*(\V{Socks}[\V{EventNum}]\-\!\>\V{stopTime}.\V{QuadPart}_\-_\V{Socks}[\V{EventNum}]\-\!\>\V{startTime}.\V{QuadPart})/(\K{double})\V{freq}.\V{QuadPart};}}
\L{\LB{}\Tab{8}{\V{cout}\<\<\V{totalTime}/++\V{totalRequests}\<\<\V{endl};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//cout\<\<Socks[EventNum]-\!\>startTime\<\<endl\<\<Socks[EventNum]-\!\>stopTime\<\<endl;\CE{}}}
\L{\LB{}\Tab{8}{\C{}//cout\<\<Socks[EventNum]-\!\>stopTime_-_Socks[EventNum]-\!\>startTime\<\<endl;\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{data}\-\!\>\V{keepAlive})_\{}}
\L{\LB{}\Tab{16}{\K{if}(\V{WSAEventSelect}(\V{Socks}[\V{EventNum}]\-\!\>\V{sock},_\V{Events}[\V{EventNum}],_\V{FD\_READ}_\|_\V{FD\_CLOSE})_==_\V{SOCKET\_ERROR})_\{}}
\L{\LB{}\Tab{24}{\V{printf}(\S{}\3Error_resetting_asynchronous_event_notification:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}\Tab{24}{\V{Socks}[\V{EventNum}]\-\!\>\V{state}_=_\V{ST\_CLOSING};}}
\L{\LB{}\Tab{24}{\V{CloseConnection}(\V{EventNum},_\N{0});}}
\L{\LB{}\Tab{24}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{else}_\{}}
\L{\LB{}\Tab{16}{\V{Socks}[\V{EventNum}]\-\!\>\V{state}_=_\V{ST\_CLOSING};}}
\L{\LB{}\Tab{16}{\V{CloseConnection}(\V{EventNum},_\N{0});}}
\L{\LB{}\Tab{16}{\K{return}_\N{1};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{}}
\L{\LB{\}_\C{}//_end_SendData()\CE{}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}/*}}
\L{\LB{}}
\L{\LB{}\Tab{2}{Sends_a_string_to_a_socket.}}
\L{\LB{}}
\L{\LB{*/\CE{}}}
\index{sendString}\Proc{sendString}\L{\LB{\K{int}_\V{sendString}(\K{int}_\V{EventNum},_\V{string}_\V{buffer})_\{}}
\L{\LB{}\Tab{8}{\K{int}_\V{nbytes},_\V{length}_=_\V{buffer}.\V{length}(),_\V{sent}_=_\N{0};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{do}_\{}}
\L{\LB{}\Tab{16}{\V{nbytes}_=_\V{send}(\V{Socks}[\V{EventNum}]\-\!\>\V{sock},_\V{buffer}.\V{c\_str}(),_\V{length},_\N{0});}}
\L{\LB{}\Tab{16}{\K{if}(\V{nbytes}_\>_\N{0})_\{}}
\L{\LB{}\Tab{24}{\V{sent}_+=_\V{nbytes};}}
\L{\LB{}\Tab{24}{\V{buffer}_=_\V{buffer}.\V{substr}(\V{nbytes});}}
\L{\LB{}\Tab{24}{\V{length}_\-=_\V{nbytes};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{8}{\}_\K{while}(\V{nbytes}_!=_\V{SOCKET\_ERROR}_\&\&_\V{length}_\>_\N{0});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{nbytes}_==_\V{SOCKET\_ERROR})_\{}}
\L{\LB{}\Tab{16}{\K{if}(\V{WSAGetLastError}()_!=_\V{WSAEWOULDBLOCK})_\{}}
\L{\LB{}\Tab{24}{\V{printf}(\S{}\3Write_error:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}\Tab{24}{\V{Socks}[\V{EventNum}]\-\!\>\V{state}_=_\V{ST\_CLOSING};}}
\L{\LB{}\Tab{24}{\V{CloseConnection}(\V{EventNum},_\N{0});}}
\L{\LB{}\Tab{24}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{else}_\K{if}(\V{Socks}[\V{EventNum}]\-\!\>\V{requestStats}\-\!\>\V{response}.\V{length}())_\{}}
\L{\LB{}\Tab{24}{\K{if}(\V{WSAEventSelect}(\V{Socks}[\V{EventNum}]\-\!\>\V{sock},_\V{Events}[\V{EventNum}],_\V{FD\_WRITE}_\|_\V{FD\_CLOSE})_==_\V{SOCKET\_ERROR})_\{}}
\L{\LB{}\Tab{32}{\V{printf}(\S{}\3Error_resetting_asynchronous_event_notification:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}\Tab{32}{\V{Socks}[\V{EventNum}]\-\!\>\V{state}_=_\V{ST\_CLOSING};}}
\L{\LB{}\Tab{32}{\V{CloseConnection}(\V{EventNum},_\N{0});}}
\L{\LB{}\Tab{32}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{24}{\}}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\V{sent};}}
\L{\LB{\}}}
\L{\LB{}}
\index{sendString}\Proc{sendString}\L{\LB{\K{int}_\V{sendString}(\K{int}_\V{EventNum},_\K{char}_*_\V{buffer},_\K{int}_\V{length})_\{}}
\L{\LB{}\Tab{8}{\K{int}_\V{nbytes},_\V{sent}_=_\N{0};}}
\L{\LB{}\Tab{8}{\K{char}_*\V{bufptr}_=_\V{buffer};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{do}_\{}}
\L{\LB{}\Tab{16}{\V{nbytes}_=_\V{send}(\V{Socks}[\V{EventNum}]\-\!\>\V{sock},_\V{bufptr},_\V{length},_\N{0});}}
\L{\LB{}\Tab{16}{\C{}//cout\<\<nbytes\<\<endl;\CE{}}}
\L{\LB{}\Tab{16}{\K{if}(\V{nbytes}_\>_\N{0})_\{}}
\L{\LB{}\Tab{24}{\V{bufptr}_+=_\V{nbytes};}}
\L{\LB{}\Tab{24}{\V{sent}_+=_\V{nbytes};}}
\L{\LB{}\Tab{24}{\V{length}_\-=_\V{nbytes};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{8}{\}_\K{while}(\V{nbytes}_!=_\V{SOCKET\_ERROR}_\&\&_\V{length}_\>_\N{0});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{nbytes}_==_\V{SOCKET\_ERROR})_\{}}
\L{\LB{}\Tab{16}{\K{if}(\V{WSAGetLastError}()_!=_\V{WSAEWOULDBLOCK})_\{}}
\L{\LB{}\Tab{24}{\V{printf}(\S{}\3Write_error:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}\Tab{24}{\V{Socks}[\V{EventNum}]\-\!\>\V{state}_=_\V{ST\_CLOSING};}}
\L{\LB{}\Tab{24}{\V{CloseConnection}(\V{EventNum},_\N{0});}}
\L{\LB{}\Tab{24}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{else}_\K{if}(\V{length})_\{}}
\L{\LB{}\Tab{24}{\K{if}(\V{WSAEventSelect}(\V{Socks}[\V{EventNum}]\-\!\>\V{sock},_\V{Events}[\V{EventNum}],_\V{FD\_WRITE}_\|_\V{FD\_CLOSE})_==_\V{SOCKET\_ERROR})_\{}}
\L{\LB{}\Tab{32}{\V{printf}(\S{}\3Error_resetting_asynchronous_event_notification:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}\Tab{32}{\V{Socks}[\V{EventNum}]\-\!\>\V{state}_=_\V{ST\_CLOSING};}}
\L{\LB{}\Tab{32}{\V{CloseConnection}(\V{EventNum},_\N{0});}}
\L{\LB{}\Tab{32}{\K{return}_\-\N{1};}}
\L{\LB{}\Tab{24}{\}}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\V{sent};}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}////////////////////////////////////////////////////////////\CE{}}}
\L{\LB{\C{}//_Close_a_client_connection_(potentially_from_any_state)\CE{}}}
\L{\LB{}}
\index{CloseConnection}\Proc{CloseConnection}\L{\LB{\K{int}_\V{CloseConnection}(\K{int}_\V{EventNum},_\K{int}_\V{EventError})}}
\L{\LB{\{}}
\L{\LB{}\Tab{8}{\K{int}_\V{i};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_If_still_data_to_send_and_no_error,_allow_writing,_and_change_state.\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{Socks}[\V{EventNum}]\-\!\>\V{state}_==_\V{ST\_WRITING}_\&\&_\V{EventError}_==_\N{0})_\{}}
\L{\LB{}\Tab{16}{\V{Socks}[\V{EventNum}]\-\!\>\V{state}_=_\V{ST\_CLOSING};}}
\L{\LB{}\Tab{16}{\V{SendData}(\V{EventNum},_\N{0});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Else,_report_error,_if_any,_and_free_resources.\CE{}}}
\L{\LB{}\Tab{8}{\K{else}_\{}}
\L{\LB{}\Tab{16}{\K{if}_(\V{EventError}_!=_\N{0})}}
\L{\LB{}\Tab{24}{\V{printf}(\S{}\3Close_event_error:}\Tab{52}{\%d\2n\3\SE{},_\V{EventError});}}
\L{\LB{}\Tab{16}{}}
\L{\LB{}\Tab{16}{\V{WSACloseEvent}(\V{Events}[\V{EventNum}]);}}
\L{\LB{}\Tab{16}{\V{closesocket}(\V{Socks}[\V{EventNum}]\-\!\>\V{sock});}}
\L{\LB{}\Tab{16}{\V{free}(\V{Socks}[\V{EventNum}]);}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Delete_this_event_and_information_pointer_from_arrays.\CE{}}}
\L{\LB{}\Tab{16}{\K{for}_(\V{i}_=_\V{EventNum}_+_\N{1};_\V{i}_\<_\V{NumSocks};_++\V{i})_\{}}
\L{\LB{}\Tab{24}{\V{Events}[\V{i}\-\N{1}]_=_\V{Events}[\V{i}];}}
\L{\LB{}\Tab{24}{\V{Socks}[\V{i}\-\N{1}]_=_\V{Socks}[\V{i}];}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{16}{\-\-\V{NumSocks};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//printf(\3Status:_connection_closed_(\%d)\2n\3,_EventNum);\CE{}}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return}_\N{0};}}
\L{\LB{\}_\C{}//_end_CloseConnection()\CE{}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}////////////////////////////////////////////////////////////////////////////\CE{}}}
\L{\LB{\C{}//_Error_exit_routine_as_in_Comer_and_Stevens,_Vol._III_(WinSock_edition)\CE{}}}
\L{\LB{}}
\index{errexit}\Proc{errexit}\L{\LB{\K{void}_\V{errexit}(\K{const}_\K{char}_*\V{format},_.\,.\,.)}}
\L{\LB{\{}}
\L{\LB{}\Tab{8}{\V{va\_list}}\Tab{16}{\V{args};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{va\_start}(\V{args},_\V{format});}}
\L{\LB{}\Tab{8}{\V{vfprintf}(\V{stderr},_\V{format},_\V{args});}}
\L{\LB{}\Tab{8}{\V{va\_end}(\V{args});}}
\L{\LB{}\Tab{8}{\V{WSACleanup}();}}
\L{\LB{}\Tab{8}{\V{exit}(\N{1});}}
\L{\LB{}}
\L{\LB{\}_\C{}//_end_errexit()\CE{}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}////////////////////////////////////////\CE{}}}
\L{\LB{\C{}//_Display_network_events_that_are_ready\CE{}}}
\L{\LB{}}
\index{DisplayEvents}\Proc{DisplayEvents}\L{\LB{\K{void}_\V{DisplayEvents}(\K{long}_\V{events},_\K{int}_\V{EventNum})}}
\L{\LB{\{}}
\L{\LB{}\Tab{8}{\V{printf}(\S{}\3Event_\%d_signalled_for:_\3\SE{},_\V{EventNum});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}_(\V{BITSET}(\V{FD\_READ},_\V{events}))_\V{printf}(\S{}\3_READ\3\SE{});}}
\L{\LB{}\Tab{8}{\K{if}_(\V{BITSET}(\V{FD\_WRITE},_\V{events}))_\V{printf}(\S{}\3_WRITE\3\SE{});}}
\L{\LB{}\Tab{8}{\K{if}_(\V{BITSET}(\V{FD\_OOB},_\V{events}))_\V{printf}(\S{}\3_OOB\3\SE{});}}
\L{\LB{}\Tab{8}{\K{if}_(\V{BITSET}(\V{FD\_ACCEPT},_\V{events}))_\V{printf}(\S{}\3_ACCEPT\3\SE{});}}
\L{\LB{}\Tab{8}{\K{if}_(\V{BITSET}(\V{FD\_CONNECT},_\V{events}))_\V{printf}(\S{}\3_CONNECT\3\SE{});}}
\L{\LB{}\Tab{8}{\K{if}_(\V{BITSET}(\V{FD\_CLOSE},_\V{events}))_\V{printf}(\S{}\3_CLOSE\3\SE{});}}
\L{\LB{}\Tab{8}{\K{if}_(\V{BITSET}(\V{FD\_QOS},_\V{events}))_\V{printf}(\S{}\3_QOS\3\SE{});}}
\L{\LB{}\Tab{8}{\K{if}_(\V{BITSET}(\V{FD\_GROUP\_QOS},_\V{events}))_\V{printf}(\S{}\3_GROUP\_QOS\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{printf}(\S{}\3\2n\3\SE{});}}
\L{\LB{}}
\L{\LB{\}_\C{}//_end_DisplayEvents()\CE{}}}
