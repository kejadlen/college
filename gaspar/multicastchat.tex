% Remember to use the lgrind style

\Head{}
\File{multicastchat.cpp}{2004}{12}{7}{17:00}{19630}
\L{\LB{\C{}//\#include_\<stdio.h\>\CE{}}}
\L{\LB{\C{}//\#include_\<stdarg.h\>\CE{}}}
\L{\LB{\K{\#include}_\<\V{winsock2}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{process}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{windows}.\V{h}\>}}
\L{\LB{\K{\#include}_\<\V{ws2tcpip}.\V{h}\>}}
\L{\LB{}}
\L{\LB{\K{\#include}_\<\V{iostream}\>}}
\L{\LB{\K{\#include}_\<\V{vector}\>}}
\L{\LB{\K{\#include}_\<\V{string}\>}}
\L{\LB{}}
\L{\LB{\K{using}_\K{namespace}_\V{std};}}
\L{\LB{}}
\L{\LB{\C{}//_Constants.\CE{}}}
\L{\LB{\K{\#define}_\V{WSVERS}}\Tab{16}{\V{MAKEWORD}(\N{2},\N{2})}}
\L{\LB{\K{\#define}}\Tab{8}{\V{DESTINATION\_PORT}}\Tab{32}{\N{4564}}\Tab{40}{\C{}//_default_multicast_port\CE{}}}
\L{\LB{\K{\#define}_\V{DEFAULT\_TTL}}\Tab{24}{\N{1}}}
\L{\LB{}}
\L{\LB{\C{}//_for_screen_output\CE{}}}
\L{\LB{\K{\#define}}\Tab{8}{\V{RED}}\Tab{16}{\V{FOREGROUND\_RED}}}
\L{\LB{\K{\#define}_\V{GREEN}}\Tab{16}{\V{FOREGROUND\_GREEN}}}
\L{\LB{\K{\#define}}\Tab{8}{\V{BLUE}}\Tab{16}{\V{FOREGROUND\_BLUE}}}
\L{\LB{\K{\#define}}\Tab{8}{\V{WHITE}}\Tab{16}{\V{RED}\|\V{GREEN}\|\V{BLUE}}}
\L{\LB{}}
\L{\LB{\C{}//_To_pass_arguments_to_getInput\CE{}}}
\L{\LB{\K{struct}_\V{getNetworkInputArgs}_\{}}
\L{\LB{}\Tab{8}{\V{SOCKET}}\Tab{16}{\V{McastSock};}}
\L{\LB{\};}}
\L{\LB{}}
\L{\LB{\C{}//_User_data\CE{}}}
\L{\LB{\K{struct}_\V{userData}_\{}}
\L{\LB{}\Tab{8}{\V{string}_\V{user};}}
\L{\LB{}\Tab{8}{\V{string}_\V{ip};}}
\L{\LB{\};}}
\L{\LB{}}
\L{\LB{\C{}//_Function_prototypes.\CE{}}}
\L{\LB{\K{void}}\Tab{8}{\V{initNetworking}(\K{void});}}
\L{\LB{\K{void}}\Tab{8}{\V{initScreen}(\K{void});}}
\L{\LB{\K{void}}\Tab{8}{\V{ScrollOutputBuffer}(\K{void});}}
\L{\LB{}}
\L{\LB{\K{void}}\Tab{8}{\V{getNetworkInput}(\K{void}_*\V{\_args});}}
\L{\LB{\K{void}}\Tab{8}{\V{addNewUser}(\K{char}_*\V{user},_\K{char}_*\V{ip});}}
\L{\LB{}}
\L{\LB{\K{void}}\Tab{8}{\V{ProcessLine}(\V{string}_\V{input});}}
\L{\LB{\K{void}}\Tab{8}{\V{joinCommand}(\V{string}_\V{input});}}
\L{\LB{\K{void}}\Tab{8}{\V{joinGroup}(\K{void});}}
\L{\LB{\K{void}}\Tab{8}{\V{outputUserList}(\K{void});}}
\L{\LB{\K{void}}\Tab{8}{\V{departGroup}(\K{void});}}
\L{\LB{}}
\L{\LB{\K{void}}\Tab{8}{\V{chatOutput}(\K{char}_*\V{output},_\V{WORD}_\V{color});}}
\L{\LB{\K{void}}\Tab{8}{\V{chatOutput}(\V{string}_\V{output},_\V{WORD}_\V{color});}}
\L{\LB{}}
\L{\LB{\K{void}}\Tab{8}{\V{errexit}(\K{const}_\K{char}_*,_.\,.\,.);}}
\L{\LB{}}
\L{\LB{\C{}//_Globals.\CE{}}}
\L{\LB{\K{int}_\V{port},_\V{ttl};}}
\L{\LB{\V{string}_\V{group},_\V{ip};}}
\L{\LB{}}
\L{\LB{\K{int}_\V{connected};}}
\L{\LB{}}
\L{\LB{\V{vector}\<\V{userData}\>_\V{userlist};}}
\L{\LB{}}
\L{\LB{\V{SOCKET}_\V{McastSock};}}
\L{\LB{\K{struct}_\V{sockaddr\_in}_\V{dest};}}
\L{\LB{}}
\L{\LB{\V{HANDLE}_\V{recvThread};}}
\L{\LB{}}
\L{\LB{\V{HANDLE}_\V{hStdout},_\V{hStdin};}}
\L{\LB{\V{CONSOLE\_SCREEN\_BUFFER\_INFO}_\V{csbiInfo};}}
\L{\LB{}}
\L{\LB{\C{}//_Procedure_main().\CE{}}}
\index{main}\Proc{main}\L{\LB{\K{void}_\V{main}(\K{int}_\V{argc},_\K{char}_*\V{argv}[\,])}}
\L{\LB{\{}}
\L{\LB{}\Tab{8}{\V{WSADATA}}\Tab{24}{\V{wsadata};}\Tab{48}{\C{}//_returned_startup_data\CE{}}}
\L{\LB{}\Tab{8}{\K{char}}\Tab{24}{\V{chBuffer};}}
\L{\LB{}\Tab{8}{\V{DWORD}}\Tab{24}{\V{cRead},_\V{cWritten};}}
\L{\LB{}\Tab{8}{\K{char}}\Tab{24}{\V{buf}[\N{256}];}}
\L{\LB{}\Tab{8}{\V{hostent}*}\Tab{24}{\V{host};}}
\L{\LB{}\Tab{8}{\V{string}}\Tab{24}{\V{input};}\Tab{48}{\C{}//_holds_input_from_screen_buffer\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Set_defaults\CE{}}}
\L{\LB{}\Tab{8}{\V{port}_=_\V{DESTINATION\_PORT};}}
\L{\LB{}\Tab{8}{\V{ttl}_=_\V{DEFAULT\_TTL};}}
\L{\LB{}\Tab{8}{\V{group}_=_\S{}\3234.5.6.7\3\SE{};}}
\L{\LB{}\Tab{8}{\V{connected}_=_\N{0};}}
\L{\LB{}\Tab{8}{\V{userData}_\V{newUser};}}
\L{\LB{}\Tab{8}{\V{newUser}.\V{user}_=_\S{}\3John_Doe\3\SE{};}}
\L{\LB{}\Tab{8}{\V{newUser}.\V{ip}_=_\S{}\3\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_userlist[0]_is_always_the_originating_program\CE{}}}
\L{\LB{}\Tab{8}{\V{userlist}.\V{push\_back}(\V{newUser});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_if_arguments_have_been_supplied,_use_them\CE{}}}
\L{\LB{}\Tab{8}{\K{switch}_(\V{argc})_\{}}
\L{\LB{}\Tab{8}{\K{case}_\N{1}\V{:}}}
\L{\LB{}\Tab{16}{\K{break};}}
\L{\LB{}\Tab{8}{\K{case}_\N{3}\V{:}}}
\L{\LB{}\Tab{16}{\V{ttl}_=_\V{atoi}(\V{argv}[\N{2}]);}}
\L{\LB{}\Tab{16}{\C{}//_fall_through\CE{}}}
\L{\LB{}\Tab{8}{\K{case}_\N{2}\V{:}}}
\L{\LB{}\Tab{16}{\V{port}_=_\V{atoi}(\V{argv}[\N{1}]);}}
\L{\LB{}\Tab{16}{\K{break};}}
\L{\LB{}\Tab{8}{\V{default:}}}
\L{\LB{}\Tab{16}{\V{fprintf}(\V{stderr},_\S{}\3Arguments:}\Tab{45}{[port_[ttl]]\2n\3\SE{});}}
\L{\LB{}\Tab{16}{\V{exit}(\N{1});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Start_WinSock_(standard_call)\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_This_is_not_in_initNetworking()_because_this_only_needs_to_be\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_called_once,_whereas_initNetworking()_initializes_the_socket\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_and_may_be_called_more_than_once_a_session.\CE{}}}
\L{\LB{}\Tab{8}{\K{if}_(\V{WSAStartup}(\V{WSVERS},_\&\V{wsadata})_!=_\N{0})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3WSAStartup()_failed\2n\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Initialize_multicast_socket_and_screen_buffers\CE{}}}
\L{\LB{}\Tab{8}{\V{initNetworking}();}}
\L{\LB{}\Tab{8}{\V{initScreen}();}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Find_own_IP_and_set_it\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(\V{gethostname}(\V{buf},_\N{256}))_\{}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3gethostname()_failed:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\V{host}_=_\V{gethostbyname}(\V{buf});}}
\L{\LB{}\Tab{8}{\K{if}(!\V{host})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3WSAGetLastError()_failed:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{userlist}[\N{0}].\V{ip}_=_\V{inet\_ntoa}(*(\K{reinterpret\_cast}\<\V{in\_addr}*\>(\V{host}\-\!\>\V{h\_addr})));}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{do}_\{}}
\L{\LB{}\Tab{16}{\C{}//_Read_a_character_from_the_screen\CE{}}}
\L{\LB{}\Tab{16}{\K{if}(!\V{ReadFile}(\V{hStdin},_\&\V{chBuffer},_\N{1},_\&\V{cRead},_\V{NULL}))}}
\L{\LB{}\Tab{24}{\V{errexit}(\S{}\3ReadFile()_failed\2n\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Find_current_cursor_position\CE{}}}
\L{\LB{}\Tab{16}{\K{if}(!\V{GetConsoleScreenBufferInfo}(\V{hStdout},_\&\V{csbiInfo}))}}
\L{\LB{}\Tab{24}{\V{errexit}(\S{}\3GetConsoleScreenBufferInfo()_failed\2n\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}(\V{chBuffer}_==_\S{}{'}\2r{'}\SE{})_\{}}
\L{\LB{}\Tab{24}{\C{}//_The_character_is_a_line_feed,_clear_the_input_area_and\CE{}}}
\L{\LB{}\Tab{24}{\C{}//_process_the_input.\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\V{csbiInfo}.\V{dwCursorPosition}.\V{X}_=_\N{0};}}
\L{\LB{}\Tab{24}{\V{csbiInfo}.\V{dwCursorPosition}.\V{Y}_=_\N{21};}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\K{if}(!\V{SetConsoleCursorPosition}(\V{hStdout},\V{csbiInfo}.\V{dwCursorPosition}))}}
\L{\LB{}\Tab{32}{\V{errexit}(\S{}\3SetConsoleCursorPosition()_failed\2n\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\K{if}(!\V{FillConsoleOutputCharacter}(\V{hStdout},\S{}{'}_{'}\SE{},\N{320},\V{csbiInfo}.\V{dwCursorPosition},\&\V{cWritten}))}}
\L{\LB{}\Tab{32}{\V{errexit}(\S{}\3FillConsoleOutputCharacter()_failed\2n\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\C{}//_Process_the_input\CE{}}}
\L{\LB{}\Tab{24}{\V{ProcessLine}(\V{input});}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\C{}//_Reset_the_input\CE{}}}
\L{\LB{}\Tab{24}{\V{input}_=_\S{}\3\3\SE{};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{16}{\K{else}_\K{if}(\V{chBuffer}_==_\S{}{'}\2b{'}\SE{}_\&\&_\V{csbiInfo}.\V{dwCursorPosition}.\V{X})_\{}}
\L{\LB{}\Tab{24}{\C{}//_Handles_backspaces_poorly_--_you_can_only_backspace_up_to\CE{}}}
\L{\LB{}\Tab{24}{\C{}//_the_edge_of_the_screen_and_not_to_the_previous_line\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\C{}//_Move_the_cursor_back_one_space_and_erase_the_current_character\CE{}}}
\L{\LB{}\Tab{24}{\V{csbiInfo}.\V{dwCursorPosition}.\V{X}_\-=_\N{1};}}
\L{\LB{}\Tab{24}{\K{if}(!\V{SetConsoleCursorPosition}(\V{hStdout},\V{csbiInfo}.\V{dwCursorPosition}))}}
\L{\LB{}\Tab{32}{\V{errexit}(\S{}\3SetConsoleCursorPosition_failed\2n\3\SE{});}}
\L{\LB{}\Tab{24}{\K{if}(!\V{FillConsoleOutputCharacter}(\V{hStdout},\S{}{'}_{'}\SE{},\N{1},\V{csbiInfo}.\V{dwCursorPosition},\&\V{cWritten}))}}
\L{\LB{}\Tab{32}{\V{errexit}(\S{}\3FillConsoleOutputCharacter()_failed\2n\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\C{}//_Remove_the_character_from_the_input_string\CE{}}}
\L{\LB{}\Tab{24}{\V{input}_=_\V{input}.\V{substr}(\N{0},\V{input}.\V{length}()\-\N{1});}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{16}{\K{else}_\K{if}(\V{chBuffer}_\<_\N{127}_\&\&_\V{chBuffer}_\>_\N{31})_\{}}
\L{\LB{}\Tab{24}{\C{}//_Only_catches_ASCII_characters\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\C{}//_Echo_the_character\CE{}}}
\L{\LB{}\Tab{24}{\K{if}(!\V{WriteFile}(\V{hStdout},_\&\V{chBuffer},_\V{cRead},_\&\V{cWritten},_\V{NULL}))}}
\L{\LB{}\Tab{32}{\V{errexit}(\S{}\3WriteFile()_failed\2n\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\C{}//_If_at_the_end_of_a_line,_start_a_new_one\CE{}}}
\L{\LB{}\Tab{24}{\K{if}(\V{csbiInfo}.\V{dwCursorPosition}.\V{X}_==_\N{79})_\{}}
\L{\LB{}\Tab{32}{\V{csbiInfo}.\V{dwCursorPosition}.\V{X}_=_\N{0};}}
\L{\LB{}\Tab{32}{\V{csbiInfo}.\V{dwCursorPosition}.\V{Y}_+=_\N{1};}}
\L{\LB{}}
\L{\LB{}\Tab{32}{\K{if}(!\V{SetConsoleCursorPosition}(\V{hStdout},\V{csbiInfo}.\V{dwCursorPosition}))}}
\L{\LB{}\Tab{40}{\V{errexit}(\S{}\3SetConsoleCursorPosition_failed\2n\3\SE{});}}
\L{\LB{}\Tab{24}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\C{}//_Add_the_character_to_the_input_string\CE{}}}
\L{\LB{}\Tab{24}{\V{input}_+=_\V{chBuffer};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\}_\K{while}_(\N{1});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Never_reached.\CE{}}}
\L{\LB{}\Tab{8}{}}
\L{\LB{\}_\C{}//_end_main().\CE{}}}
\L{\LB{}}
\L{\LB{\C{}//_Processes_the_input\CE{}}}
\index{ProcessLine}\Proc{ProcessLine}\L{\LB{\K{void}_\V{ProcessLine}(\V{string}_\V{input})_\{}}
\L{\LB{}\Tab{8}{\K{char}}\Tab{16}{\V{buf}[\N{514}];}}
\L{\LB{}\Tab{8}{\K{short}}\Tab{16}{\V{length1},_\V{length2};}}
\L{\LB{}\Tab{8}{\V{string}}\Tab{16}{\V{command},_\V{user};}}
\L{\LB{}\Tab{8}{\K{int}}\Tab{24}{\V{stringPos},_\V{temp};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Separate_the_input_into_command_and_arguments\CE{}}}
\L{\LB{}\Tab{8}{\V{stringPos}_=_\V{input}.\V{find}(\S{}\3_\3\SE{});}}
\L{\LB{}\Tab{8}{\V{command}_=_\V{input}.\V{substr}(\N{0},\V{stringPos});}}
\L{\LB{}\Tab{8}{\V{input}_=_\V{input}.\V{substr}(\V{stringPos}+\N{1});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Set_up_default_error_message\CE{}}}
\L{\LB{}\Tab{8}{\V{sprintf}(\V{buf},_\S{}\3\2tcannot_{'}\%s{'}_\-_not_connected_to_any_group\3\SE{},_\V{command}.\V{c\_str}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{command}_==_\S{}\3user\3\SE{})_\{}}
\L{\LB{}\Tab{16}{\C{}//_Change_the_username\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}(\V{input}.\V{length}()_\>_\N{255})_\{}}
\L{\LB{}\Tab{24}{\V{chatOutput}(\S{}\3\2tuser_name_too_long_\-_must_be_under_255_characters\3\SE{},_\V{RED});}}
\L{\LB{}\Tab{24}{\K{return};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{16}{\K{if}(\V{connected})_\{}}
\L{\LB{}\Tab{24}{\C{}//_If_connected_to_a_group,_leave_and_then_rejoin_with_a_different_username\CE{}}}
\L{\LB{}\Tab{24}{\V{departGroup}();}}
\L{\LB{}\Tab{24}{\V{userlist}[\N{0}].\V{user}_=_\V{input};}}
\L{\LB{}\Tab{24}{\V{joinGroup}();}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{16}{\K{else}}}
\L{\LB{}\Tab{24}{\V{userlist}[\N{0}].\V{user}_=_\V{input};}}
\L{\LB{}\Tab{16}{}}
\L{\LB{}\Tab{16}{\V{input}_=_\S{}\3\2tuser_name_changed_to_{'}\3\SE{}_+_\V{input}_+_\S{}\3{'}\3\SE{};}}
\L{\LB{}\Tab{16}{\V{chatOutput}(\V{input},_\V{GREEN});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{else}_\K{if}(\V{command}_==_\S{}\3join\3\SE{})_\{}}
\L{\LB{}\Tab{16}{\C{}//_Join_a_group\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}(\V{connected})}}
\L{\LB{}\Tab{24}{\C{}//_If_connected_to_a_group,_leave_it_first\CE{}}}
\L{\LB{}\Tab{24}{\V{departGroup}();}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{joinCommand}(\V{input});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{else}_\K{if}(\V{command}_==_\S{}\3leave\3\SE{})_\{}}
\L{\LB{}\Tab{16}{\C{}//_Leave_a_group\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}(!\V{connected})_\{}}
\L{\LB{}\Tab{24}{\C{}//_Error_--_cannot_leave_when_not_connected\CE{}}}
\L{\LB{}\Tab{24}{\V{chatOutput}(\S{}\3\2tnot_connected_to_a_group\3\SE{},_\V{RED});}}
\L{\LB{}\Tab{24}{\K{return};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{departGroup}();}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{else}_\K{if}(\V{command}_==_\S{}\3list\3\SE{})_\{}}
\L{\LB{}\Tab{16}{\C{}//_List_the_members_of_the_current_group\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}(!\V{connected})_\{}}
\L{\LB{}\Tab{24}{\C{}//_Error_--_cannot_list_when_not_connected\CE{}}}
\L{\LB{}\Tab{24}{\V{chatOutput}(\V{buf},_\V{RED});}}
\L{\LB{}\Tab{24}{\K{return};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{outputUserList}();}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{else}_\K{if}(\V{command}_==_\S{}\3send\3\SE{})_\{}}
\L{\LB{}\Tab{16}{\C{}//_Send_a_message\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}(!\V{connected})_\{}}
\L{\LB{}\Tab{24}{\C{}//_Error_--_cannot_send_when_not_connected\CE{}}}
\L{\LB{}\Tab{24}{\V{chatOutput}(\V{buf},_\V{RED});}}
\L{\LB{}\Tab{24}{\K{return};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{16}{\K{if}(\V{input}.\V{length}()_\>_\N{255})_\{}}
\L{\LB{}\Tab{24}{\V{chatOutput}(\S{}\3\2tmessage_not_sent_\-_must_be_under_255_characters\3\SE{},_\V{RED});}}
\L{\LB{}\Tab{24}{\K{return};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Send_the_message\CE{}}}
\L{\LB{}\Tab{16}{\V{length1}_=_\V{userlist}[\N{0}].\V{user}.\V{length}();}}
\L{\LB{}\Tab{16}{\V{length2}_=_\V{input}.\V{length}();}}
\L{\LB{}\Tab{16}{\V{sprintf}(\V{buf},_\S{}\3\%c\%c\%s\%c\%s\3\SE{},_\N{3},_\V{length1},_\V{userlist}[\N{0}].\V{user}.\V{c\_str}(),_\V{length2},_\V{input}.\V{c\_str}());}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}(\V{sendto}(\V{McastSock},_\V{buf},_\V{strlen}(\V{buf}),_\N{0},}}
\L{\LB{}\Tab{24}{(\K{struct}_\V{sockaddr}_*)_\&\V{dest},_\K{sizeof}(\K{struct}_\V{sockaddr}))_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{24}{\V{errexit}(\S{}\3sendto()_failed:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{else}_\K{if}(\V{command}_==_\S{}\3exit\3\SE{})_\{}}
\L{\LB{}\Tab{16}{\C{}//_Exit_the_program\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}(\V{connected})}}
\L{\LB{}\Tab{24}{\C{}//_If_connected,_leave_nicely\CE{}}}
\L{\LB{}\Tab{24}{\V{departGroup}();}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Clean_up_Winsock_networking\CE{}}}
\L{\LB{}\Tab{16}{\V{WSACleanup}();}}
\L{\LB{}\Tab{16}{\V{exit}(\N{0});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{else}_\K{if}(\V{command}_==_\S{}\3ttl\3\SE{})_\{}}
\L{\LB{}\Tab{16}{\C{}//_Change_the_TTL_value\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{temp}_=_\V{atoi}(\V{input}.\V{c\_str}());}}
\L{\LB{}\Tab{16}{\K{if}(\V{temp}_\<_\N{0}_\|\,\|_\V{temp}_\>_\N{255})_\{}}
\L{\LB{}\Tab{24}{\V{chatOutput}(\S{}\3\2tTTL_must_be_between_0_and_255\3\SE{},_\V{RED});}}
\L{\LB{}\Tab{24}{\K{return};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}(\V{connected})_\{}}
\L{\LB{}\Tab{24}{\C{}//_Reconnect_to_the_group\CE{}}}
\L{\LB{}\Tab{24}{\V{departGroup}();}}
\L{\LB{}\Tab{24}{\V{ttl}_=_\V{temp};}}
\L{\LB{}\Tab{24}{\V{sprintf}(\V{buf},_\S{}\3\2tTTL_set_to_\%d\3\SE{},_\V{ttl});}}
\L{\LB{}\Tab{24}{\V{chatOutput}(\V{buf},_\V{GREEN});}}
\L{\LB{}\Tab{24}{\V{joinGroup}();}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{16}{\K{else}_\{}}
\L{\LB{}\Tab{24}{\V{ttl}_=_\V{temp};}}
\L{\LB{}\Tab{24}{\V{sprintf}(\V{buf},_\S{}\3\2tTTL_set_to_\%d\3\SE{},_\V{ttl});}}
\L{\LB{}\Tab{24}{\V{chatOutput}(\V{buf},_\V{GREEN});}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{else}_\K{if}(\V{command}_==_\S{}\3port\3\SE{})_\{}}
\L{\LB{}\Tab{16}{\C{}//_Change_the_port\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{temp}_=_\V{atoi}(\V{input}.\V{c\_str}());}}
\L{\LB{}\Tab{16}{\V{port}_=_\V{temp};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{sprintf}(\V{buf},_\S{}\3\2tport_set_to_\%d\3\SE{},_\V{port});}}
\L{\LB{}\Tab{16}{\V{chatOutput}(\V{buf},_\V{GREEN});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}(\V{connected})_\{}}
\L{\LB{}\Tab{24}{\C{}//_The_socket_must_be_reinitialized\CE{}}}
\L{\LB{}\Tab{24}{\V{departGroup}();}}
\L{\LB{}\Tab{24}{\V{closesocket}(\V{McastSock});}}
\L{\LB{}\Tab{24}{\V{initNetworking}();}}
\L{\LB{}\Tab{24}{\V{joinGroup}();}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{else}_\{}}
\L{\LB{}\Tab{16}{\C{}//_Display_an_error_message,_since_there_are_no_other\CE{}}}
\L{\LB{}\Tab{16}{\C{}//_valid_commands\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{command}_=_\S{}\3\2t{'}\3\SE{}_+_\V{command}_+_\S{}\3{'}_is_an_invalid_command\3\SE{};}}
\L{\LB{}\Tab{16}{\V{chatOutput}(\V{command},_\V{RED});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{\C{}//_Joins_a_multicast_group\CE{}}}
\index{joinCommand}\Proc{joinCommand}\L{\LB{\K{void}_\V{joinCommand}(\V{string}_\V{input})_\{}}
\L{\LB{}\Tab{8}{\K{char}}\Tab{16}{\V{buf}[\N{513}];}}
\L{\LB{}\Tab{8}{\K{int}}\Tab{24}{\V{stringPos},_\V{ipNum};}}
\L{\LB{}\Tab{8}{\V{string}}\Tab{16}{\V{temp}_=_\V{input};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Set_up_error_message\CE{}}}
\L{\LB{}\Tab{8}{\V{sprintf}(\V{buf},_\S{}\3\2tinvalid_group_address_{'}\%s{'}\3\SE{},_\V{input}.\V{c\_str}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{group}_=_\S{}\3\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_Make_sure_the_group_is_between_234.0.0.1_and_234.255.255.255\CE{}}}
\L{\LB{}\Tab{8}{\C{}//\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{stringPos}_=_\V{temp}.\V{find}(\S{}\3.\3\SE{});}}
\L{\LB{}\Tab{8}{\V{ipNum}_=_\V{atoi}(\V{temp}.\V{substr}(\N{0},\V{stringPos}).\V{c\_str}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{ipNum}_!=_\N{234}_\|\,\|_\V{stringPos}_==_\V{string::npos})_\{}}
\L{\LB{}\Tab{16}{\V{chatOutput}(\V{buf},_\V{RED});}}
\L{\LB{}\Tab{16}{\K{return};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\V{group}_+=_\V{temp}.\V{substr}(\N{0},\V{stringPos})_+_\S{}\3.\3\SE{};}}
\L{\LB{}\Tab{8}{\V{temp}_=_\V{temp}.\V{substr}(\V{stringPos}+\N{1});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{for}(\K{int}_\V{i}=\N{0};_\V{i}\<\N{2};_\V{i}++)_\{}}
\L{\LB{}\Tab{16}{\V{stringPos}_=_\V{temp}.\V{find}(\S{}\3.\3\SE{});}}
\L{\LB{}\Tab{16}{\V{ipNum}_=_\V{atoi}(\V{temp}.\V{substr}(\N{0},\V{stringPos}).\V{c\_str}());}}
\L{\LB{}\Tab{16}{\K{if}(\V{ipNum}_\>_\N{255}_\|\,\|_\V{ipNum}_\<_\N{0})_\{}}
\L{\LB{}\Tab{24}{\V{chatOutput}(\V{buf},_\V{RED});}}
\L{\LB{}\Tab{24}{\K{return};}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{16}{\V{group}_+=_\V{temp}.\V{substr}(\N{0},\V{stringPos})_+_\S{}\3.\3\SE{};}}
\L{\LB{}\Tab{16}{\V{temp}_=_\V{temp}.\V{substr}(\V{stringPos}+\N{1});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{ipNum}_=_\V{atoi}(\V{temp}.\V{c\_str}());}}
\L{\LB{}\Tab{8}{\K{if}(\V{ipNum}_\>_\N{255}_\|\,\|_\V{ipNum}_\<_\N{1})_\{}}
\L{\LB{}\Tab{16}{\V{chatOutput}(\V{buf},_\V{RED});}}
\L{\LB{}\Tab{16}{\K{return};}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\V{group}_+=_\V{temp}.\V{substr}(\N{0},\V{stringPos});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_No_errors_encountered,_so_the_group_is_valid_and\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_joinGroup()_can_be_run\CE{}}}
\L{\LB{}\Tab{8}{\V{joinGroup}();}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{\C{}//_Self-explanatory\CE{}}}
\index{outputUserList}\Proc{outputUserList}\L{\LB{\K{void}_\V{outputUserList}(\K{void})_\{}}
\L{\LB{}\Tab{8}{\V{string}_\V{output};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{ScrollOutputBuffer}();}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{chatOutput}(\S{}\3\2tcurrent_group_members:\3\SE{},_\V{GREEN});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{for}(\K{int}_\V{i}=\N{0};_\V{i}\<\V{userlist}.\V{size}();_\V{i}++)_\{}}
\L{\LB{}\Tab{16}{\V{output}_=_\S{}\3\2t\3\SE{}_+_\V{userlist}[\V{i}].\V{user};}}
\L{\LB{}\Tab{16}{\V{output}_+=_\S{}\3_(\3\SE{}_+_\V{userlist}[\V{i}].\V{ip}_+_\S{}\3)\3\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\V{chatOutput}(\V{output},_\V{GREEN});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{ScrollOutputBuffer}();}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{\C{}//_Self-explanatory\CE{}}}
\index{departGroup}\Proc{departGroup}\L{\LB{\K{void}_\V{departGroup}(\K{void})_\{}}
\L{\LB{}\Tab{8}{\K{char}}\Tab{40}{\V{buf}[\N{513}];}}
\L{\LB{}\Tab{8}{\V{string}}\Tab{40}{\V{user}_=_\V{userlist}[\N{0}].\V{user};}}
\L{\LB{}\Tab{8}{\V{DWORD}}\Tab{40}{\V{dwEvent};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{sprintf}(\V{buf},_\S{}\3\2tleft_group_\%s\3\SE{},_\V{group}.\V{c\_str}());}}
\L{\LB{}\Tab{8}{\V{chatOutput}(\V{buf},_\V{GREEN});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Send_depart_packet\CE{}}}
\L{\LB{}\Tab{8}{\V{sprintf}(\V{buf},_\S{}\3\%c\%c\%s\%c\%s\3\SE{},_\N{2},_\V{user}.\V{length}(),_\V{user}.\V{c\_str}(),_\N{0},_\V{NULL});}}
\L{\LB{}\Tab{8}{\K{if}(\V{sendto}(\V{McastSock},_\V{buf},_\V{strlen}(\V{buf}),_\N{0},}}
\L{\LB{}\Tab{16}{(\K{struct}_\V{sockaddr}_*)_\&\V{dest},_\K{sizeof}(\K{struct}_\V{sockaddr}))_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3sendto()_failed:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Wait_for_network-reception_thread_to_close\CE{}}}
\L{\LB{}\Tab{8}{\V{dwEvent}_=_\V{WaitForSingleObject}(\V{recvThread},_\V{INFINITE});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Clear_the_userlist_and_reset_the_connected_flag\CE{}}}
\L{\LB{}\Tab{8}{\V{userlist}.\V{resize}(\N{1});}}
\L{\LB{}\Tab{8}{\V{connected}_=_\N{0};}}
\L{\LB{\}}}
\L{\LB{}}
\index{getNetworkInput}\Proc{getNetworkInput}\L{\LB{\K{void}_\V{getNetworkInput}(\K{void}_*\V{\_args})_\{}}
\L{\LB{}\Tab{8}{\V{getNetworkInputArgs}_*\V{args}_=_(\V{getNetworkInputArgs}_*)\V{\_args};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{struct}_\V{ip\_mreq}}\Tab{32}{\V{McastReq};}\Tab{64}{\C{}//_multicast_group_request\CE{}}}
\L{\LB{}\Tab{8}{\K{struct}_\V{sockaddr\_in}}\Tab{32}{\V{from};}\Tab{64}{\C{}//_from_address\CE{}}}
\L{\LB{}\Tab{8}{\K{int}}\Tab{48}{\V{alen};}\Tab{80}{\C{}//_from_address_length\CE{}}}
\L{\LB{}\Tab{8}{\K{char}}\Tab{40}{\V{buf}[\N{514}];}\Tab{72}{\C{}//_word_buffer\CE{}}}
\L{\LB{}\Tab{8}{\K{int}}\Tab{48}{\V{len};}\Tab{80}{\C{}//_word_length\CE{}}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\K{char}}\Tab{24}{\V{ip}[\N{16}];}\Tab{72}{\C{}//_from_IP\CE{}}}
\L{\LB{}\Tab{8}{\K{char}}\Tab{24}{\V{user}[\N{256}];}\Tab{72}{\C{}//_user\CE{}}}
\L{\LB{}\Tab{8}{\K{char}}\Tab{24}{\V{output}[\N{256}];}\Tab{64}{\C{}//_output_string\CE{}}}
\L{\LB{}\Tab{8}{\K{short}}\Tab{24}{\V{type},_\V{length1},_\V{length2};}\Tab{56}{\C{}//_for_reception\CE{}}}
\L{\LB{}\Tab{8}{\V{WORD}}\Tab{24}{\V{color};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Loop_forever_receiving_each_word_and_displaying.\CE{}}}
\L{\LB{}\Tab{8}{\K{do}_\{}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Receive_a_word.\CE{}}}
\L{\LB{}\Tab{16}{\V{alen}_=_\K{sizeof}(\K{struct}_\V{sockaddr});}}
\L{\LB{}\Tab{16}{\K{if}((\V{len}_=_\V{recvfrom}(\V{McastSock},_\V{buf},_\K{sizeof}(\V{buf}),\N{0},}}
\L{\LB{}\Tab{24}{(\K{struct}_\V{sockaddr}_*)_\&\V{from},_\&\V{alen}))_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{24}{\V{errexit}(\S{}\3recvfrom()_failed:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_End_the_input_string\CE{}}}
\L{\LB{}\Tab{16}{\V{buf}[\V{len}]_=_\S{}{'}\20{'}\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Get_the_IP_--_there{'}s_got_to_be_a_better_way_to_do_this\CE{}}}
\L{\LB{}\Tab{16}{\V{sprintf}(\V{ip},\S{}\3\%d.\%d.\%d.\%d\3\SE{},}}
\L{\LB{}\Tab{24}{\V{from}.\V{sin\_addr}.\V{S\_un}.\V{S\_un\_b}.\V{s\_b1},}}
\L{\LB{}\Tab{24}{\V{from}.\V{sin\_addr}.\V{S\_un}.\V{S\_un\_b}.\V{s\_b2},}}
\L{\LB{}\Tab{24}{\V{from}.\V{sin\_addr}.\V{S\_un}.\V{S\_un\_b}.\V{s\_b3},}}
\L{\LB{}\Tab{24}{\V{from}.\V{sin\_addr}.\V{S\_un}.\V{S\_un\_b}.\V{s\_b4});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Grab_information_from_the_packet\CE{}}}
\L{\LB{}\Tab{16}{\V{type}_=_\V{buf}[\N{0}];}}
\L{\LB{}\Tab{16}{\V{length1}_=_\V{buf}[\N{1}];}}
\L{\LB{}\Tab{16}{\V{length2}_=_\V{buf}[\V{length1}+\N{2}];}}
\L{\LB{}\Tab{16}{\V{buf}[\V{length1}+\N{2}]_=_\S{}{'}\20{'}\SE{};}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Get_the_user\CE{}}}
\L{\LB{}\Tab{16}{\V{sprintf}(\V{user},_\S{}\3\%s\3\SE{},_\V{buf}+\N{2});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\C{}//_Add_the_user\CE{}}}
\L{\LB{}\Tab{16}{\V{addNewUser}(\V{user},_\V{ip});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}(\V{type}_==_\N{1})_\{}}
\L{\LB{}\Tab{24}{\C{}//_Enter_packet\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\V{sprintf}(\V{output},_\S{}\3\2t\%s_(\%s)_has_joined_the_group\3\SE{},_\V{user},_\V{ip});}}
\L{\LB{}\Tab{24}{\V{chatOutput}(\V{output},_\V{WHITE});}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{16}{\K{else}_\K{if}(\V{type}==\N{2})_\{}}
\L{\LB{}\Tab{24}{\C{}//_Depart_packet\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\V{sprintf}(\V{output},_\S{}\3\2t\%s_(\%s)_has_left_the_group\3\SE{},_\V{user},_\V{ip});}}
\L{\LB{}\Tab{24}{\V{chatOutput}(\V{output},_\V{WHITE});}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\C{}//_If_the_packet_is_from_the_same_program,_drop_membership\CE{}}}
\L{\LB{}\Tab{24}{\C{}//_from_the_group_and_end_the_thread\CE{}}}
\L{\LB{}\Tab{24}{\K{if}(\V{userlist}[\N{0}].\V{user}_==_\V{user}_\&\&_\V{userlist}[\N{0}].\V{ip}_==_\V{ip})_\{}}
\L{\LB{}\Tab{32}{\K{if}(_(\V{McastReq}.\V{imr\_multiaddr}.\V{s\_addr}_=_\V{inet\_addr}(\V{group}.\V{c\_str}()))}}
\L{\LB{}\Tab{40}{==_\V{INADDR\_NONE}_)}}
\L{\LB{}\Tab{40}{\V{errexit}(\S{}\3Bad_group_address:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}\Tab{32}{\V{McastReq}.\V{imr\_interface}.\V{s\_addr}_=_\V{INADDR\_ANY};}}
\L{\LB{}\Tab{32}{\K{if}(\V{setsockopt}(\V{McastSock},_\V{IPPROTO\_IP},_\V{IP\_DROP\_MEMBERSHIP},}}
\L{\LB{}\Tab{40}{(\K{char}_*)_\&\V{McastReq},_\K{sizeof}(\V{McastReq}))_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{40}{\V{errexit}(\S{}\3setsockopt_failed_for_IP\_DROP\_MEMBERSHIP:_\%d\2n\3\SE{},}}
\L{\LB{}\Tab{48}{\V{WSAGetLastError}());}}
\L{\LB{}\Tab{32}{\V{\_endthread}();}}
\L{\LB{}\Tab{24}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\C{}//_Otherwise,_erase_the_user_from_the_userlist\CE{}}}
\L{\LB{}\Tab{24}{\K{for}(\K{int}_\V{i}=\N{0};_\V{i}\<\V{userlist}.\V{size}();_\V{i}++)}}
\L{\LB{}\Tab{32}{\K{if}(\V{userlist}[\V{i}].\V{user}_==_\V{user}_\&\&_\V{userlist}[\V{i}].\V{ip}_==_\V{ip})}}
\L{\LB{}\Tab{40}{\V{userlist}.\V{erase}(\V{userlist}.\V{begin}()+\V{i});}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}\Tab{16}{\K{else}_\K{if}(\V{type}_==_\N{3})_\{}}
\L{\LB{}\Tab{24}{\C{}//_Send_packet\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{24}{\C{}//_Output_BLUE_if_the_message_is_from_the_same_program,_WHITE_otherwise\CE{}}}
\L{\LB{}\Tab{24}{\V{color}_=_(\V{userlist}[\N{0}].\V{user}_==_\V{user}_\&\&_\V{userlist}[\N{0}].\V{ip}_==_\V{ip})_?_\V{BLUE}_\V{:}_\V{WHITE}_;}}
\L{\LB{}\Tab{24}{\V{sprintf}(\V{output},_\S{}\3\%s:_\%s\3\SE{},_\V{user},_\V{buf}+\V{length1}+\N{3});_}}
\L{\LB{}\Tab{24}{\V{chatOutput}(\V{output},_\V{color});}}
\L{\LB{}\Tab{16}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\}_\K{while}(\N{1});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Never_reached.\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{return};}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{\C{}//_Adds_a_new_user_if_the_user_is_not_already\CE{}}}
\L{\LB{\C{}//_in_the_userlist\CE{}}}
\index{addNewUser}\Proc{addNewUser}\L{\LB{\K{void}_\V{addNewUser}(\K{char}_*\V{user},_\K{char}_*\V{ip})_\{}}
\L{\LB{}\Tab{8}{\V{userData}_\V{newUser};}}
\L{\LB{}\Tab{8}{\V{newUser}.\V{user}_=_\V{user};}}
\L{\LB{}\Tab{8}{\V{newUser}.\V{ip}_=_\V{ip};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{for}(\K{int}_\V{i}=\N{0};_\V{i}\<\V{userlist}.\V{size}();_\V{i}++)}}
\L{\LB{}\Tab{16}{\K{if}(\V{userlist}[\V{i}].\V{user}_==_\V{newUser}.\V{user}_\&\&_\V{userlist}[\V{i}].\V{ip}_==_\V{newUser}.\V{ip})}}
\L{\LB{}\Tab{24}{\K{return};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{userlist}.\V{push\_back}(\V{newUser});}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{\C{}//_Used_to_send_a_char*_to_a_string_argument\CE{}}}
\L{\LB{\C{}//_Is_this_necessary?\CE{}}}
\index{chatOutput}\Proc{chatOutput}\L{\LB{\K{void}_\V{chatOutput}(\K{char}_*\V{output},_\V{WORD}_\V{color})_\{}}
\L{\LB{}\Tab{8}{\V{string}_\V{temp}_=_\V{output};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{chatOutput}(\V{temp},_\V{color});}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{\C{}//_Outputs_to_the_screen\CE{}}}
\index{chatOutput}\Proc{chatOutput}\L{\LB{\K{void}_\V{chatOutput}(\V{string}_\V{output},_\V{WORD}_\V{color})_\{}}
\L{\LB{}\Tab{8}{\V{DWORD}_\V{cWritten};}}
\L{\LB{}\Tab{8}{\V{COORD}_\V{cursorPosition};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{ScrollOutputBuffer}();}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Set_the_color\CE{}}}
\L{\LB{}\Tab{4}{\K{if}_(!_\V{SetConsoleTextAttribute}(\V{hStdout},_\V{color}\|\V{FOREGROUND\_INTENSITY}))}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3SetConsoleTextAttribute()_failed\2n\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Get_and_save_the_cursor_position\CE{}}}
\L{\LB{}\Tab{4}{\K{if}_(!_\V{GetConsoleScreenBufferInfo}(\V{hStdout},_\&\V{csbiInfo}))_}}
\L{\LB{}\Tab{8}{\V{errexit}(\S{}\3GetConsoleScreenBufferInfo()_failed\2n\3\SE{});}}
\L{\LB{}\Tab{8}{\V{cursorPosition}_=_\V{csbiInfo}.\V{dwCursorPosition};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Change_the_cursor_position\CE{}}}
\L{\LB{}\Tab{8}{\V{csbiInfo}.\V{dwCursorPosition}.\V{X}_=_\N{0};}}
\L{\LB{}\Tab{8}{\V{csbiInfo}.\V{dwCursorPosition}.\V{Y}_=_\N{20};}}
\L{\LB{}\Tab{8}{\K{if}(!\V{SetConsoleCursorPosition}(\V{hStdout},\V{csbiInfo}.\V{dwCursorPosition}))}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3SetConsoleScreenBufferInfo()_failed\2n\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_The_following_should_be_protected_by_a_mutex.\,.\,.\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Write_the_output_to_screen_80_characters_at_a_time\CE{}}}
\L{\LB{}\Tab{8}{\K{while}(\V{output}.\V{length}()_\>_\N{80})_\{}}
\L{\LB{}\Tab{16}{\K{if}(!\V{WriteFile}(\V{hStdout},_\V{output}.\V{substr}(\N{0},\N{80}).\V{c\_str}(),_\N{80},_\&\V{cWritten},_\V{NULL}))}}
\L{\LB{}\Tab{24}{\V{errexit}(\S{}\3WriteFile()_failed\2n\3\SE{});}}
\L{\LB{}\Tab{16}{\V{ScrollOutputBuffer}();}}
\L{\LB{}\Tab{16}{\V{output}_=_\V{output}.\V{substr}(\N{80});}}
\L{\LB{}}
\L{\LB{}\Tab{16}{\K{if}(!\V{SetConsoleCursorPosition}(\V{hStdout},\V{csbiInfo}.\V{dwCursorPosition}))}}
\L{\LB{}\Tab{24}{\V{errexit}(\S{}\3SetConsoleScreenBufferInfo()_failed\2n\3\SE{});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{\K{if}(!\V{WriteFile}(\V{hStdout},_\V{output}.\V{c\_str}(),_\V{output}.\V{length}(),_\&\V{cWritten},_\V{NULL}))}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3WriteFile()_failed\2n\3\SE{});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Reset_the_cursor_position_and_output_color\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(!\V{SetConsoleCursorPosition}(\V{hStdout},\V{cursorPosition}))}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3SetConsoleScreenBufferInfo()_failed\2n\3\SE{});}}
\L{\LB{}\Tab{8}{\K{if}_(!_\V{SetConsoleTextAttribute}(\V{hStdout},_\V{WHITE}))}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3SetConsoleTextAttribute()_failed\2n\3\SE{});}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{\C{}//_initialize_networking\CE{}}}
\index{initNetworking}\Proc{initNetworking}\L{\LB{\K{void}_\V{initNetworking}(\K{void})_\{}}
\L{\LB{}\Tab{8}{\V{BOOL}}\Tab{40}{\V{OptValue};}\Tab{64}{\C{}//_option_value\CE{}}}
\L{\LB{}\Tab{8}{\K{struct}_\V{sockaddr\_in}}\Tab{32}{\V{source};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Create_a_standard_UDP_socket_using_socket().\CE{}}}
\L{\LB{}\Tab{8}{\K{if}((\V{McastSock}_=_\V{socket}(\V{AF\_INET},_\V{SOCK\_DGRAM},_\N{0}))_==_\V{INVALID\_SOCKET})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3socket()_failed:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Set_option_to_reuse_address_so_multiple_sockets_on_this_host_can\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_use_the_same_port_number.\CE{}}}
\L{\LB{}\Tab{8}{\V{OptValue}_=_\V{TRUE};}}
\L{\LB{}\Tab{8}{\K{if}(\V{setsockopt}(\V{McastSock},_\V{SOL\_SOCKET},_\V{SO\_REUSEADDR},_(\K{char}_*)_\&\V{OptValue},}}
\L{\LB{}\Tab{16}{\K{sizeof}(\V{OptValue}))_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3setsockopt()_failed_setting_SO\_REUSEADDR:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Some_WinSock_implementations_(including_Microsoft\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_WinSock_2.2_in_Windows_98)_will_not_set_IP-level_socket\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_options_unless_an_address_is_bound_to_the_socket.}\Tab{62}{So,\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_this_is_done_here.\CE{}}}
\L{\LB{}\Tab{8}{\V{source}.\V{sin\_family}_=_\V{AF\_INET};}}
\L{\LB{}\Tab{8}{\V{source}.\V{sin\_port}_=_\V{htons}(\V{port});}}
\L{\LB{}\Tab{8}{\V{source}.\V{sin\_addr}.\V{s\_addr}_=_\V{INADDR\_ANY};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{bind}(\V{McastSock},_(\K{struct}_\V{sockaddr}_*)_\&\V{source},_\K{sizeof}(\K{struct}_\V{sockaddr}))_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3bind()_failed:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}//_Initialize_the_screen_buffers\CE{}}}
\index{initScreen}\Proc{initScreen}\L{\LB{\K{void}_\V{initScreen}(\K{void})_\{}}
\L{\LB{}\Tab{8}{\V{hStdin}_=_\V{GetStdHandle}(\V{STD\_INPUT\_HANDLE});}}
\L{\LB{}\Tab{8}{\V{hStdout}_=_\V{GetStdHandle}(\V{STD\_OUTPUT\_HANDLE});}}
\L{\LB{}\Tab{8}{\K{if}(\V{hStdin}_==_\V{INVALID\_HANDLE\_VALUE}_\|\,\|_\V{hStdout}_==_\V{INVALID\_HANDLE\_VALUE})_\{}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3GetStdHandle()_failed\2n\3\SE{});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}\Tab{8}{}}
\L{\LB{}\Tab{8}{\V{DWORD}_\V{fdwMode},_\V{fdwOldMode};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(!\V{GetConsoleMode}(\V{hStdin},_\&\V{fdwOldMode}))_\{}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3GetConsoleMode()_failed\2n\3\SE{});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{fdwMode}_=_\V{fdwOldMode}_\&_\V{\~{}}(\V{ENABLE\_LINE\_INPUT}_\|_\V{ENABLE\_ECHO\_INPUT});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(!\V{SetConsoleMode}(\V{hStdin},_\V{fdwMode}))_\{}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3SetConsoleMode()_failed\2n\3\SE{});}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{COORD}_\V{newCoords};}}
\L{\LB{}\Tab{8}{\V{newCoords}.\V{X}_=_\N{0};}}
\L{\LB{}\Tab{8}{\V{newCoords}.\V{Y}_=_\N{21};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(!\V{SetConsoleCursorPosition}(\V{hStdout},_\V{newCoords}))_\{}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3SetConsoleCursorPosition()_failed:_\%s\2n\3\SE{},_\V{GetLastError}());}}
\L{\LB{}\Tab{8}{\}}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}//_Scroll_the_chat_upwards\CE{}}}
\index{ScrollOutputBuffer}\Proc{ScrollOutputBuffer}\L{\LB{\K{void}_\V{ScrollOutputBuffer}(\K{void})_\{}}
\L{\LB{}\Tab{4}{\V{SMALL\_RECT}_\V{srctScrollRect},_\V{srctClipRect};}}
\L{\LB{}\Tab{4}{\V{CHAR\_INFO}_\V{chiFill};}}
\L{\LB{}\Tab{4}{\V{COORD}_\V{coordDest};}}
\L{\LB{}}
\L{\LB{}\Tab{4}{\V{srctScrollRect}.\V{Left}_=_\N{0};}}
\L{\LB{}\Tab{4}{\V{srctScrollRect}.\V{Top}_=_\N{1};}}
\L{\LB{}\Tab{4}{\V{srctScrollRect}.\V{Right}_=_\V{csbiInfo}.\V{dwSize}.\V{X}_\-_\N{1};_}}
\L{\LB{}\Tab{4}{\V{srctScrollRect}.\V{Bottom}_=_\N{20};_}}
\L{\LB{_}}
\L{\LB{}\Tab{4}{\C{}//_The_destination_for_the_scroll_rectangle_is_one_row_up._\CE{}}}
\L{\LB{_}}
\L{\LB{}\Tab{4}{\V{coordDest}.\V{X}_=_\N{0};_}}
\L{\LB{}\Tab{4}{\V{coordDest}.\V{Y}_=_\N{0};_}}
\L{\LB{_}}
\L{\LB{}\Tab{4}{\C{}//_The_clipping_rectangle_is_the_same_as_the_scrolling_rectangle._\CE{}}}
\L{\LB{}\Tab{4}{\C{}//_The_destination_row_is_left_unchanged._\CE{}}}
\L{\LB{_}}
\L{\LB{}\Tab{4}{\V{srctClipRect}_=_\V{srctScrollRect};}}
\L{\LB{}\Tab{8}{\V{srctClipRect}.\V{Top}_=_\N{0};}}
\L{\LB{}\Tab{9}{}}
\L{\LB{}\Tab{4}{\C{}//_Set_the_fill_character_and_attributes._\CE{}}}
\L{\LB{_}}
\L{\LB{}\Tab{4}{\V{chiFill}.\V{Attributes}_=_\V{FOREGROUND\_RED}\|\V{FOREGROUND\_INTENSITY};_}}
\L{\LB{}\Tab{4}{\V{chiFill}.\V{Char}.\V{AsciiChar}_=_(\K{char})\S{}{'}_{'}\SE{};_}}
\L{\LB{_}}
\L{\LB{}\Tab{4}{\C{}//_Scroll_up_one_line._\CE{}}}
\L{\LB{_}}
\L{\LB{}\Tab{4}{\V{ScrollConsoleScreenBuffer}(_}}
\L{\LB{}\Tab{8}{\V{hStdout},}\Tab{25}{\C{}//_screen_buffer_handle_\CE{}}}
\L{\LB{}\Tab{8}{\&\V{srctScrollRect},_\C{}//_scrolling_rectangle_\CE{}}}
\L{\LB{}\Tab{8}{\&\V{srctClipRect},}\Tab{25}{\C{}//_clipping_rectangle_\CE{}}}
\L{\LB{}\Tab{8}{\V{coordDest},}\Tab{25}{\C{}//_top_left_destination_cell_\CE{}}}
\L{\LB{}\Tab{8}{\&\V{chiFill});}\Tab{25}{\C{}//_fill_character_and_color_\CE{}}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}//_Join_a_multicast_group\CE{}}}
\index{joinGroup}\Proc{joinGroup}\L{\LB{\K{void}_\V{joinGroup}(\K{void})_\{}}
\L{\LB{}\Tab{8}{\K{struct}_\V{ip\_mreq}}\Tab{32}{\V{McastReq};}\Tab{56}{\C{}//_multicast_group_request\CE{}}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Join_the_multicast_group_from_we_want_to_receive_datagrams.\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_Initialize_the_multicast_request_structure_and_then_pass\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_it_as_an_option_to_setsockopt().}\Tab{45}{The_imr\_multiaddr_element\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_is_initialized_to_the_desired_multicast_group.}\Tab{59}{The\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_imr\_interface_element_is_initilized_to_IPADDR\_ANY_which\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_causes_the_multcast_receives_to_come_from_the_default\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_interface.\CE{}}}
\L{\LB{}\Tab{8}{\K{if}(_(\V{McastReq}.\V{imr\_multiaddr}.\V{s\_addr}_=_\V{inet\_addr}(\V{group}.\V{c\_str}()))_==_\V{INADDR\_NONE}_)}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3Bad_group_address:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{McastReq}.\V{imr\_interface}.\V{s\_addr}_=_\V{INADDR\_ANY};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{setsockopt}(\V{McastSock},_\V{IPPROTO\_IP},_\V{IP\_ADD\_MEMBERSHIP},_(\K{char}_*)_\&\V{McastReq},}}
\L{\LB{}\Tab{16}{\K{sizeof}(\V{McastReq}))_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3setsockopt_failed_for_IP\_ADD\_MEMBERSHIP:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{if}(\V{setsockopt}(\V{McastSock},_\V{IPPROTO\_IP},_\V{IP\_MULTICAST\_TTL},_(\K{char}_*)_\&\V{ttl},}}
\L{\LB{}\Tab{16}{\K{sizeof}(\V{ttl}))_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3setsockopt()_failed_setting_IP\_MULTICAST\_TTL:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\C{}//_Initialize_the_destination_address_structure.}\Tab{58}{The_destination\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_IP_address_is_a_group_(class_D)_address.}\Tab{53}{Port_number_must_match\CE{}}}
\L{\LB{}\Tab{8}{\C{}//_port_used_by_receivers.}\Tab{40}{\CE{}}}
\L{\LB{}\Tab{8}{\V{dest}.\V{sin\_family}_=_\V{AF\_INET};}}
\L{\LB{}\Tab{8}{\V{dest}.\V{sin\_port}_=_\V{htons}(\V{port});}}
\L{\LB{}\Tab{8}{\K{if}((\V{dest}.\V{sin\_addr}.\V{s\_addr}_=_\V{inet\_addr}(\V{group}.\V{c\_str}()))_==_\V{INADDR\_NONE})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3Bad_group_address_\%s:_\%\2n\3\SE{},_\V{group},_\V{WSAGetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\K{char}_\V{temp}[\N{255}];}\Tab{24}{}}
\L{\LB{}\Tab{8}{\V{sprintf}(\V{temp},_\S{}\3\2tjoined_group_\%s_on_port_\%d_with_ttl_\%d\3\SE{},_\V{group}.\V{c\_str}(),_\V{port},_\V{ttl});}}
\L{\LB{}\Tab{8}{\V{chatOutput}(\V{temp},_\V{GREEN});}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{recvThread}_=_(\V{HANDLE})_\V{\_beginthread}((\K{void}_(*)(\K{void}_*))\V{getNetworkInput},_\N{0},_(\K{void}_*)\V{NULL});}}
\L{\LB{}\Tab{8}{\K{if}(\V{recvThread}_\<_\N{0})}}
\L{\LB{}\Tab{16}{\V{errexit}(\S{}\3\_beginthread()_failed:_\%s\2n\3\SE{},_\V{strerror}(\V{errno}));}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{string}_\V{user}_=_\V{userlist}[\N{0}].\V{user};}}
\L{\LB{}\Tab{8}{\K{char}_\V{buf}[\N{514}];}}
\L{\LB{}\Tab{8}{\V{sprintf}(\V{buf},_\S{}\3\%c\%c\%s\%c\%s\3\SE{},_\N{1},_\V{user}.\V{length}(),_\V{user}.\V{c\_str}());}}
\L{\LB{}\Tab{8}{\K{if}(\V{sendto}(\V{McastSock},_\V{buf},_\V{strlen}(\V{buf}),_\N{0},}}
\L{\LB{}\Tab{24}{(\K{struct}_\V{sockaddr}_*)_\&\V{dest},_\K{sizeof}(\K{struct}_\V{sockaddr}))_==_\V{SOCKET\_ERROR})}}
\L{\LB{}\Tab{24}{\V{errexit}(\S{}\3sendto()_failed:_\%d\2n\3\SE{},_\V{WSAGetLastError}());}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{connected}_=_\N{1};}}
\L{\LB{\}}}
\L{\LB{}}
\L{\LB{}}
\L{\LB{\C{}//_Procedure_errexit().}\Tab{25}{From_Comer_and_Stevens,_Vol._III_(WinSock_edition)\CE{}}}
\index{errexit}\Proc{errexit}\L{\LB{\K{void}_\V{errexit}(\K{const}_\K{char}_*\V{format},_.\,.\,.)}}
\L{\LB{\{}}
\L{\LB{}\Tab{8}{\V{va\_list}}\Tab{16}{\V{args};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{va\_start}(\V{args},_\V{format});}}
\L{\LB{}\Tab{8}{\V{vfprintf}(\V{stderr},_\V{format},_\V{args});}}
\L{\LB{}\Tab{8}{\V{va\_end}(\V{args});}}
\L{\LB{}\Tab{8}{\V{WSACleanup}();}}
\L{\LB{}\Tab{8}{\V{exit}(\N{1});}}
\L{\LB{}}
\L{\LB{\}_\C{}//_end_errexit().\CE{}}}
